"use strict";
/**
 * @license Copyright (c) 2003-2015, CKSource - Frederico Knabben. All rights reserved.
 * For licensing, see LICENSE.md or http://ckeditor.com/license
 */
(function(){function r(n){this.editor=n;this.registered={};this.instances={};this.selected=[];this.focused=null;this.widgetHoldingFocusedEditable=null;this._={nextId:0,upcasts:[],upcastCallbacks:[],filters:{}};wt(this);pt(this);at(this);vt(this);lt(this);yt(this)}function n(t,i,r,u,f){var e=t.editor;CKEDITOR.tools.extend(this,u,{editor:e,id:i,inline:r.getParent().getName()=="span",element:r,data:CKEDITOR.tools.extend({},typeof u.defaults=="function"?u.defaults():u.defaults),dataReady:!1,inited:!1,ready:!1,edit:n.prototype.edit,focusedEditable:null,definition:u,repository:t,draggable:u.draggable!==!1,_:{downcastFn:u.downcast&&typeof u.downcast=="string"?u.downcasts[u.downcast]:u.downcast}},!0);t.fire("instanceCreated",this);fi(this,u);this.init&&this.init();this.inited=!0;ei(this,f);this.isInited()&&e.editable().contains(this.wrapper)&&(this.ready=!0,this.fire("ready"))}function u(n,t,i){CKEDITOR.dom.element.call(this,t.$);this.editor=n;this._={};var r=this.filter=i.filter;CKEDITOR.dtd[this.getName()].p?(this.enterMode=r?r.getAllowedEnterMode(n.enterMode):n.enterMode,this.shiftEnterMode=r?r.getAllowedEnterMode(n.shiftEnterMode,!0):n.shiftEnterMode):this.enterMode=this.shiftEnterMode=CKEDITOR.ENTER_BR}function g(n){var r=n.widgets.registered,t,u,i;for(u in r)t=r[u],i=t.button,i&&n.ui.addButton&&n.ui.addButton(CKEDITOR.tools.capitalize(t.name,!0),{label:i,command:t.name,toolbar:"insert,10"})}function nt(n,t){n.addCommand(t.name,{exec:function(n,i){function f(){n.widgets.finalizeCreation(s)}var u=n.widgets.focused,h;if(u&&u.name==t.name)u.edit();else if(t.insert)t.insert();else if(t.template){var c=typeof t.defaults=="function"?t.defaults():t.defaults,e=CKEDITOR.dom.element.createFromHtml(t.template.output(c)),r,o=n.widgets.wrapElement(e,t.name),s=new CKEDITOR.dom.documentFragment(o.getDocument());if(s.append(o),r=n.widgets.initOn(e,t,i&&i.startupData),!r){f();return}h=r.once("edit",function(t){if(t.data.dialog)r.once("dialog",function(t){var i=t.data,u,e;u=i.once("ok",f,null,null,20);e=i.once("cancel",function(t){t.data&&t.data.hide===!1||n.widgets.destroy(r,!0)});i.once("hide",function(){u.removeListener();e.removeListener()})});else f()},null,null,999);r.edit();h.removeListener()}},allowedContent:t.allowedContent,requiredContent:t.requiredContent,contentForms:t.contentForms,contentTransformations:t.contentTransformations})}function tt(n,t){function f(t,i,r){var u=CKEDITOR.tools.getIndex(n._.upcasts,function(n){return n[2]>r});u<0&&(u=n._.upcasts.length);n._.upcasts.splice(u,0,[t,i,r])}var i=t.upcast,r,u=t.upcastPriority||10;if(i)if(typeof i=="string")for(r=i.split(",");r.length;)f(t.upcasts[r.pop()],t.name,u);else f(i,t.name,u)}function f(n,t){if(n.focused=null,t.isInited()){var i=t.editor.checkDirty();n.fire("widgetBlurred",{widget:t});t.setFocused(!1);i||t.editor.resetDirty()}}function it(t){var o=t.data,u,f,e,i,h,r,c,s;if(this.editor.mode=="wysiwyg"&&(u=this.editor.editable(),f=this.instances,u)){for(i in f)f[i].isReady()&&!u.contains(f[i].wrapper)&&this.destroy(f[i],!0);if(o&&o.initOnlyNew)e=this.initOnAll();else for(s=u.find(".cke_widget_wrapper"),e=[],i=0,h=s.count();i<h;i++)r=s.getItem(i),c=!this.getByElement(r,!0),c&&!et(r,ot)&&u.contains(r)&&(r.addClass("cke_widget_new"),e.push(this.initOn(r.getFirst(n.isDomWidgetElement))));o&&o.focusInited&&e.length==1&&e[0].focus()}}function rt(n){var t=n.parent;t.type==CKEDITOR.NODE_ELEMENT&&t.attributes["data-cke-widget-wrapper"]&&t.replaceWith(n)}function ut(t,i){for(var e=i.find(".cke_widget_wrapper"),u,r,f=0,o=e.count();f<o;++f)u=e.getItem(f),r=u.getFirst(n.isDomWidgetElement),r.type==CKEDITOR.NODE_ELEMENT&&r.data("widget")?(r.replace(u),t.wrapElement(r)):u.remove()}function e(n,t,i){var r,u;return i.allowedContent?(r=this._.filters[n],r||(this._.filters[n]=r={}),u=r[t],u||(r[t]=u=new CKEDITOR.filter(i.allowedContent)),u):null}function ft(t){var i=[],r=t._.upcasts,u=t._.upcastCallbacks;return{toBeWrapped:i,iterator:function(t){var e,o,s,f,h,c;if("data-cke-widget-wrapper"in t.attributes)return t=t.getFirst(n.isParserWidgetElement),t&&i.push([t]),!1;if("data-widget"in t.attributes)return i.push([t]),!1;if(h=r.length){if(t.attributes["data-cke-widget-upcasted"])return!1;for(f=0,c=u.length;f<c;++f)if(u[f](t)===!1)return;for(f=0;f<h;++f)if(e=r[f],s={},o=e[0](t,s))return o instanceof CKEDITOR.htmlParser.element&&(t=o),t.attributes["data-cke-widget-data"]=encodeURIComponent(JSON.stringify(s)),t.attributes["data-cke-widget-upcasted"]=1,i.push([t,e[1]]),!1}}}}function et(n,t){for(var i=n;i=i.getParent();)if(t(i))return!0;return!1}function o(n){return{tabindex:-1,contenteditable:"false","data-cke-widget-wrapper":1,"data-cke-filter":"off","class":"cke_widget_wrapper cke_widget_new cke_widget_"+(n?"inline":"block")}}function s(n,t,i){var u,r,f;if(n.type==CKEDITOR.NODE_ELEMENT&&(u=CKEDITOR.dtd[n.name],u&&!u[i.name]))return r=n.split(t),f=n.parent,t=r.getIndex(),n.children.length||(t-=1,n.remove()),r.children.length||r.remove(),s(f,t,i);n.add(i,t)}function h(n,t){return typeof n.inline=="boolean"?n.inline:!!CKEDITOR.dtd.$inline[t]}function ot(n){return n.hasAttribute("data-cke-temp")}function st(n,t){var r=n.focusedEditable,i,u,f;return t==CKEDITOR.CTRL+65?(u=r.getBogus(),i=n.editor.createRange(),i.selectNodeContents(r),u&&i.setEndAt(u,CKEDITOR.POSITION_BEFORE_START),i.select(),!1):t==8||t==46?(f=n.editor.getSelection().getRanges(),i=f[0],!(f.length==1&&i.collapsed&&i.checkBoundaryOfElement(r,CKEDITOR[t==8?"START":"END"]))):void 0}function i(n,t,i,r){var u=n.editor,e,f;u.fire("lockSnapshot");i?(e=i.data("cke-widget-editable"),f=t.editables[e],n.widgetHoldingFocusedEditable=t,t.focusedEditable=f,i.addClass("cke_widget_editable_focused"),f.filter&&u.setActiveFilter(f.filter),u.setActiveEnterMode(f.enterMode,f.shiftEnterMode)):(r||t.focusedEditable.removeClass("cke_widget_editable_focused"),t.focusedEditable=null,n.widgetHoldingFocusedEditable=null,u.setActiveFilter(null),u.setActiveEnterMode(null,null));u.fire("unlockSnapshot")}function ht(n){n.contextMenu&&n.contextMenu.addListener(function(t){var i=n.widgets.getByElement(t,!0);if(i)return i.fire("contextMenu",{})})}function ct(n,t){return CKEDITOR.tools.trim(t)}function lt(t){var i=t.editor,r=CKEDITOR.plugins.lineutils;i.on("dragstart",function(r){var f=r.data.target,u;n.isDomDragHandler(f)&&(u=t.getByElement(f),r.data.dataTransfer.setData("cke/widget-id",u.id),i.focus(),u.focus())});i.on("drop",function(n){var f=n.data.dataTransfer,e=f.getData("cke/widget-id"),u=i.createRange(),r;e!==""&&f.getTransferType(i)==CKEDITOR.DATA_TRANSFER_INTERNAL&&(r=t.instances[e],r)&&(u.setStartBefore(r.wrapper),u.setEndAfter(r.wrapper),n.data.dragRange=u,delete CKEDITOR.plugins.clipboard.dragStartContainerChildCount,delete CKEDITOR.plugins.clipboard.dragEndContainerChildCount,n.data.dataTransfer.setData("text/html",i.editable().getHtmlFromRange(u).getHtml()),i.widgets.destroy(r,!0))});i.on("contentDom",function(){var u=i.editable();CKEDITOR.tools.extend(t,{finder:new r.finder(i,{lookups:{"default":function(i){var r,f,e,o;if(!i.is(CKEDITOR.dtd.$listItem)&&i.is(CKEDITOR.dtd.$block)&&!n.isDomNestedEditable(i)&&!t._.draggedWidget.wrapper.contains(i)){if(r=n.getNestedEditable(u,i),r){if(f=t._.draggedWidget,t.getByElement(r)==f)return;if(e=CKEDITOR.filter.instances[r.data("cke-filter")],o=f.requiredContent,e&&o&&!e.check(o))return}return CKEDITOR.LINEUTILS_BEFORE|CKEDITOR.LINEUTILS_AFTER}}}}),locator:new r.locator(i),liner:new r.liner(i,{lineStyle:{cursor:"move !important","border-top-color":"#666"},tipLeftStyle:{"border-left-color":"#666"},tipRightStyle:{"border-right-color":"#666"}})},!0)})}function at(t){var i=t.editor;i.on("contentDom",function(){var u=i.editable(),e=u.isInline()?u:i.document,r,f;u.attachListener(e,"mousedown",function(i){var u=i.data.getTarget();if(!u.type)return!1;if(r=t.getByElement(u),f=0,r){if(r.inline&&u.type==CKEDITOR.NODE_ELEMENT&&u.hasAttribute("data-cke-widget-drag-handler")){f=1;return}n.getNestedEditable(r.wrapper,u)?r=null:(i.data.preventDefault(),CKEDITOR.env.ie||r.focus())}});u.attachListener(e,"mouseup",function(){f&&r&&r.wrapper&&(f=0,r.focus())});CKEDITOR.env.ie&&u.attachListener(e,"mouseup",function(){setTimeout(function(){r&&r.wrapper&&u.contains(r.wrapper)&&(r.focus(),r=null)})})});i.on("doubleclick",function(i){var r=t.getByElement(i.data.element);if(r&&!n.getNestedEditable(r.wrapper,i.data.element))return r.fire("doubleclick",{element:i.data.element})},null,null,1)}function vt(n){var t=n.editor;t.on("key",function(t){var r=n.focused,u=n.widgetHoldingFocusedEditable,i;return r?i=r.fire("key",{keyCode:t.data.keyCode}):u&&(i=st(u,t.data.keyCode)),i},null,null,1)}function yt(n){function i(t){n.focused&&p(n.focused,t.name=="cut")}var t=n.editor;t.on("contentDom",function(){var n=t.editable();n.attachListener(n,"copy",i);n.attachListener(n,"cut",i)})}function pt(t){var r=t.editor;r.on("selectionCheck",function(){t.fire("checkSelection")});t.on("checkSelection",t.checkSelection,t);r.on("selectionChange",function(u){var f=n.getNestedEditable(r.editable(),u.data.selection.getStartElement()),e=f&&t.getByElement(f),o=t.widgetHoldingFocusedEditable;o?o===e&&o.focusedEditable.equals(f)||(i(t,o,null),e&&f&&i(t,e,f)):e&&f&&i(t,e,f)});r.on("dataReady",function(){l(t).commit()});r.on("blur",function(){var n;(n=t.focused)&&f(t,n);(n=t.widgetHoldingFocusedEditable)&&i(t,n,null)})}function wt(n){kt(n);bt(n);n.on("checkWidgets",it);n.editor.on("contentDomInvalidated",n.checkWidgets,n)}function bt(t){var i=t.editor,r={};i.on("toDataFormat",function(i){var f=CKEDITOR.tools.getNextNumber(),u=[];i.data.downcastingSessionId=f;r[f]=u;i.data.dataValue.forEach(function(i){var r=i.attributes,e,f;if("data-cke-widget-id"in r)e=t.instances[r["data-cke-widget-id"]],e&&(f=i.getFirst(n.isParserWidgetElement),u.push({wrapper:i,element:f,widget:e,editables:{}}),f.attributes["data-cke-widget-keep-attr"]!="1"&&delete f.attributes["data-widget"]);else if("data-cke-widget-editable"in r)return u[u.length-1].editables[r["data-cke-widget-editable"]]=i,!1},CKEDITOR.NODE_ELEMENT,!0)},null,null,8);i.on("toDataFormat",function(n){if(n.data.downcastingSessionId)for(var s=r[n.data.downcastingSessionId],t,i,f,u,e,o;t=s.shift();){i=t.widget;f=t.element;u=i._.downcastFn&&i._.downcastFn.call(i,f);for(o in t.editables)e=t.editables[o],delete e.attributes.contenteditable,e.setHtml(i.editables[o].getData());u||(u=f);t.wrapper.replaceWith(u)}},null,null,13);i.on("contentDomUnload",function(){t.destroyAll(!0)})}function kt(t){var i=t.editor,r,u;i.on("toHtml",function(i){var f=ft(t),u;for(i.data.dataValue.forEach(f.iterator,CKEDITOR.NODE_ELEMENT,!0);u=f.toBeWrapped.pop();)rt(u[0]),t.wrapElement(u[0],u[1]);r=i.data.protectedWhitespaces?i.data.dataValue.children.length==3&&n.isParserWidgetWrapper(i.data.dataValue.children[1]):i.data.dataValue.children.length==1&&n.isParserWidgetWrapper(i.data.dataValue.children[0])},null,null,8);i.on("dataReady",function(){u&&ut(t,i.editable());u=0;t.destroyAll(!0);t.initOnAll()});i.on("loadSnapshot",function(n){/data-cke-widget/.test(n.data)&&(u=1);t.destroyAll(!0)},null,null,9);i.on("paste",function(t){var r=t.data,u,f;r.dataValue=r.dataValue.replace(c,ct);r.range&&(u=n.getNestedEditable(i.editable(),r.range.startContainer),u&&(f=CKEDITOR.filter.instances[u.data("cke-filter")],f&&i.setActiveFilter(f)))});i.on("afterInsertHtml",function(n){n.data.intoRange?t.checkWidgets({initOnlyNew:!0}):(i.fire("lockSnapshot"),t.checkWidgets({initOnlyNew:!0,focusInited:r}),i.fire("unlockSnapshot"))})}function l(n){var i=n.selected,u=[],r=i.slice(0),t=null;return{select:function(n){CKEDITOR.tools.indexOf(i,n)<0&&u.push(n);var t=CKEDITOR.tools.indexOf(r,n);return t>=0&&r.splice(t,1),this},focus:function(n){return t=n,this},commit:function(){var s=n.focused!==t,e,o;for(n.editor.fire("lockSnapshot"),s&&(e=n.focused)&&f(n,e);e=r.pop();)i.splice(CKEDITOR.tools.indexOf(i,e),1),e.isInited()&&(o=e.editor.checkDirty(),e.setSelected(!1),o||e.editor.resetDirty());for(s&&t&&(o=n.editor.checkDirty(),n.focused=t,n.fire("widgetFocused",{widget:t}),t.setFocused(!0),o||n.editor.resetDirty());e=u.pop();)i.push(e),e.setSelected(!0);n.editor.fire("unlockSnapshot")}}}function v(n,t,i){var f=0,e=w(t),r=n.data.classes||{},u;if(e){for(r=CKEDITOR.tools.clone(r);u=e.pop();)i?r[u]||(f=r[u]=1):r[u]&&(delete r[u],f=1);f&&n.setData("classes",r)}}function y(n){n.cancel()}function p(n,t){var i=n.editor,f=i.document,r,c,l,o,a;if(!f.getById("cke_copybin")){var s=i.blockless||CKEDITOR.env.ie?"span":"div",u=f.createElement(s),e=f.createElement(s),h=CKEDITOR.env.ie&&CKEDITOR.env.version<9;e.setAttributes({id:"cke_copybin","data-cke-temp":"1"});u.setStyles({position:"absolute",width:"1px",height:"1px",overflow:"hidden"});u.setStyle(i.config.contentsLangDirection=="ltr"?"left":"right","-5000px");r=i.createRange();r.setStartBefore(n.wrapper);r.setEndAfter(n.wrapper);u.setHtml('<span data-cke-copybin-start="1">​<\/span>'+i.editable().getHtmlFromRange(r).getHtml()+'<span data-cke-copybin-end="1">​<\/span>');i.fire("saveSnapshot");i.fire("lockSnapshot");e.append(u);i.editable().append(e);c=i.on("selectionChange",y,null,null,0);l=n.repository.on("checkSelection",y,null,null,0);h&&(o=f.getDocumentElement().$,a=o.scrollTop);r=i.createRange();r.selectNodeContents(u);r.select();h&&(o.scrollTop=a);setTimeout(function(){t||n.focus();e.remove();c.removeListener();l.removeListener();i.fire("unlockSnapshot");t&&(n.repository.del(n),i.fire("saveSnapshot"))},100)}}function w(n){var t=n.getDefinition().attributes,i=t&&t["class"];return i?i.split(/\s+/):null}function b(){var i=CKEDITOR.document.getActive(),n=this.editor,t=n.editable();(t.isInline()?t:n.document.getWindow().getFrame()).equals(i)&&n.focusManager.focus(t)}function k(){CKEDITOR.env.gecko&&this.editor.unlockSelection();CKEDITOR.env.webkit||(this.editor.forceNextSelectionCheck(),this.editor.selectionChange(1))}function dt(n){var t=null;n.on("data",function(){var n=this.data.classes,i;if(t!=n){for(i in t)n&&n[i]||this.removeClass(i);for(i in n)this.addClass(i);t=n}})}function gt(i){if(i.draggable){var f=i.editor,r=i.wrapper.getLast(n.isDomDragHandlerContainer),u;r?u=r.findOne("img"):(r=new CKEDITOR.dom.element("span",f.document),r.setAttributes({"class":"cke_reset cke_widget_drag_handler_container",style:"background:rgba(220,220,220,0.5);background-image:url("+f.plugins.widget.path+"images/handle.png)"}),u=new CKEDITOR.dom.element("img",f.document),u.setAttributes({"class":"cke_reset cke_widget_drag_handler","data-cke-widget-drag-handler":"1",src:CKEDITOR.tools.transparentImageData,width:t,title:f.lang.widget.move,height:t}),i.inline&&u.setAttribute("draggable","true"),r.append(u),i.wrapper.append(r));i.wrapper.on("dragover",function(n){n.data.preventDefault()});i.wrapper.on("mouseenter",i.updateDragHandlerPosition,i);if(setTimeout(function(){i.on("data",i.updateDragHandlerPosition,i)},50),!i.inline){u.on("mousedown",ni,i);if(CKEDITOR.env.ie&&CKEDITOR.env.version<9)u.on("dragstart",function(n){n.data.preventDefault(!0)})}i.dragHandlerContainer=r}}function ni(n){function l(){var r;for(o.reset();r=t.pop();)r.removeListener();ti.call(this,i,n.sender)}var a=this.repository.finder,s=this.repository.locator,r=this.repository.liner,u=this.editor,f=u.editable(),t=[],i=[],e,o,h,c;this.repository._.draggedWidget=this;e=a.greedySearch();o=CKEDITOR.tools.eventsBuffer(50,function(){h=s.locate(e);i=s.sort(c,1);i.length&&(r.prepare(e,h),r.placeLine(i[0]),r.cleanup())});f.addClass("cke_widget_dragging");t.push(f.on("mousemove",function(n){c=n.data.$.clientY;o.input()}));u.fire("dragstart",{target:n.sender});t.push(u.document.once("mouseup",l,this));f.isInline()||t.push(CKEDITOR.document.once("mouseup",l,this))}function ti(n,t){var f=this.repository.finder,r=this.repository.liner,u=this.editor,e=this.editor.editable(),i;CKEDITOR.tools.isEmpty(r.visible)||(i=f.getRange(n[0]),this.focus(),u.fire("drop",{dropRange:i,target:i.startContainer}));e.removeClass("cke_widget_dragging");r.hideVisible();u.fire("dragend",{target:t})}function ii(n){var i,t,r=n.editables;if(n.editables={},n.editables)for(i in r)t=r[i],n.initEditable(i,typeof t=="string"?{selector:t}:t)}function ri(n){if(n.mask){var t=n.wrapper.findOne(".cke_widget_mask");t||(t=new CKEDITOR.dom.element("img",n.editor.document),t.setAttributes({src:CKEDITOR.tools.transparentImageData,"class":"cke_reset cke_widget_mask"}),n.wrapper.append(t));n.mask=t}}function ui(n){if(n.parts){var t={},i;for(var r in n.parts)i=n.wrapper.findOne(n.parts[r]),t[r]=i;n.parts=t}}function fi(t,i){if(oi(t),ui(t),ii(t),ri(t),gt(t),dt(t),CKEDITOR.env.ie&&CKEDITOR.env.version<9)t.wrapper.on("dragstart",function(i){var r=i.data.getTarget();n.getNestedEditable(t,r)||t.inline&&n.isDomDragHandler(r)||i.data.preventDefault()});t.wrapper.removeClass("cke_widget_new");t.element.addClass("cke_widget_element");t.on("key",function(n){var i=n.data.keyCode;if(i==13)t.edit();else{if(i==CKEDITOR.CTRL+67||i==CKEDITOR.CTRL+88){p(t,i==CKEDITOR.CTRL+88);return}if(i in a||CKEDITOR.CTRL&i||CKEDITOR.ALT&i)return}return!1},null,null,999);t.on("doubleclick",function(n){t.edit()&&n.cancel()});if(i.data)t.on("data",i.data);if(i.edit)t.on("edit",i.edit)}function ei(n,t){var i=n.element.data("cke-widget-data");i&&n.setData(JSON.parse(decodeURIComponent(i)));t&&n.setData(t);n.data.classes||n.setData("classes",n.getClasses());n.dataReady=!0;d(n);n.fire("data",n.data)}function oi(n){var t=n.wrapper=n.element.getParent();t.setAttribute("data-cke-widget-id",n.id)}function d(n){n.element.data("cke-widget-data",encodeURIComponent(JSON.stringify(n.data)))}var t=15,c,a;CKEDITOR.plugins.add("widget",{lang:"af,ar,bg,ca,cs,cy,da,de,el,en,en-gb,eo,es,fa,fi,fr,gl,he,hr,hu,it,ja,km,ko,ku,lv,nb,nl,no,pl,pt,pt-br,ru,sk,sl,sq,sv,tr,tt,uk,vi,zh,zh-cn",requires:"lineutils,clipboard",onLoad:function(){CKEDITOR.addCss(".cke_widget_wrapper{position:relative;outline:none}.cke_widget_inline{display:inline-block}.cke_widget_wrapper:hover>.cke_widget_element{outline:2px solid yellow;cursor:default}.cke_widget_wrapper:hover .cke_widget_editable{outline:2px solid yellow}.cke_widget_wrapper.cke_widget_focused>.cke_widget_element,.cke_widget_wrapper .cke_widget_editable.cke_widget_editable_focused{outline:2px solid #ace}.cke_widget_editable{cursor:text}.cke_widget_drag_handler_container{position:absolute;width:"+t+"px;height:0;display:none;opacity:0.75;transition:height 0s 0.2s;line-height:0}.cke_widget_wrapper:hover>.cke_widget_drag_handler_container{height:"+t+"px;transition:none}.cke_widget_drag_handler_container:hover{opacity:1}img.cke_widget_drag_handler{cursor:move;width:"+t+"px;height:"+t+"px;display:inline-block}.cke_widget_mask{position:absolute;top:0;left:0;width:100%;height:100%;display:block}.cke_editable.cke_widget_dragging, .cke_editable.cke_widget_dragging *{cursor:move !important}")},beforeInit:function(n){n.widgets=new r(n)},afterInit:function(n){g(n);ht(n)}});r.prototype={MIN_SELECTION_CHECK_INTERVAL:500,add:function(n,t){return t=CKEDITOR.tools.prototypedCopy(t),t.name=n,t._=t._||{},this.editor.fire("widgetDefinition",t),t.template&&(t.template=new CKEDITOR.template(t.template)),nt(this.editor,t),tt(this,t),this.registered[n]=t,t},addUpcastCallback:function(n){this._.upcastCallbacks.push(n)},checkSelection:function(){var f=this.editor.getSelection(),e=f.getSelectedElement(),t=l(this),r,i,u,o;if(e&&(r=this.getByElement(e,!0)))return t.focus(r).select(r).commit();if(i=f.getRanges()[0],!i||i.collapsed)return t.commit();for(u=new CKEDITOR.dom.walker(i),u.evaluator=n.isDomWidgetWrapper;o=u.next();)t.select(this.getByElement(o));t.commit()},checkWidgets:function(n){this.fire("checkWidgets",CKEDITOR.tools.copy(n||{}))},del:function(n){if(this.focused===n){var r=n.editor,t=r.createRange(),i;(i=t.moveToClosestEditablePosition(n.wrapper,!0))||(i=t.moveToClosestEditablePosition(n.wrapper,!1));i&&r.getSelection().selectRanges([t])}n.wrapper.remove();this.destroy(n,!0)},destroy:function(n,t){this.widgetHoldingFocusedEditable===n&&i(this,n,null,t);n.destroy(t);delete this.instances[n.id];this.fire("instanceDestroyed",n)},destroyAll:function(n,t){var i,u,f=this.instances;if(t&&!n){for(var e=t.find(".cke_widget_wrapper"),o=e.count(),r=0;r<o;++r)i=this.getByElement(e.getItem(r),!0),i&&this.destroy(i);return}for(u in f)i=f[u],this.destroy(i,n)},finalizeCreation:function(t){var i=t.getFirst(),r;i&&n.isDomWidgetWrapper(i)&&(this.editor.insertElement(i),r=this.getByElement(i),r.ready=!0,r.fire("ready"),r.focus())},getByElement:function(){function n(n){return n.is(t)&&n.data("cke-widget-id")}var t={div:1,span:1};return function(t,i){var r,u;if(!t)return null;if(r=n(t),!i&&!r){u=this.editor.editable();do t=t.getParent();while(t&&!t.equals(u)&&!(r=n(t)))}return this.instances[r]||null}}(),initOn:function(t,i,r){var f,u;return(i?typeof i=="string"&&(i=this.registered[i]):i=this.registered[t.data("widget")],!i)?null:(f=this.wrapElement(t,i.name),f)?f.hasClass("cke_widget_new")?(u=new n(this,this._.nextId++,t,i,r),u.isInited()?(this.instances[u.id]=u,u):null):this.getByElement(t):null},initOnAll:function(t){for(var r=(t||this.editor.editable()).find(".cke_widget_new"),u=[],i,f=r.count();f--;)i=this.initOn(r.getItem(f).getFirst(n.isDomWidgetElement)),i&&u.push(i);return u},onWidget:function(n){var i=Array.prototype.slice.call(arguments),r,t;i.shift();for(r in this.instances)t=this.instances[r],t.name==n&&t.on.apply(t,i);this.on("instanceCreated",function(t){var r=t.data;r.name==n&&r.on.apply(r,i)})},parseElementClasses:function(n){if(!n)return null;n=CKEDITOR.tools.trim(n).split(/\s+/);for(var t,i={},r=0;t=n.pop();)t.indexOf("cke_")==-1&&(i[t]=r=1);return r?i:null},wrapElement:function(n,t){var i=null,r,u,f,e;if(n instanceof CKEDITOR.dom.element){if(r=this.registered[t||n.data("widget")],!r)return null;if(i=n.getParent(),i&&i.type==CKEDITOR.NODE_ELEMENT&&i.data("cke-widget-wrapper"))return i;n.hasAttribute("data-cke-widget-keep-attr")||n.data("cke-widget-keep-attr",n.data("widget")?1:0);t&&n.data("widget",t);u=h(r,n.getName());i=new CKEDITOR.dom.element(u?"span":"div");i.setAttributes(o(u));i.data("cke-display-name",r.pathName?r.pathName:n.getName());n.getParent(!0)&&i.replace(n);n.appendTo(i)}else if(n instanceof CKEDITOR.htmlParser.element){if(r=this.registered[t||n.attributes["data-widget"]],!r)return null;if(i=n.parent,i&&i.type==CKEDITOR.NODE_ELEMENT&&i.attributes["data-cke-widget-wrapper"])return i;"data-cke-widget-keep-attr"in n.attributes||(n.attributes["data-cke-widget-keep-attr"]=n.attributes["data-widget"]?1:0);t&&(n.attributes["data-widget"]=t);u=h(r,n.name);i=new CKEDITOR.htmlParser.element(u?"span":"div",o(u));i.attributes["data-cke-display-name"]=r.pathName?r.pathName:n.name;f=n.parent;f&&(e=n.getIndex(),n.remove());i.add(n);f&&s(f,e,i)}return i},_tests_createEditableFilter:e};CKEDITOR.event.implementOn(r.prototype);n.prototype={addClass:function(n){this.element.addClass(n)},applyStyle:function(n){v(this,n,1)},checkStyleActive:function(n){var t=w(n),i;if(!t)return!1;while(i=t.pop())if(!this.hasClass(i))return!1;return!0},destroy:function(n){if(this.fire("destroy"),this.editables)for(var t in this.editables)this.destroyEditable(t,n);n||(this.element.data("cke-widget-keep-attr")=="0"&&this.element.removeAttribute("data-widget"),this.element.removeAttributes(["data-cke-widget-data","data-cke-widget-keep-attr"]),this.element.removeClass("cke_widget_element"),this.element.replace(this.wrapper));this.wrapper=null},destroyEditable:function(n,t){var i=this.editables[n];i.removeListener("focus",k);i.removeListener("blur",b);this.editor.focusManager.remove(i);t||(this.repository.destroyAll(!1,i),i.removeClass("cke_widget_editable"),i.removeClass("cke_widget_editable_focused"),i.removeAttributes(["contenteditable","data-cke-widget-editable","data-cke-enter-mode"]));delete this.editables[n]},edit:function(){var t={dialog:this.dialog},n=this;return this.fire("edit",t)===!1||!t.dialog?!1:(this.editor.openDialog(t.dialog,function(t){var i,r;if(n.fire("dialog",t)!==!1){i=t.on("show",function(){t.setupContent(n)});r=t.on("ok",function(){var i,r=n.on("data",function(n){i=1;n.cancel()},null,null,0);n.editor.fire("saveSnapshot");t.commitContent(n);r.removeListener();i&&(n.fire("data",n.data),n.editor.fire("saveSnapshot"))});t.once("hide",function(){i.removeListener();r.removeListener()})}}),!0)},getClasses:function(){return this.repository.parseElementClasses(this.element.getAttribute("class"))},hasClass:function(n){return this.element.hasClass(n)},initEditable:function(n,t){var i=this._findOneNotNested(t.selector);if(i&&i.is(CKEDITOR.dtd.$editable)){i=new u(this.editor,i,{filter:e.call(this.repository,this.name,n,t)});this.editables[n]=i;i.setAttributes({contenteditable:"true","data-cke-widget-editable":n,"data-cke-enter-mode":i.enterMode});i.filter&&i.data("cke-filter",i.filter.id);i.addClass("cke_widget_editable");i.removeClass("cke_widget_editable_focused");t.pathName&&i.data("cke-display-name",t.pathName);this.editor.focusManager.add(i);i.on("focus",k,this);return CKEDITOR.env.ie&&i.on("blur",b,this),i._.initialSetData=!0,i.setData(i.getHtml()),!0}return!1},_findOneNotNested:function(t){for(var u=this.wrapper.find(t),i,f,r=0;r<u.count();r++)if(i=u.getItem(r),f=i.getAscendant(n.isDomWidgetWrapper),this.wrapper.equals(f))return i;return null},isInited:function(){return!!(this.wrapper&&this.inited)},isReady:function(){return this.isInited()&&this.ready},focus:function(){var n=this.editor.getSelection(),t;n&&(t=this.editor.checkDirty(),n.fake(this.wrapper),t||this.editor.resetDirty());this.editor.focus()},removeClass:function(n){this.element.removeClass(n)},removeStyle:function(n){v(this,n,0)},setData:function(n,t){var i=this.data,u=0,r;if(typeof n=="string")i[n]!==t&&(i[n]=t,u=1);else{r=n;for(n in r)i[n]!==r[n]&&(u=1,i[n]=r[n])}return u&&this.dataReady&&(d(this),this.fire("data",i)),this},setFocused:function(n){return this.wrapper[n?"addClass":"removeClass"]("cke_widget_focused"),this.fire(n?"focus":"blur"),this},setSelected:function(n){return this.wrapper[n?"addClass":"removeClass"]("cke_widget_selected"),this.fire(n?"select":"deselect"),this},updateDragHandlerPosition:function(){var i=this.editor,u=this.element.$,r=this._.dragHandlerOffset,n={x:u.offsetLeft,y:u.offsetTop-t},f;r&&n.x==r.x&&n.y==r.y||(f=i.checkDirty(),i.fire("lockSnapshot"),this.dragHandlerContainer.setStyles({top:n.y+"px",left:n.x+"px",display:"block"}),i.fire("unlockSnapshot"),f||i.resetDirty(),this._.dragHandlerOffset=n)}};CKEDITOR.event.implementOn(n.prototype);n.getNestedEditable=function(t,i){return!i||i.equals(t)?null:n.isDomNestedEditable(i)?i:n.getNestedEditable(t,i.getParent())};n.isDomDragHandler=function(n){return n.type==CKEDITOR.NODE_ELEMENT&&n.hasAttribute("data-cke-widget-drag-handler")};n.isDomDragHandlerContainer=function(n){return n.type==CKEDITOR.NODE_ELEMENT&&n.hasClass("cke_widget_drag_handler_container")};n.isDomNestedEditable=function(n){return n.type==CKEDITOR.NODE_ELEMENT&&n.hasAttribute("data-cke-widget-editable")};n.isDomWidgetElement=function(n){return n.type==CKEDITOR.NODE_ELEMENT&&n.hasAttribute("data-widget")};n.isDomWidgetWrapper=function(n){return n.type==CKEDITOR.NODE_ELEMENT&&n.hasAttribute("data-cke-widget-wrapper")};n.isParserWidgetElement=function(n){return n.type==CKEDITOR.NODE_ELEMENT&&!!n.attributes["data-widget"]};n.isParserWidgetWrapper=function(n){return n.type==CKEDITOR.NODE_ELEMENT&&!!n.attributes["data-cke-widget-wrapper"]};u.prototype=CKEDITOR.tools.extend(CKEDITOR.tools.prototypedCopy(CKEDITOR.dom.element.prototype),{setData:function(n){this._.initialSetData||this.editor.widgets.destroyAll(!1,this);this._.initialSetData=!1;n=this.editor.dataProcessor.toHtml(n,{context:this.getName(),filter:this.filter,enterMode:this.enterMode});this.setHtml(n);this.editor.widgets.initOnAll(this)},getData:function(){return this.editor.dataProcessor.toDataFormat(this.getHtml(),{context:this.getName(),filter:this.filter,enterMode:this.enterMode})}});c=new RegExp('^(?:<(?:div|span)(?: data-cke-temp="1")?(?: id="cke_copybin")?(?: data-cke-temp="1")?>)?(?:<(?:div|span)(?: style="[^"]+")?>)?<span [^>]*data-cke-copybin-start="1"[^>]*>.?<\/span>([\\s\\S]+)<span [^>]*data-cke-copybin-end="1"[^>]*>.?<\/span>(?:<\/(?:div|span)>)?(?:<\/(?:div|span)>)?$',"i");a={37:1,38:1,39:1,40:1,8:1,46:1},function(){function t(){}function i(n,t,i){if(!i||!this.checkElement(n))return!1;var r=i.widgets.getByElement(n,!0);return r&&r.checkStyleActive(this)}CKEDITOR.style.addCustomHandler({type:"widget",setup:function(n){this.widget=n.widget},apply:function(n){n instanceof CKEDITOR.editor&&this.checkApplicable(n.elementPath(),n)&&n.widgets.focused.applyStyle(this)},remove:function(n){n instanceof CKEDITOR.editor&&this.checkApplicable(n.elementPath(),n)&&n.widgets.focused.removeStyle(this)},checkActive:function(n,t){return this.checkElementMatch(n.lastElement,0,t)},checkApplicable:function(n,t){return(t instanceof CKEDITOR.editor)?this.checkElement(n.lastElement):!1},checkElementMatch:i,checkElementRemovable:i,checkElement:function(t){if(!n.isDomWidgetWrapper(t))return!1;var i=t.getFirst(n.isDomWidgetElement);return i&&i.data("widget")==this.widget},buildPreview:function(n){return n||this._.definition.name},toAllowedContentRules:function(n){if(!n)return null;var t=n.widgets.registered[this.widget],i,r={};return t?t.styleableElements?(i=this.getClassesArray(),!i)?null:(r[t.styleableElements]={classes:i,propertiesOnly:!0},r):t.styleToAllowedContentRules?t.styleToAllowedContentRules(this):null:null},getClassesArray:function(){var n=this._.definition.attributes&&this._.definition.attributes["class"];return n?CKEDITOR.tools.trim(n).split(/\s+/):null},applyToRange:t,removeFromRange:t,applyToObject:t})}();CKEDITOR.plugins.widget=n;n.repository=r;n.nestedEditable=u})()