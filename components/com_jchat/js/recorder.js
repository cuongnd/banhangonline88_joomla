(function(b){var a=function(e,d){var y=this;var v=e;var z=null;var k=null;var C=null;var p=null;var s=null;var q=[];var x={mimeType:"video/webm"};var l;var f=false;var h=null;var g=null;var o=null;var u=false;var B=null;var A=false;var m=function(G){if(b(G).data("recording")){if(A){console.log("Already started recording session")}return false}var H=v.getLocalStream();z=new MediaRecorder(H,x);z.ondataavailable=w;if(A){z.onerror=function(I){console.log("An error has occurred: "+I.message)}}try{z.start();b(G).data("recording",true).toggleClass("jchat_stop_recording");b("#jchat_webrtc_pause, #jchat_webrtc_stop").data("active",true);b("#jchat_webrtc_view, #jchat_webrtc_download, #jchat_webrtc_upload, #jchat_webrtc_sendvideo").data("empty",true).removeClass("jchat_btn_enabled");if(A){console.log("Started recording");console.log("State:"+z.state)}}catch(F){if(A){console.log("Error starting recording: "+F.message)}}};var D=function(G){if(!b(G).data("active")){if(A){console.log("Still not started recording session to pause it")}return false}try{if(z.state==="recording"){if(!h){z.stop()}else{z.pause()}f=true;b("#jchat_webrtc_record").removeClass("jchat_stop_recording").addClass("jchat_recording_blink");if(A){console.log("Paused recording");console.log("State:"+z.state)}}else{if(z.state==="inactive"||(h&&z.state==="paused")){if(!h){z.start()}else{z.resume()}f=false;b("#jchat_webrtc_record").addClass("jchat_stop_recording").removeClass("jchat_recording_blink");if(A){console.log("Resumed recording");console.log("State:"+z.state)}}}b(G).toggleClass("jchat_enabled")}catch(F){if(A){console.log("Error pausing recording: "+F.message)}}};var r=function(G){if(!b(G).data("active")){if(A){console.log("Still not started recording session to stop it")}return false}z.onstop=t;b("#jchat_webrtc_record").data("recording",false).removeClass("jchat_stop_recording jchat_recording_blink");b("#jchat_webrtc_pause, #jchat_webrtc_stop").data("active",false);b("#jchat_webrtc_pause").removeClass("jchat_enabled");try{z.stop();if(A){console.log("Stopped recording");console.log("State:"+z.state)}}catch(F){if(f){t();if(A){console.log("Stopped recording from simulated pause");console.log("State:"+z.state)}}if(A){console.log("Error stopping recording: "+F.message)}}};var w=function(F){if(z.state==="recording"||h){q.push(F.data)}};var t=function(M){k=new Blob(q,{type:x.mimeType});var O="KB";var I=(k.size/1024).toFixed(2);if(parseInt(I/1024)>0){O="MB";I=(I/1024).toFixed(2)}p=I+O;var G=new Date();var N=G.getFullYear();var L=parseInt(G.getMonth())+1;L=L<10?"0"+L:L;var K=G.getDate();K=K<10?"0"+K:K;var J=G.getHours();J=J<10?"0"+J:J;var H=G.getMinutes();H=H<10?"0"+H:H;var F=G.getSeconds();F=F<10?"0"+F:F;s=N+"-"+L+"-"+K+" "+J+":"+H+":"+F;C=g+"_"+o+"_"+N+"_"+L+"_"+K+"_"+J+"_"+H+"_"+F+".webm";j(C);q=[]};var j=function(G){var F=new FileReader();F.onload=function(I){var H=I.target.result;b("#jchat_webrtc_view").attr("onclick",'window.open("'+H+'", "video","width=640,height=480");return false;').data("empty",false).addClass("jchat_btn_enabled");b("#jchat_webrtc_download").attr("href",H).attr("download",G).data("empty",false).addClass("jchat_btn_enabled");b("#jchat_webrtc_upload, #jchat_webrtc_sendvideo").data("empty",false).addClass("jchat_btn_enabled");b("#jchat_webrtc_sendvideo").data("videodata",H)};F.readAsDataURL(k)};var c=function(){if(!k||u){return}var F=new FormData();F.append("peer1",g);F.append("peer2",o);F.append("timerecord",s);F.append("filename",C);F.append("filesize",p);F.append("blob",k);F.append("task","recorder.saveEntity");b("#jchat_webrtc_upload_progress").show();b("#jchat_wrapper_localvideo_recorder > #jchat_webrtc_upload_progress").css("display","inline-block");u=true;b.ajax({url:jchat_livesite+"index.php?option=com_jchat&format=json",type:"POST",data:F,cache:false,dataType:"json",processData:false,contentType:false,xhr:function(){var G=b.ajaxSettings.xhr();G.upload.onprogress=function(H){var I=parseInt(H.loaded/H.total*100)+"%";b("#jchat_webrtc_upload_progress").css("background-image","linear-gradient(90deg, #468847 "+I+", #9E9E9E "+I+")").html("<span>"+I+"</span>")};return G},success:function(H,I,G){if(H.result){b("#jchat_webrtc_upload_progress").html("<span>"+jchat_upload_complete+"</span>")}else{E(H.exception_message);b("#jchat_webrtc_upload_progress").html("<span>"+jchat_upload_error+"</span>").css("background-image","linear-gradient(90deg, #F72B28 100%, #F72B28 100%)")}setTimeout(function(){b("#jchat_webrtc_upload_progress").html("").removeAttr("style").hide();u=false},2500)},error:function(G,I,H){E(I);b("#jchat_webrtc_upload_progress").html("<span>"+jchat_upload_error+"</span>").css("background-image","linear-gradient(90deg, #F72B28 100%, #F72B28 100%)");setTimeout(function(){b("#jchat_webrtc_upload_progress").html("").removeAttr("style").hide();u=false},2500)}})};var n=function(){b("#jchat_webrtc_record",l).on("click.jchatwebrtc",{scope:this},function(F){m(this)});b("#jchat_webrtc_pause",l).on("click.jchatwebrtc",{scope:this},function(F){D(this)});b("#jchat_webrtc_stop",l).on("click.jchatwebrtc",{scope:this},function(F){r(this)});b("#jchat_webrtc_view, #jchat_webrtc_download, #jchat_webrtc_upload, #jchat_webrtc_sendvideo").on("click.jchatwebrtc",{scope:this},function(I){if(b(this).data("empty")){return false}if(b(this).attr("id")=="jchat_webrtc_upload"){c()}if(b(this).attr("id")=="jchat_webrtc_sendvideo"){var G,K;var F=b(this).parent().prevAll(".jchat_tabcontentinput").children("div");var M=b(F).get(0);if(b.support.leadingWhitespace&&B){var J=b("<video/>").attr("controls",true);var H=b("<source/>").attr("src",b(this).data("videodata")).attr("type","video/webm");J.append(H);b("br:last-child",F).remove();b(F).append(J);var L=b.Event("keydown");L.which="videomessage";L.keyCode=13;L.shiftKey=0;b(F).trigger(L)}}})};var E=function(F){b("div#jchat_msg").remove();b("<div/>").attr("id","jchat_msg").prependTo("body").append('<div id="jchat_msgtext">'+F+"</div>").css("margin-top",0).hide().fadeIn(500).delay(2500).fadeOut(500,function(){b(this).remove()})};this.initializeVideo=function(G,F,H){l=G;G.append('<div id="jchat_webrtc_record" class="jchat_start_recording"></div>');G.append('<div id="jchat_webrtc_pause" class="jchat_pause_recording"></div>');G.append('<div id="jchat_webrtc_stop" class="jchat_stop_recording"></div>');b("#jchat_webrtc_pause, #jchat_webrtc_stop").data("active",false);G.append('<a id="jchat_webrtc_view" class="jchat_view_recording" href="javascript:void(0);" target="_blank"></a>');G.append('<a id="jchat_webrtc_download" class="jchat_download_recording" href="" download="blobfile.webm"></a>');if(d.permissions.allow_media_recorder_save){if(G.attr("id")!="jchat_wrapper_localvideo_recorder"){G.append('<a id="jchat_webrtc_sendvideo" class="jchat_send_recording" href="javascript:void(0);"></a>')}G.append('<div id="jchat_webrtc_upload" class="jchat_upload_recording"></div>')}b("#jchat_webrtc_view, #jchat_webrtc_download, #jchat_webrtc_upload, #jchat_webrtc_sendvideo").data("empty",true);G.append('<div id="jchat_webrtc_upload_progress"></div>');o=F;g=H;n.call(this)};(function i(){if(typeof(MediaRecorder)==="undefined"){return}B=jchatSupportContentEditable();A=d.debugEnabled;if(navigator.mozGetUserMedia){h=true}if(typeof(MediaRecorder.isTypeSupported)!=="undefined"){if(MediaRecorder.isTypeSupported("video/webm;codecs=vp9")){x={mimeType:"video/webm;codecs=vp9"}}else{if(MediaRecorder.isTypeSupported("video/webm;codecs=vp8")){x={mimeType:"video/webm;codecs=vp8"}}else{}}}}).call(this)};window.JChatRecorder=a})(jQuery);