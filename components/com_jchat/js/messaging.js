(function(b){var a=function(){var m=null;var i;var q;var j;var k=0;var r=null;var g={};var p=function(u){var s=b("#"+u);var t=s.width()/2;b(s).prepend("<img/>").children("img").attr("id","jchat_messages_waiter").attr("src",jchatBaseURI+"components/com_jchat/images/fbloading.gif").css({position:"absolute",margin:"50px "+parseInt(t-32)+"px",width:"64px","z-index":"99999"})};var h=function(s){b(s).before('<div class="jchat_messaging_emoticonstooltip"></div>');var u=new Array();var t=0;b.each(window.jchat_emoticons,function(x,y){if((x>0)&&(x%10)==0){t++}if(u[t]===undefined){u[t]=""}u[t]+='<img class="jchat_emoticons" title="'+y.keycode+'" src="'+jchat_livesite+y.path+'"/>'});b.each(u,function(x,y){b(".jchat_messaging_emoticonstooltip").append('<div class="jchat_tooltip_content">'+y+"</div>")});var w=b(s).offset();var v=jchatGetPageScroll();b(".jchat_messaging_emoticonstooltip").css("top",w.top-parseInt(v[1])-134).css("left",w.left-b(window).scrollLeft()).css("display","block").css("z-index",10002);b(".jchat_messaging_emoticonstooltip img").click(function(C){var z,B;var y=b("#jchat_privatemessaging_textarea");var D=b(y).get(0);if(b.support.leadingWhitespace&&q){var A=b(this).clone();b("br:last-child",y).remove();b(y).append(A)}else{if(q){var x=" "+b(this).attr("title");b(y).append(x)}else{var x=" "+b(this).attr("title");y=b(this).parent().parent().prev().children("textarea");b(y).val(b(y).val()+x)}}if(document.createRange){z=document.createRange();z.selectNodeContents(D);z.collapse(false);B=window.getSelection();B.removeAllRanges();if(!jchatHasTouch()){B.addRange(z)}}else{if(document.selection){z=document.body.createTextRange();z.moveToElementText(D);z.collapse(false);if(!jchatHasTouch()){z.select()}}}if(!jchatHasTouch()){y.focus()}if(jchatHasTouch()||jchat_auto_close_popups){b(s).trigger("click")}});if(!jchatHasTouch()){b("#jchat_privatemessaging_textarea").focus()}};var o=function(u,x,t){b(u).before('<div class="jchat_messaging_fileuploadtooltip"></div>');var s=x?"&to="+x:"";b(".jchat_messaging_fileuploadtooltip").append("<img/>").children("img").attr("src",jchat_livesite+"components/com_jchat/images/loading.gif").css({position:"absolute",margin:"10px 46%",width:"32px"});b(".jchat_messaging_fileuploadtooltip").append('<iframe id="jchat_messaging_fileupload_iframe"  scrolling="no" src="'+j+"&task=attachments.display&form=pm"+s+"&tologged="+t+'"></iframe>');b("#jchat_messaging_fileupload_iframe").on("load",function(){setTimeout(function(){b(".jchat_messaging_fileuploadtooltip img").remove()},1)});var v=b(u).offset();var w=jchatGetPageScroll();b(".jchat_messaging_fileuploadtooltip").css("top",v.top-parseInt(w[1])-59).css("left",v.left-b(window).scrollLeft()).css("display","block").css("z-index",10002);if(!jchatHasTouch()){b("div.jchat_textarea").focus()}};var n=function(s){b(s).before('<div class="jchat_messaging_delete_conversation_tooltip"><div id="jchat_confirm_delete">'+COM_JCHAT_CONFIRM_DELETE_MESSAGE+'</div><div id="jchat_confirm_delete_sub">'+COM_JCHAT_CONFIRM_DELETE_SUBMESSAGE+'</div><div id="jchat_confirm_discard_btn" class="jchat_tooltip_btns">'+COM_JCHAT_DISCARD_DELETE+'</div><div id="jchat_confirm_delete_btn" class="jchat_tooltip_btns">'+COM_JCHAT_CONFIRM_DELETE+"</div></div>");var t=b(s).offset();var u=jchatGetPageScroll();b(".jchat_messaging_delete_conversation_tooltip").css("top",t.top-parseInt(u[1])-80).css("left",t.left-b(window).scrollLeft()).css("display","block").css("z-index",10002);b("#jchat_confirm_delete_btn").on("click",function(v){f()});b("#jchat_confirm_discard_btn").on("click",function(v){b(s).trigger("click")})};var e=function(x,v){var s=b(x).data("userid");if(!s){b("#jchat_messages_waiter").remove();return}b("#jchat_privatemessaging_textarea").data("loggedid",s).attr("data-loggedid",s);m=s;b.jStorage.set("activeMessagingUserId",s);var w={fromLoggedId:s,oldestMsgId:v};var u=JSON.stringify(w);i=false;var t=b.Deferred(function(y){b.ajax({type:"POST",url:jchat_livesite+"index.php?option=com_jchat&task=messaging.showEntity&format=json&Itemid="+jchat_itemid,dataType:"json",context:this,data:{data:u}}).done(function(A,B,z){if(!A.loading.status){y.reject(A.loading.exception_message,B);return false}if(!A.messages.length){y.reject(COM_JCHAT_NOMESSAGES_FOUND,B,true);return false}if(A.loading.status&&A.messages.length){y.resolve(A.messages)}}).fail(function(A,C,B){var z=C[0].toUpperCase()+C.slice(1);y.reject("-"+z+"- "+B)})}).promise();t.then(function(A){if(!v){b("#jchat_usersmessages").empty()}b.each(A,function(E,G){var D=b("li.jchat_userbox[data-userid="+G.userid+"] img.jchat_usersbox_avatar").attr("src");var B="";var F=false;if(G.userid==jchat_my_userid){D=jchat_my_avatar;B=" selfmessage";F=true}if(G.type=="file"){var I=jchatTrasformMsgFile(G.message,G.id,F,G.from,G.status,false,G)}else{var I=jchatStripTags(G.message,jchat_allow_media_objects);I=I.replace(/&/gi,"&amp;")}var C=new Date(G.sent*1000);var H='<div class="jchat_chatboxmessage'+B+'" data-messageid="'+G.id+'"><span class="jchat_chatboxmessagefrom"><img alt="'+G.fromusername+'" width="32px" height="32px" src="'+D+'"></span><div class="jchat_chatboxmessageinfo"><div class="jchat_chatboxmessagefromname">'+G.fromusername+'</div><span class="jchat_chatboxmessagecontent'+B+'">'+I+'</span></div><div class="jchat_chatboxmessagedate'+B+'"><div>'+C.toLocaleString()+"</div></div></div>";b("#jchat_usersmessages").prepend(H)});if(!v){b("#jchat_usersmessages").scrollTop(b("#jchat_usersmessages")[0].scrollHeight)}else{var y=b("#jchat_usersmessages");var z=b("div.jchat_chatboxmessage[data-messageid="+v+"]").offset().top+y.scrollTop()-parseInt(y.height()-40);b("#jchat_usersmessages").animate({scrollTop:parseInt(z)},50)}b("#jchat_loadolder_messages").show().text(COM_JCHAT_LOAD_OLDER_MESSAGES)},function(z,A,y){if(jchat_messaging_debug){console.log(z)}if(!v){b("#jchat_usersmessages").empty();b("#jchat_loadolder_messages").hide()}if(y&&!v){b("#jchat_usersmessages").append('<div class="jchat_messaging_info">'+z+"</div>")}if(y&&v){b("#jchat_loadolder_messages").text(COM_JCHAT_LOAD_NOFOUND_OLDER_MESSAGES);setTimeout(function(){b("#jchat_loadolder_messages").text(COM_JCHAT_LOAD_OLDER_MESSAGES)},2000)}}).always(function(){b("#jchat_messages_waiter").remove();var B=b("#jchat_usersmessages div.jchat_chatboxmessage:first-child").data("messageid")||0;var z="index.php?option=com_jchat&amp;format=raw&amp;task=export.displayMessaging&amp;userid="+m+"&amp;oldestmessageid="+B;b("div.jchat_trigger_messaging_export a").attr("href",jchat_livesite+z);var y=b("#jchat_usersmessages div.jchat_chatboxmessage:last-child");if(y.length){var A=jchatStripTags(b("span.jchat_chatboxmessagecontent",y).html(),false,true,true);if(A.length>25){A=A.substr(0,22)+"..."}b("li.jchat_userbox.jchat_active div.jchat_lastmessage").html('<span class="jchat_lastmessage_icon"></span>'+A)}i=true})};var f=function(){var t=b.map(b("#jchat_usersmessages div.jchat_chatboxmessage"),function(u){return b(u).data("messageid")});var s=b.Deferred(function(u){b.ajax({type:"POST",url:jchat_livesite+"index.php?option=com_jchat&task=messaging.deleteEntity&format=json",dataType:"json",context:this,data:{ids:t}}).done(function(w,x,v){if(!w.deleting.status){u.reject(w.exception_message,x);return false}if(w.deleting.status){u.resolve()}}).fail(function(w,y,x){var v=y[0].toUpperCase()+y.slice(1);u.reject("-"+v+"- "+x)})}).promise();s.then(function(u){b("div.jchat_trigger_messaging_delete").trigger("click");b("#jchat_usersmessages div.jchat_chatboxmessage").animate({opacity:0,width:0},500,function(){b("#jchat_usersmessages").empty()});b("li.jchat_userbox[data-userid="+m+"] div.jchat_lastmessage").empty()},function(u,v){if(jchat_messaging_debug){console.log(u)}})};var l=function(){b("li.jchat_userbox").on("click",function(s){k=0;b("#jchat_usersmessages").removeClass("jchat_empty");m=null;b("li.jchat_userbox").removeClass("jchat_active");p("jchat_right_messagescolumn");b(".jchat_userbox").removeClass("jchat_active");b(this).addClass("jchat_active");b("span.jchat_newmessages_notifier",this).remove();var t=b(this).data("userid");if(g[t]){delete g[t];b.jStorage.set("privateMessagingCounters",g,{TTL:(3600*1000)})}b("#jchat_privatemessaging_textarea, div.jchat_userslist_ctrls").show();b("div.jchat_fullcolumn_input span.banned_msg").remove();e(this,false)});b("#jchat_loadolder_messages").on("click",function(t){var s=b("li.jchat_userbox.jchat_active");var u=b(b("#jchat_usersmessages div.jchat_chatboxmessage").get(0)).attr("data-messageid");p("jchat_right_messagescolumn");b("#jchat_loadolder_messages").text(COM_JCHAT_OLDER_MESSAGES_LOADING);e(s,u)});b("div[data-trigger=1]").toggle(function(t){var u=b('div.jchat_fullcolumn_input div[class*="tooltip"]');if(!!u.length){u.next().trigger("click")}b(this).addClass("toggle_on");var v=b(this).data("role");switch(v){case"emoticons":h(this);break;case"fileupload":var s=b("#jchat_privatemessaging_textarea").data("loggedid");if(!s){b(this).trigger("click");break}var w=b("div[id^=jchat_userlist][data-loggedid="+s+"]").data("sessionid")||false;o(this,w,s);break;case"deleteconversation":n(this);break}},function(s){b(this).prev("div[class^=jchat_messaging]").remove();b(this).removeClass("toggle_on")});b("div.jchat_trigger_messaging_openbox").on("click",function(t){var s=b("#jchat_privatemessaging_textarea").data("loggedid");if(s){var u=b("div[id^=jchat_userlist][data-loggedid="+s+"]");if(u.length){u.trigger("click")}else{b("#jchat_trigger_messaging_openbox_tooltip div.jchat_tooltip_content").text(COM_JCHAT_USER_NOT_CONNECTED)}}});b("#jchat_usersmessages").on("scroll",function(t){if(!i){t.preventDefault();return false}var s=b(this).scrollTop();var u=b(this)[0].scrollHeight/2;if(s<k&&s==0){b("#jchat_loadolder_messages").trigger("click")}k=s});b("#jchat_usersmessages").on("DOMMouseScroll mousewheel",function(s){if(!i){s.preventDefault();return false}if(((s.originalEvent.wheelDelta/120>0)||(s.originalEvent.detail<0))&&k==0){b("#jchat_loadolder_messages").trigger("click")}});b("#jchat_leftusers_search").on("keyup",function(s){if(s.keyCode!=13){c()}});b("#jchat_messaging_maximizebutton").on("click",function(s,t){b(this).toggleClass("jchat_maximized");b("#jchat_private_messaging").toggleClass("jchat_maximized");if(!t){r=!b.jStorage.get("privatemessaging_maximized",0);b.jStorage.set("privatemessaging_maximized",r)}if(r){b("#jchat_private_messaging").parents().filter(function(u){return b(this).prop("tagName")!="HTML"}).css("position","inherit")}});b(document).on("click","#jchat_leftusers_search_reset",function(){b("#jchat_leftusers_search").val("");b(this).remove();b("#jchat_userslist li").show()})};var c=function(){var t=b("#jchat_leftusers_search").val();var u=new RegExp(t,"gi");b("#jchat_userslist li").each(function(v,w){b(w).show();var x=b(w).data("username");if(!x.match(u)){b(w).hide()}});b("#jchat_leftusers_search").next("#jchat_leftusers_search_reset").remove();if(t){var s=b("<span/>").attr("id","jchat_leftusers_search_reset");b("#jchat_leftusers_search").after(s)}};this.appendFileMessage=function(y){var s=!!b("span.jchat_tabclick[data-loggedid="+m+"]").length;if(!s){var u=new Date();var x='<img class="clessidra" src="'+jchat_livesite+'components/com_jchat/images/attachment.png"/>';if(jchat_my_avatar!==undefined&&jchat_my_avatar!==null&&jchat_my_avatar!==""&&jchat_avatarenable){var w='<img alt="'+jchat_my_username+'" width="32px" height="32px" src="'+jchat_my_avatar+'" />'}else{var w="<strong>"+jchat_my_username+"</strong>"}var t=parseInt(b("#jchat_usersmessages div.jchat_chatboxmessage:last-child").data("messageid"))+1;var v='<div class="jchat_chatboxmessage selfmessage" data-messageid="'+t+'"><span class="jchat_chatboxmessagefrom">'+w+'</span><div class="jchat_chatboxmessageinfo"><div class="jchat_chatboxmessagefromname">'+jchat_my_username+'</div><span class="jchat_chatboxmessagecontent selfmessage">'+x+jchat_sent_file+'<div class="filename">'+y+'</div><img class="clessidra" src="'+jchat_livesite+'components/com_jchat/images/default/loading.gif"/>'+jchat_sent_file_waiting+'</span></div><div class="jchat_chatboxmessagedate selfmessage"><div>'+u.toLocaleString()+"</div></div></div>";b("#jchat_usersmessages").append(v);b("#jchat_usersmessages").scrollTop(b("#jchat_usersmessages")[0].scrollHeight)}};(function d(){l();i=true;q=jchatSupportContentEditable();j=jchat_livesite+"index.php?option=com_jchat&format=raw";r=b.jStorage.get("privatemessaging_maximized");if(r&&jchatDetectMobileDevice(979)){b("#jchat_messaging_maximizebutton").trigger("click",[true])}if(r===null&&jchat_privatemessaging_maximized==1&&jchatDetectMobileDevice(979)){b("#jchat_messaging_maximizebutton").trigger("click",[false])}m=b.jStorage.get("activeMessagingUserId",null);if(m){b("li.jchat_userbox[data-userid="+m+"]").trigger("click")}else{b("#jchat_usersmessages").addClass("jchat_empty")}if(b.jStorage.get("privateMessagingCounters",false)){g=b.jStorage.get("privateMessagingCounters");b.each(g,function(v,t){var u=b("#jchat_userslist li.jchat_userbox[data-userid="+v+"]","#jchat_private_messaging");var s='<span class="jchat_newmessages_notifier">'+t+"</span>";b("span.jchat_usersbox_name",u).next(".jchat_newmessages_notifier").remove().end().after(s)})}b(window).on("resize.jchat",function(s){var t=b("div.jchat_userslist_ctrls div.toggle_on");if(t.length){t.trigger("click")}})}).call(this)};b(function(){window.JChatMessaging=new a()})})(jQuery);