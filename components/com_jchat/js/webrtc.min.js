(function($){var Webrtc=function(options){var bindContext=this;var $tooltipContainer;var supportFullWebRTC;var ringingInterval;var bandwidthInterval;var durationInterval;var bandwidthSentBytes=0;var debugLogging=options.debugEnabled;var jsonLiveSite=options.jsonLiveSite;var peerConnection=null;var peerCandidates=new Array();var localGotStream;var candidatesCounter=0;var servers={};var startCallTimeout=null;var endCallTimeout=null;var RTCMessagesTimeout=null;var remotePeer=null;var receivedSdpMessage=null;var receivedICECandidates=null;var callStatus=false;var promiseResolved=false;var streamAudioContext=null;var gainFilterNode=null;var thispeerVideoCamState=1;var otherpeerVideoCamState=1;var connectionSpeed=0;var connectionSpeedConstraints={'Highest':{minValue:0,maxValue:0.5},'High':{minValue:0.5,maxValue:1},'Average':{minValue:1,maxValue:1.5},'Low':{minValue:1.5,maxValue:3},'Lowest':{minValue:3,maxValue:999}};var webCamConstraints={'Auto':true,'Highest':{mandatory:{minWidth:1280,minHeight:720},optional:[{frameRate:60},{facingMode:"user"}]},'High':{mandatory:{minWidth:1024,minHeight:720},optional:[{frameRate:60},{facingMode:"user"}]},'Average':{mandatory:{maxWidth:640,maxHeight:480},optional:[{frameRate:30},{facingMode:"user"}]},'Low':{mandatory:{maxWidth:320,maxHeight:240},optional:[{frameRate:30},{facingMode:"user"}]},'Lowest':{mandatory:{maxWidth:160,maxHeight:120},optional:[{frameRate:15},{facingMode:"user"}]}};var webCamNewConstraints={'Auto':true,'Highest':{video:{width:{min:1024,ideal:1280,max:1920},height:{min:640,ideal:720,max:1080}},frameRate:60,facingMode:"user"},'High':{video:{width:{min:960,ideal:1024,max:1280},height:{min:640,ideal:720,max:960}},frameRate:60,facingMode:"user"},'Average':{video:{width:{min:320,ideal:640,max:960},height:{min:240,ideal:480,max:640}},frameRate:30,facingMode:"user"},'Low':{video:{width:320,height:240},frameRate:30,facingMode:"user"},'Lowest':{video:{width:160,height:120},frameRate:15,facingMode:"user"}};var webCamConstraintsSelect=$('<select id="jchat_webrtc_camquality"></select>');var webCamQuality=true;this.localVideo=null;this.remoteVideo=null;this.caller=false;this.callee=false;window.RTCPeerConnection=window.RTCPeerConnection||window.webkitRTCPeerConnection||window.mozRTCPeerConnection;if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){}else{if(!navigator.mediaDevices){navigator.mediaDevices=new Object();}
navigator.mediaDevices.getUserMedia=((navigator.getUserMedia||navigator.mozGetUserMedia||navigator.webkitGetUserMedia)?function(constraints){return new $.Deferred(function(defer){(navigator.getUserMedia||navigator.mozGetUserMedia||navigator.webkitGetUserMedia).call(navigator,constraints,defer.resolve,defer.reject);});}:null);};var registerEvents=function(){$('#jchat_start_accept_call',$tooltipContainer).on('click.jchatwebrtc',{scope:this},function(jqEvent){if($(this).hasClass('jchat_disabled')){return false;}
if(!jqEvent.data.scope.callee){jqEvent.data.scope.caller=true;JChatNotifications.playStartWebrtcCall();startCall();}else{resetSounds();JChatNotifications.playAcceptWebrtcCall();acceptCall.call(jqEvent.data.scope);}});$('#jchat_end_call',$tooltipContainer).on('click.jchatwebrtc',{scope:this},function(jqEvent,details){if($(this).hasClass('jchat_disabled')){return false;}
jqEvent.data.scope.caller=false;jqEvent.data.scope.callee=false;promiseResolved=false;endCall(details);});$('#jchat_webrtc_volume input',$tooltipContainer).on('mousemove.jchatwebrtc',function(jqEvent){var volume=$(this).val()/ 100;$('#jchat_remotevideo').get(0).volume=volume;$.jStorage.set('jchat_webrtc_volume',volume);});$('#jchat_webrtc_mic input',$tooltipContainer).on('mousemove.jchatwebrtc',function(jqEvent){var volume=$(this).val()/ 100;if(window.AudioContext){gainFilterNode.gain.value=volume;}
if(localGotStream&&navigator.mozGetUserMedia){localGotStream.getAudioTracks()[0].enabled=!!volume;}
$.jStorage.set('jchat_webrtc_mic',volume);});$('#jchat_webrtc_video',$tooltipContainer).on('change.jchatwebrtc',function(jqEvent){var state=$(this).prop('checked');thispeerVideoCamState=state?1:0;$.jStorage.set('jchat_webrtc_videocam',thispeerVideoCamState);var updateSessionPromise=$.Deferred(function(defer){$.ajax({type:"POST",url:jsonLiveSite,dataType:'json',context:this,data:{task:'webrtc.updateEntity','videocam':thispeerVideoCamState}}).done(function(response,textStatus,jqXHR){if(!response.storing.status){defer.reject(response.storing.exception_message,textStatus);return false;}
defer.resolve();}).fail(function(jqXHR,textStatus,errorThrown){var genericStatus=textStatus[0].toUpperCase()+textStatus.slice(1);defer.reject('-'+genericStatus+'- '+errorThrown);});}).promise();updateSessionPromise.then(function(responseData){if(options.hideWebcamWhenDisabled){if(!thispeerVideoCamState){if(options.hideWebcamWhenDisabled==2){$('#jchat_wrapper_localvideo').hide();}else{$('#jchat_localvideo').after('<div id="jchat_localvideo_placeholder"></div>');$('#jchat_localvideo_placeholder').height($('#jchat_localvideo').height());}
$('#jchat_localvideo').hide();}else{if(options.hideWebcamWhenDisabled==2){$('#jchat_wrapper_localvideo').show();}else{$('#jchat_localvideo').next('#jchat_localvideo_placeholder').remove();}
$('#jchat_localvideo').show();}}
$('#jchat_wrapper_localvideo').toggleClass('active');if(debugLogging){console.log('Updated session videocam on server');}},function(errorText,error){if(debugLogging){console.log('Error updating session videocam on server: '+errorText);}});});$('#jchat_webrtc_camquality').on('change',function(jqEvent){$.jStorage.set('jchat_webrtc_videocam_quality',$(this).val());$.jStorage.set('jchat_remotepeer_webrtc_tooltip',remotePeer);$(this).blur();window.location.reload();});};var createPeerConnection=function(){try{peerConnection=new RTCPeerConnection(servers);peerConnection.onicecandidate=gotIceCandidate;checkIceCandidatesSent();peerConnection.addStream(localGotStream);peerConnection.onaddstream=function(event){gotRemoteStream(event);if(options.showWebRTCStats){getStats(peerConnection);}};peerConnection.oniceconnectionstatechange=function(){if(peerConnection){if(debugLogging){console.log('Connection: '+peerConnection.iceConnectionState);}
if(peerConnection.iceConnectionState=='completed'){showRTCMessages('jchat_infouser_webrtc','jchat_icon_ok','jchat_tooltip_innermsg',jchat_call_started,'jchat_info_closer');}
if(peerConnection.iceConnectionState=='connected'){showRTCMessages('jchat_infouser_webrtc','jchat_icon_ok','jchat_tooltip_innermsg',jchat_connection_active,'jchat_info_closer');durationTimer(1);}
if(peerConnection.iceConnectionState=='disconnected'){if(debugLogging){console.log(peerConnection.iceConnectionState);}
if(typeof endCallTimeout=='number'){clearTimeout(endCallTimeout);}
endCallTimeout=setTimeout(function(){if(peerConnection){if(peerConnection.iceConnectionState=='disconnected'){showRTCMessages('jchat_infouser_webrtc','jchat_icon_ok','jchat_tooltip_innermsg',jchat_call_disconnected,'jchat_info_closer');$('#jchat_end_call',$tooltipContainer).trigger('click',[jchat_call_disconnected]);}}},options.endCallTimeout);}
if(peerConnection.iceConnectionState=='failed'){showRTCMessages('jchat_infouser_webrtc','jchat_icon_ok','jchat_tooltip_innermsg',jchat_connection_failed,'jchat_info_closer');}}};}catch(exception){resetSounds();resetButtons();showRTCMessages('jchat_exceptions','jchat_icon_error','jchat_tooltip_error',jchat_error_creating_connection,'jchat_exceptions_closer');if(debugLogging){console.log(exception.message);}
return;}
if(!peerConnection){resetSounds();resetButtons();showRTCMessages('jchat_exceptions','jchat_icon_error','jchat_tooltip_error',jchat_error_creating_connection,'jchat_exceptions_closer');return;}};var startCall=function(){if(!localGotStream){showRTCMessages('jchat_exceptions','jchat_icon_error','jchat_tooltip_error',jchat_missing_local_stream,'jchat_exceptions_closer');return;}
createPeerConnection();if(!peerConnection){return;}
peerConnection.createOffer(gotSdpDescription,onSignalingError);showRTCMessages('jchat_infouser_webrtc','jchat_async_loader','jchat_tooltip_innermsg',jchat_connecting);bindContext.setCallerRingingButton();startCallTimeout=setTimeout(function(){$('#jchat_end_call',$tooltipContainer).trigger('click',[jchat_noanswer]);},options.startCallTimeout);$('#jchat_webrtc_camquality').attr('disabled',true);if(debugLogging){console.log('New call started');}};var acceptCall=function(){if(!peerConnection){createPeerConnection();}
if(this.callee){if(receivedSdpMessage){peerConnection.setRemoteDescription(new RTCSessionDescription(JSON.parse(receivedSdpMessage)),function(){if(debugLogging){console.log('Set remote description by callee');}},function(error){if(debugLogging){console.log('Error during set remote description:'+error);}});}
peerConnection.createAnswer(gotSdpDescription,onSignalingError);resetButtons(true);$('#jchat_start_accept_call',$tooltipContainer).addClass('jchat_disabled');$('#jchat_end_call',$tooltipContainer).removeClass('jchat_disabled');showRTCMessages('jchat_infouser_webrtc','jchat_icon_ok','jchat_tooltip_innermsg',jchat_call_starting,'jchat_info_closer');if(debugLogging){console.log('Exchanged SDP/ICE and call started between 2 peer');}}else if(this.caller){if(receivedSdpMessage){peerConnection.setRemoteDescription(new RTCSessionDescription(JSON.parse(receivedSdpMessage)),function(){if(debugLogging){console.log('Set remote description by caller');}},function(error){if(debugLogging){console.log('Error during set remote description:'+error);}});}}
if(receivedICECandidates){var candidates=JSON.parse(receivedICECandidates);$.each(candidates,function(index,candidate){var rtcCandidate=new RTCIceCandidate(candidate);try{peerConnection.addIceCandidate(rtcCandidate);}catch(exception){if(debugLogging){console.log(exception.message);}}});}};var endCall=function(details){var closedDetails=details?details:jchat_connection_closed;try{if(peerConnection){showRTCMessages('jchat_infouser_webrtc','jchat_async_loader','jchat_tooltip_innermsg',jchat_closing_connection);}
peerConnection.close();peerConnection=null;peerCandidates=new Array();candidatesCounter=0;}catch(exception){if(debugLogging){console.log(exception.message);}
if(debugLogging){console.log('Call/connection ended or refused');}}
var deleteSessionPromise=$.Deferred(function(defer){$.ajax({type:"POST",url:jsonLiveSite,dataType:'json',context:this,data:{task:'webrtc.deleteEntity',ids:remotePeer}}).done(function(response,textStatus,jqXHR){if(!response.storing.status){defer.reject(response.storing.exception_message,textStatus);return false;}
defer.resolve();}).fail(function(jqXHR,textStatus,errorThrown){var genericStatus=textStatus[0].toUpperCase()+textStatus.slice(1);defer.reject('-'+genericStatus+'- '+errorThrown);});}).promise();deleteSessionPromise.then(function(responseData){showRTCMessages('jchat_infouser_webrtc','jchat_icon_ok','jchat_tooltip_innermsg',closedDetails,'jchat_info_closer');durationTimer(0);if(debugLogging){console.log('Call ended, connection closed and session deleted on server');}},function(errorText,error){showRTCMessages('jchat_exceptions','jchat_icon_error','jchat_tooltip_error',jchat_connection_close_error,'jchat_exceptions_closer');if(debugLogging){console.log('Error deleting session on server: '+errorText);}}).always(function(){resetSounds();JChatNotifications.playEndWebrtcCall();resetButtons();resetVideo();resetBandWidth();});};var durationTimer=function(state){if(state==1){$('#jchat_webrtc_bandwidth').after('<div id="jchat_webrtc_duration"><span></span></div>');$('#jchat_webrtc_duration').hide();var startTime=Date.now();durationInterval=setInterval(function(){var currentTime=Date.now();var differenceDate=new Date(currentTime-startTime);var elapsed=differenceDate.toUTCString().replace(/.*(\d{2}:\d{2}:\d{2}).*/,"$1");;$('#jchat_webrtc_duration > span').text(elapsed);$('#jchat_webrtc_duration').show();},1000);}else{$('#jchat_webrtc_duration').remove();if(typeof(durationInterval)!=='undefined'){clearInterval(durationInterval);}}};var gotVideoStream=function(stream){var localPeerVideoElementStream;localGotStream=stream;if(localGotStream.addTrack&&!navigator.mozGetUserMedia){gainMicControl();}
if(options.showWebRTCVUMeter){micVUMeter();}
$('#jchat_start_accept_call',$tooltipContainer).removeClass('jchat_disabled');bindContext.localVideo=$('#jchat_localvideo').get(0);localPeerVideoElementStream=localGotStream;bindContext.localVideo.volume=0;if(navigator.mozGetUserMedia){$('#jchat_webrtc_mic input').attr('step',100);if($.jStorage.get('jchat_webrtc_mic')==null){$('#jchat_webrtc_mic input').val(100);}}
if(window.URL){bindContext.localVideo.src=URL.createObjectURL(localPeerVideoElementStream);}else{bindContext.localVideo.src=localPeerVideoElementStream;}
$(bindContext.localVideo).on('canplay',function(jqEvent){setTimeout(function(){var visibleWebcamVideoHeight=$('#jchat_localvideo:visible').height();if(visibleWebcamVideoHeight){$('#jchat_remotevideo_placeholder').height(visibleWebcamVideoHeight);}},500);});if(!!navigator.mozGetUserMedia&&!localGotStream.getVideoTracks()[0]){$('#jchat_localvideo').attr('poster',jchat_livesite+'components/com_jchat/images/default/placeholder.png');$('#jchat_webrtc_video').prop('checked',false).off('.jchatwebrtc').next().attr('for',null);showRTCMessages('jchat_top_exceptions','jchat_icon_error','jchat_tooltip_error',jchat_nowebcam_detected);}
setTimeout(function(){var haslocalStreamVideoTrack=!!localGotStream.getVideoTracks()[0];if(!navigator.mozGetUserMedia&&haslocalStreamVideoTrack){if(localGotStream.getVideoTracks()[0].readyState==='ended'){$('#jchat_localvideo').attr('poster',jchat_livesite+'components/com_jchat/images/default/placeholder.png');showRTCMessages('jchat_top_exceptions','jchat_icon_error','jchat_tooltip_error',jchat_hardware_unavailable);if(debugLogging){console.log('Video track state:'+localGotStream.getVideoTracks()[0].readyState);}}}},500);$('.jchat_infouser_webrtc.top').fadeOut(500);if(thispeerVideoCamState){$('#jchat_wrapper_localvideo').toggleClass('active');}
if(debugLogging){console.log('Local video stream started, video track state');}};function gotRemoteStream(event){bindContext.remoteVideo=$('#jchat_remotevideo').get(0);if(otherpeerVideoCamState&&event.stream.getVideoTracks()[0]){$('#jchat_remotevideo_placeholder').hide();$('#jchat_remotevideo').show();}
if(window.URL){bindContext.remoteVideo.src=window.URL.createObjectURL(event.stream);}else{bindContext.remoteVideo.src=event.stream;}
$('#jchat_wrapper_remotevideo').toggleClass('active');if(debugLogging){console.log('Remote video stream got');}};var gotSdpDescription=function(sdp){var SDPType=bindContext.caller?'offer':'answer';peerConnection.setLocalDescription(sdp,function(){if(debugLogging){console.log('SDP '+SDPType+' correctly generated');}},function(){if(debugLogging){console.log('SDP '+SDPType+' error');}});if(debugLogging){console.log('SDP '+SDPType+' created');}
signalingChannel('sdp',sdp);};var gotIceCandidate=function(event){if(event.candidate){if(event.candidate){peerCandidates[candidatesCounter]=event.candidate;}
candidatesCounter++;peerConnection.iceCandidatesSent=false;if(debugLogging){console.log('Event candidate found: '+event.candidate.candidate);}}else if(!event.candidate||peerConnection.iceGatheringState==='complete'){if(!peerConnection.iceCandidatesSent){signalingChannel('icecandidate',peerCandidates);peerConnection.iceCandidatesSent=true;if(debugLogging){console.log('icecandidates sent successfully using standard complete event');}}}};var checkIceCandidatesSent=function(){setTimeout(function(){if(peerConnection){if(!peerConnection.iceCandidatesSent){signalingChannel('icecandidate',peerCandidates);peerConnection.iceCandidatesSent=true;if(debugLogging){console.log('icecandidates sent successfully using polyfill');}}}},1000);};var signalingChannel=function(dataType,data){var postData={task:'webrtc.saveEntity',peer2:remotePeer,caller:(bindContext.caller?1:0),videocam:thispeerVideoCamState};switch(dataType){case'sdp':$.extend(postData,{'sdp':JSON.stringify(data)});break;case'icecandidate':$.extend(postData,{'icecandidate':JSON.stringify(data)});break;}
var signalingChannelPromise=$.Deferred(function(defer){$.ajax({type:"POST",url:jsonLiveSite,dataType:'json',context:this,data:postData}).done(function(response,textStatus,jqXHR){if(!response.storing.status){defer.reject(response.storing.exception_message,textStatus,response.storing);return false;}
defer.resolve(response.storing);}).fail(function(jqXHR,textStatus,errorThrown){var genericStatus=textStatus[0].toUpperCase()+textStatus.slice(1);defer.reject('-'+genericStatus+'- '+errorThrown,null,{});});}).promise();signalingChannelPromise.then(function(responseData){promiseResolved=true;if(debugLogging){console.log(dataType+' sent succesfully using signaling channel');}},function(errorText,error,exception){if(peerConnection){if(exception.usermessage){showRTCMessages('jchat_exceptions','jchat_icon_error','jchat_tooltip_error',errorText,'jchat_exceptions_closer');}else{showRTCMessages('jchat_exceptions','jchat_icon_error','jchat_tooltip_error',jchat_error_creating_connection,'jchat_exceptions_closer');}
peerConnection.close();peerConnection=null;peerCandidates=new Array();candidatesCounter=0;}
bindContext.caller=false;bindContext.callee=false;promiseResolved=false;resetSounds();resetButtons();resetVideo();resetBandWidth();if(debugLogging){console.log(dataType+' error using signaling channel: '+errorText);}});};this.initializeVideo=function($container,otherPeerIdentifier,otherPeerName,thisPeerName){if(!supportFullWebRTC){showFallback($container);return false;}
remotePeer=otherPeerIdentifier;$tooltipContainer=$container;$container.append('<span id="jchat_wrapper_localvideo"><span class="jchat_video_tab">'+thisPeerName+'</span>'+'<video id="jchat_localvideo" autoplay="autoplay"></video>'+'</span>');$container.append('<span id="jchat_wrapper_remotevideo"><span class="jchat_video_tab">'+otherPeerName+'</span>'+'<video id="jchat_remotevideo" autoplay="autoplay"></video>'+'</span>');$('#jchat_remotevideo').hide();$container.append('<div id="jchat_remotevideo_placeholder"></div>');$container.append('<div class="jchat_webrtc_clearer"/>');$container.append('<div id="jchat_start_accept_call"><span class="jchat_webrtc_icons jchat_call_icon"/><span class="text">'+jchat_start_call+'</span></div>');$container.append('<div id="jchat_end_call"><span class="jchat_webrtc_icons jchat_end_icon"/><span class="text">'+jchat_end_call+'</span></div>');showRTCMessages('jchat_infouser_webrtc top','jchat_icon_ok','jchat_tooltip_innermsg',jchat_grant_cam_access);if(options.showWebRTCStats){$container.append('<div id="jchat_webrtc_bandwidth"><span>'+jchat_webrtc_bandwidth+'0.0 kbits/s</span></div>');}
var controlAudioVolume=options.defaultAudioVolume*100;var controlMicVolume=options.defaultMicVolume*100;$container.append('<div id="jchat_webrtc_volume"><input class="jchat_slider" type="range" min="0" max="100" step="10" value="'+controlAudioVolume+'"/></div>');$container.append('<div id="jchat_webrtc_mic"><input class="jchat_slider" type="range" min="0" max="100" step="10" value="'+controlMicVolume+'"/></div>');$container.append('<canvas id="mic_vumeter"></canvas>');var getSwitcherCode=function(id){return'<div class="jchat_onoffswitch '+id+'">'+'<input type="checkbox" name="jchat_onoffswitch" class="jchat_onoffswitch-checkbox" id="'+id+'" checked>'+'<label class="jchat_onoffswitch-label" for="'+id+'">'+'<span class="jchat_onoffswitch-inner"></span>'+'<span class="jchat_onoffswitch-switch"></span>'+'</label>'+'</div>';}
$container.append(getSwitcherCode('jchat_webrtc_video'));$container.append(webCamConstraintsSelect);$('#jchat_webrtc_camquality').wrap($('<div id="jchat_quality_cam" class="jchat_quality_cam"></div>'));$('#jchat_quality_cam').prepend('<span>'+jchat_webcam_quality+'</span>');if($.jStorage.get('jchat_webrtc_volume',false)){var currentVideoVolume=$.jStorage.get('jchat_webrtc_volume');$('#jchat_remotevideo').get(0).volume=currentVideoVolume;$('#jchat_webrtc_volume input',$container).val(currentVideoVolume*100);}else{$('#jchat_remotevideo').get(0).volume=options.defaultAudioVolume;}
if($.jStorage.get('jchat_webrtc_mic')!==null){var currentMicVolume=$.jStorage.get('jchat_webrtc_mic');if(window.AudioContext){gainFilterNode.gain.value=currentMicVolume;}
$('#jchat_webrtc_mic input',$container).val(currentMicVolume*100);}else{if(window.AudioContext){gainFilterNode.gain.value=options.defaultMicVolume;}}
$('#jchat_webrtc_video',$container).prop('checked',!!thispeerVideoCamState);if(!thispeerVideoCamState&&options.hideWebcamWhenDisabled){if(options.hideWebcamWhenDisabled==2){$('#jchat_wrapper_localvideo').hide();}else{$('#jchat_localvideo').after('<div id="jchat_localvideo_placeholder"></div>');}
$('#jchat_localvideo').hide();}
$('#jchat_start_accept_call, #jchat_end_call',$tooltipContainer).addClass('jchat_disabled');registerEvents.call(this);var initMediaDevicesPromise=$.Deferred(function(promise){checkDevices(promise);}).promise();initMediaDevicesPromise.then(function(devices){var videoConstraints=(webCamQuality===true)?true:webCamConstraints[webCamQuality];if(!devices.hasWebcam){videoConstraints=false;$('#jchat_localvideo').attr('poster',jchat_livesite+'components/com_jchat/images/default/placeholder.png');$('#jchat_webrtc_video').prop('checked',false).off('.jchatwebrtc').next().attr('for',null);showRTCMessages('jchat_top_exceptions','jchat_icon_error','jchat_tooltip_error',jchat_nowebcam_detected);}
try{navigator.mediaDevices.getUserMedia({'audio':true,'video':videoConstraints}).then(gotVideoStream,function(mediaStreamException){$('#jchat_localvideo').attr('poster',jchat_livesite+'components/com_jchat/images/default/placeholder.png');var userError=mediaStreamException=='HARDWARE_UNAVAILABLE'?jchat_hardware_unavailable:jchat_mediastream_error;showRTCMessages('jchat_top_exceptions','jchat_icon_error','jchat_tooltip_error',userError);if(debugLogging){console.log('Error during video stream starting, resolution not supported? - '+mediaStreamException);}});}catch(e){showRTCMessages('jchat_top_exceptions','jchat_icon_error','jchat_tooltip_error',jchat_requires_https);};},function(errorText,error){if(debugLogging){console.log('Error initialized app and local video: '+errorText);}});if(debugLogging){console.log('Initialized app and local video');}
return true;};var resetButtons=function(skipCamQuality){$('#jchat_start_accept_call span.text',$tooltipContainer).text(jchat_start_call);$('#jchat_end_call span.text',$tooltipContainer).text(jchat_end_call);$('#jchat_start_accept_call',$tooltipContainer).removeClass('jchat_ringing jchat_disabled');$('#jchat_end_call',$tooltipContainer).addClass('jchat_disabled');if(!skipCamQuality){$('#jchat_webrtc_camquality').removeAttr('disabled');}
if(ringingInterval){clearInterval(ringingInterval);ringingInterval=null;}};var resetSounds=function(){JChatNotifications.playRingingWebrtcCall(true,options.ringingTone);JChatNotifications.playWaitingWebrtcAnswer(true);JChatNotifications.playStartWebrtcCall(true);if(typeof startCallTimeout=='number'){clearTimeout(startCallTimeout);}};var resetVideo=function(){$('#jchat_remotevideo_placeholder').show();$('#jchat_remotevideo').hide();$('#jchat_wrapper_remotevideo').removeClass('active');};var resetBandWidth=function(){bandwidthSentBytes=0;$('#jchat_webrtc_bandwidth').html('<span>'+jchat_webrtc_bandwidth+'0.0 kbits/s</span>');if(bandwidthInterval){clearTimeout(bandwidthInterval);}};var resetTooltips=function(){if($('#jchat_trigger_webrtc_tooltip').length){$('#jchat_trigger_webrtc_tooltip').remove();$('.jchat_trigger_webrtc ').removeClass('jchat_webrtc_disabled');}};var gainMicControl=function(){if(window.AudioContext&&localGotStream.getAudioTracks()[0]){var audioStreamSourceNode=streamAudioContext.createMediaStreamSource(localGotStream);var audioStreamDestinationNode=streamAudioContext.createMediaStreamDestination();audioStreamSourceNode.connect(gainFilterNode);gainFilterNode.connect(audioStreamDestinationNode);localGotStream.addTrack(audioStreamDestinationNode.stream.getAudioTracks()[0]);localGotStream.removeTrack(localGotStream.getAudioTracks()[0]);}};var micVUMeter=function(){if(!localGotStream.getAudioTracks()[0]){return;}
var microphoneStreamNode=streamAudioContext.createMediaStreamSource(localGotStream);var analyserNode=streamAudioContext.createAnalyser();window.jchatWebrtcScriptNode=streamAudioContext.createScriptProcessor(2048,1,1);analyserNode.smoothingTimeConstant=0.3;analyserNode.fftSize=1024;microphoneStreamNode.connect(analyserNode);analyserNode.connect(jchatWebrtcScriptNode);jchatWebrtcScriptNode.connect(streamAudioContext.destination);var canvas=$("#mic_vumeter").get(0);var canvasContext=$("#mic_vumeter")[0].getContext("2d");canvas.width=30;canvas.height=60;jchatWebrtcScriptNode.onaudioprocess=function(){var array=new Uint8Array(analyserNode.frequencyBinCount);analyserNode.getByteFrequencyData(array);var values=0;var length=array.length;for(var i=0;i<length;i++){values+=array[i];}
var average=values / length;var color='#00ff00';if(average<=50){color='#00ff00';}
if(average>50&&average<=70){color='#ff9900';}
if(average>70){color='#ff0000';}
canvasContext.clearRect(0,0,60,180);canvasContext.fillStyle=color;canvasContext.fillRect(0,58-average,15,180);}};var showRTCMessages=function(containerClass,iconClass,innerClass,translationText,hasClose){if(!$tooltipContainer){return;}
var closer='';if(hasClose){closer='<div class="'+hasClose+'"></div>';$(document).on('click.jchatwebrtc','div.'+hasClose,function(jqEvent){$('div.'+containerClass).fadeOut(500,function(){$('div.jchat_exceptions').remove();});});if(typeof RTCMessagesTimeout=='number'){clearTimeout(RTCMessagesTimeout);}
RTCMessagesTimeout=setTimeout(function(){$('div.'+hasClose).trigger('click.jchatwebrtc');},8000);}
$('div.jchat_infouser_webrtc, div.jchat_exceptions',$tooltipContainer).remove();$tooltipContainer.append('<div class="'+containerClass+'">'+'<div class=" '+iconClass+'"></div>'+'<div class=" '+innerClass+'">'+translationText+'</div>'+
closer+'</div>');if(debugLogging){console.log(translationText);}};var onSignalingError=function(error){resetButtons();resetSounds();resetBandWidth();showRTCMessages('jchat_exceptions','jchat_icon_error','jchat_tooltip_error',jchat_session_error,'jchat_exceptions_closer');if(debugLogging){console.log('Failed to create signaling message : '+error.name);}};var showFallback=function($container){$container.append('<div class="jchat_webrtc_nosupport">'+jchat_webrtc_nosupport+'</div>');var browsersArray=[{browserName:'chrome',support:'jchat_support_ok',description:jchat_chrome_webrtc_support},{browserName:'firefox',support:'jchat_support_ok',description:jchat_firefox_webrtc_support},{browserName:'opera',support:'jchat_support_ok',description:jchat_opera_webrtc_support},{browserName:'internet-explorer',support:'jchat_support_ko',description:jchat_ie_webrtc_support},{browserName:'safari',support:'jchat_support_ko',description:jchat_safari_webrtc_support}];$.each(browsersArray,function(index,browser){var browserImage='components/com_jchat/images/default/'+browser.browserName+'_48x48.png';$container.append('<div class="jchat_browser_row">'+'<img src="'+jchat_livesite+browserImage+'" alt="browsers"/>'+'<span class="'+browser.support+'">'+browser.description+'</span>'+'</div>');});$container.append('<div class="jchat_webrtc_caniuse">'+jchat_webrtc_caniuse+'</div>');};function getStats(peerConnection){if(peerConnection.iceConnectionState=='closed'){clearTimeout(bandwidthInterval);return;}
var callBack=function(results){var bytes=0;if(!bandwidthSentBytes){bandwidthSentBytes=0;}
for(var i=0;i<results.length;++i){var res=results[i];if(res.bytesSent){bytes+=parseInt(res.bytesSent);}}
bytes=Math.abs(bandwidthSentBytes-bytes);bandwidthSentBytes+=parseInt(bytes);var bits=(bytes*8);var kilobits=bits / 1000;$('#jchat_webrtc_bandwidth').html('<span>'+jchat_webrtc_bandwidth+kilobits.toFixed(1)+' kbits/s'+'</span>');bandwidthInterval=setTimeout(function(){getStats(peerConnection);},2000);}
if(!!navigator.mozGetUserMedia){if(peerConnection.iceConnectionState!='closed'){peerConnection.getStats(peerConnection.getRemoteStreams()[0].getVideoTracks()[0],function(res){var items=[];res.forEach(function(result){items.push(result);});callBack(items);},function(){});}}else{peerConnection.getStats(function(res){var items=[];res.result().forEach(function(result){var item={};result.names().forEach(function(name){item[name]=result.stat(name);});item.id=result.id;item.type=result.type;item.timestamp=result.timestamp;items.push(item);});callBack(items);});}};function checkDevices(promise){var detectedDevices={};if(!MediaStreamTrack.getSources){MediaStreamTrack.getSources=MediaStreamTrack.getMediaDevices;}
if(!MediaStreamTrack.getSources){detectedDevices={hasMicrophone:true,hasWebcam:true}
promise.resolve(detectedDevices);if(debugLogging){console.log('No detection for audio/video devices is supported');}
return;}
if(navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices){navigator.mediaDevices.enumerateDevices().then(function(devices){var result={};devices.forEach(function(device){result[device.kind]=true;});detectedDevices.hasMicrophone=!!result.audioinput;detectedDevices.hasWebcam=!!result.videoinput;promise.resolve(detectedDevices);if(debugLogging){console.log('Detected audio/video devices: '+JSON.stringify(detectedDevices));}}).catch(function(err){});}else{MediaStreamTrack.getSources(function(sources){var result={};for(var i=0;i<sources.length;i++){result[sources[i].kind]=true;}
detectedDevices.hasMicrophone=!!result.audio;detectedDevices.hasWebcam=!!result.video;promise.resolve(detectedDevices);if(debugLogging){console.log('Detected audio/video devices: '+JSON.stringify(detectedDevices));}});}};function detectConnectionBandwidth(){if(!options.autoQualityBandwidthMgmt){return;}
if($.jStorage.get('jchat_webrtc_videocam_quality')){return;}
if(!"performance"in window||typeof(window.performance)==='undefined'){return;}
if(!"timing"in window.performance){return;}
var loadTimeSecs=(window.performance.timing.responseEnd-window.performance.timing.navigationStart)/ 1000;$.each(webCamConstraints,function(resolution,constraint){if(resolution=='Auto'){return true;}
var bandwidthInterval=connectionSpeedConstraints[resolution];if(loadTimeSecs>=bandwidthInterval.minValue&&loadTimeSecs<bandwidthInterval.maxValue){webCamConstraintsSelect.val(resolution);webCamQuality=resolution;return false;}});};this.setListeningData=function(data,realtimeOptions){if(!supportFullWebRTC){if(debugLogging){console.log('No WebRTC support detected for this device browser');}
return false;}
callStatus=data.call_status;if(data.sdp&&data.icecandidate){receivedSdpMessage=data.sdp;receivedICECandidates=data.icecandidate;if(!this.caller){this.callee=true;JChatNotifications.playRingingWebrtcCall(false,options.ringingTone);if(!realtimeOptions.tabFocused){$('title').text(jchat_newvideocall_tab);}
if($('div.jchat_webrtctooltip[data-peerid='+data.peer1+']').length){this.setCalleeRingingButton();}else{$('div[id!=jchat_user_'+data.peer1+'_popup].jchat_tabpopup.jchat_tabopen .jchat_trigger_webrtc.toggle_on').trigger('click');$('div[id!=jchat_user_'+data.peer1+'_popup].jchat_tabpopup.jchat_tabopen .jchat_trigger_webrtc').addClass('jchat_webrtc_disabled');$('#jchat_userlist_'+data.peer1).trigger('click');$('.jchat_trigger_webrtc','#jchat_user_'+data.peer1+'_popup').trigger('mouseover');$('div[id^=jchat_user_][id!=jchat_user_'+data.peer1+'_popup]').css('z-index',10002);$('div[id=jchat_user_'+data.peer1+'_popup], #jchat_trigger_webrtc_tooltip').css('z-index',10005);}
$('#jchat_webrtc_camquality').attr('disabled',true);if(debugLogging){console.log('New incoming call arrived');}}else{$('#jchat_start_accept_call',$tooltipContainer).removeClass('jchat_ringing').addClass('jchat_disabled');if(ringingInterval){clearInterval(ringingInterval);ringingInterval=null;}
resetSounds();acceptCall.call(this);showRTCMessages('jchat_infouser_webrtc','jchat_icon_ok','jchat_tooltip_innermsg',jchat_call_starting,'jchat_info_closer');if(debugLogging){console.log('Exchanged SDP/ICE and call started between 2 peer');}}}else{if(debugLogging){console.log('No SDP/ICE data received through signaling channel');}}
if(data.videocam!==undefined){if(otherpeerVideoCamState!=parseInt(data.videocam)){if(data.videocam==1){$('#jchat_remotevideo_placeholder').hide();$('#jchat_remotevideo').show();}else{$('#jchat_remotevideo_placeholder').show();$('#jchat_remotevideo').hide();}
$('#jchat_wrapper_remotevideo').toggleClass('active');}
otherpeerVideoCamState=parseInt(data.videocam);}
if(promiseResolved&&this.caller&&!data.caller_peer_state){resetButtons();resetBandWidth();resetSounds();JChatNotifications.playEndWebrtcCall();resetVideo();resetTooltips();this.caller=false;promiseResolved=false;if(peerConnection){peerConnection.close();peerConnection=null;peerCandidates=new Array();candidatesCounter=0;}
showRTCMessages('jchat_infouser_webrtc','jchat_icon_ok','jchat_tooltip_innermsg',jchat_connection_closed,'jchat_info_closer');durationTimer(0);if(debugLogging){console.log('Connection closed from callee');}}
if(this.callee&&!callStatus){resetButtons();resetBandWidth();resetSounds();JChatNotifications.playEndWebrtcCall();resetVideo();resetTooltips();this.callee=false;promiseResolved=false;if(!realtimeOptions.tabFocused){$('title').text(realtimeOptions.tabTitle);}
if(peerConnection){peerConnection.close();peerConnection=null;peerCandidates=new Array();candidatesCounter=0;}
showRTCMessages('jchat_infouser_webrtc','jchat_icon_ok','jchat_tooltip_innermsg',jchat_connection_closed,'jchat_info_closer');durationTimer(0);if(debugLogging){console.log('Connection closed from caller');}}};this.setCallerRingingButton=function(){if(!$tooltipContainer){return;}
$('#jchat_start_accept_call',$tooltipContainer).toggleClass('jchat_ringing');$('#jchat_end_call').removeClass('jchat_disabled');if(ringingInterval){clearInterval(ringingInterval);}
ringingInterval=setInterval(function(){$('#jchat_start_accept_call',$tooltipContainer).toggleClass('jchat_ringing');},500);};this.setCalleeRingingButton=function(){if(!$tooltipContainer){return;}
$('#jchat_webrtc_camquality').attr('disabled',true);$('#jchat_start_accept_call span.text',$tooltipContainer).text(jchat_accept_call);$('#jchat_end_call span.text',$tooltipContainer).text(jchat_decline_call);$('#jchat_end_call',$tooltipContainer).removeClass('jchat_disabled');if(ringingInterval){clearInterval(ringingInterval);}
ringingInterval=setInterval(function(){$('#jchat_start_accept_call',$tooltipContainer).toggleClass('jchat_ringing');},500);showRTCMessages('jchat_infouser_webrtc','jchat_icon_ok','jchat_tooltip_innermsg',jchat_incoming_started,'jchat_info_closer');};this.flushMedias=function(){try{if(localGotStream&&navigator.mozGetUserMedia){var localStreamVideoTrack=localGotStream.getVideoTracks()[0];if(localStreamVideoTrack){localStreamVideoTrack.stop();}
if(debugLogging){console.log('Devices closed');}}}catch(exception){if(debugLogging){console.log('Error closing devices: '+exception.message);}}};this.getLocalStream=function(){return localGotStream;};this.showInnerMessage=function(message){showRTCMessages('jchat_infouser_webrtc','jchat_icon_ok','jchat_tooltip_innermsg',message,'jchat_info_closer');};(function __construct(){servers={"iceServers":options.iceServers}
if(window.AudioContext){streamAudioContext=new AudioContext();gainFilterNode=streamAudioContext.createGain();}
var isFirefox=false;if(navigator.mozGetUserMedia){window.RTCSessionDescription=window.RTCSessionDescription||window.mozRTCSessionDescription;window.RTCIceCandidate=window.RTCIceCandidate||window.mozRTCIceCandidate;isFirefox=true;}
debugLogging=options.debugEnabled;jsonLiveSite=options.jsonLiveSite;window.AudioContext=window.AudioContext||window.webkitAudioContext;thispeerVideoCamState=$.jStorage.get('jchat_webrtc_videocam',1);webCamQuality=$.jStorage.get('jchat_webrtc_videocam_quality',true);JChatNotifications.setAudioStatus(options.audiostatus);if(isFirefox){webCamConstraints=webCamNewConstraints;}
$.each(webCamConstraints,function(resolution,constraint){var selected=(webCamQuality==resolution)?'selected':'';var option=$('<option '+selected+' value="'+resolution+'">'+resolution+'</option>');webCamConstraintsSelect.append(option);});supportFullWebRTC=!!navigator.mediaDevices&&!!window.RTCPeerConnection;detectConnectionBandwidth();}).call(this);}
window.JChatWebrtc=Webrtc;})(jQuery);