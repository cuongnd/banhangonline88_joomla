<?php/** * @package    HikaShop for Joomla! * @version    2.6.3 * @author    hikashop.com * @copyright    (C) 2010-2016 HIKARI SOFTWARE. All rights reserved. * @license    GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html */defined('_JEXEC') or die('Restricted access');?><?phpclass CategoryController extends hikashopController{    var $type = 'category';    var $pkey = 'category_id';    var $table = 'category';    var $groupMap = 'category_parent_id';    var $orderingMap = 'category_ordering';    var $groupVal = 0;    function __construct()    {        parent::__construct();        $this->display[] = 'selectstatus';        $this->display[] = 'getTree';        $this->display[] = 'findList';        $this->display[] = 'auto_get_alias';        $this->display[] = 'vatgia_import_product';        $this->display[] = 'getproductsvatgia';        $this->display[] = 'importproductvatgia';        $this->modify_views[] = 'edit_translation';        $this->modify[] = 'save_translation';        $this->modify[] = 'rebuild';        $this->modify_views[] = 'selectparentlisting';    }    function edit_translation()    {        JRequest::setVar('layout', 'edit_translation');        return parent::display();    }    function save_translation()    {        $category_id = hikashop_getCID('category_id');        $class = hikashop_get('class.category');        $element = $class->get($category_id);        if (!empty($element->category_id)) {            $class = hikashop_get('helper.translation');            $class->getTranslations($element);            $class->handleTranslations('category', $element->category_id, $element);        }        $document = JFactory::getDocument();        $document->addScriptDeclaration('window.top.hikashop.closeBox();');    }    public function importproductvatgia()    {        $app=JFactory::getApplication();        $vatgia_category_id=$app->input->getInt('vatgia_category_id');        $link_product='http://www.vatgia.com'.($app->input->getString('link_product',''));        $data=JUtility::getCurl($link_product);        $response=new stdClass();        $html_content='';        $price=0;        $name='';        if(strlen($data)>100)        {            //parse products            require_once JPATH_ROOT.'/libraries/simplehtmldom_1_5/simple_html_dom.php';            $html = str_get_html($data);            $html_content=$html->find('div#detail_product_exclusive_main .content')[0];            $price=$html->find('div#detail_product_price .product_price')[0];            $price=$price->innertext;            $price=str_replace('.','',$price);            if($price=='')            {                $price=$html->find('div#detail_product_price .price_promotion')[0];                $price=$price->innertext;                $price=str_replace('.','',$price);            }            $src_image=$html->find('div#detail_product_picture_main h2 img')[0];            $src_image=$src_image->src;            $name=$html->find('h1#detail_product_name')[0];            $name=$name->innertext;            if($html_content==""){                $html_content="no product";            }        }else{            $html_content="no product";        }        $response->html_content=base64_encode($html_content);        $response->price=$price;        $response->name=$name;        $response->link=$link_product;        $response->src_image=base64_encode($src_image);        echo json_encode($response);        die;    }    public function getproductsvatgia()    {        $app=JFactory::getApplication();        $vatgia_category_id=$app->input->getInt('vatgia_category_id');        $category_id=$app->input->getInt('category_id',0);        $class = hikashop_get('class.category');        $category_item = $class->get($category_id,true);        $db=JFactory::getDbo();        $query=$db->getQuery(true);        $query->update('#__hikashop_category')            ->set('vatgia_category_id='.(int)$category_id)            ->where('category_id='.(int)$vatgia_category_id)            ;        $db->setQuery($query)->execute();        $link_get_product="http://www.vatgia.com/$vatgia_category_id,hot/abc.html";        $data=JUtility::getCurl($link_get_product);        $response=new stdClass();        $html='';        if(strlen($data)>100)        {            //parse products            require_once JPATH_ROOT.'/libraries/simplehtmldom_1_5/simple_html_dom.php';            $html = str_get_html($data);            $html=$html->find('div#top_product')[0];            if($html==""){                $html="no product";            }        }else{            $html="no product";        }        $response->html=base64_encode($html);        $response->link=$link_get_product;        echo json_encode($response);        die;    }    function auto_get_alias()    {        $input = JFactory::getApplication()->input;        $post = json_decode(file_get_contents('php://input'));        $title = $post->title;        $title = explode(' ', $title);        $title = array_slice($title, 0, 10);        $title = implode('-', $title);        $title = JString::vn_str_filter($title);        $title = strtolower($title);        echo new JResponseJson($title, null, false, $input->get('ignoreMessages', true, 'bool'));    }    function rebuild()    {        $class = hikashop_get('class.category');        $database = JFactory::getDBO();        $query = 'SELECT category_left,category_right,category_depth,category_id,category_parent_id FROM #__hikashop_category ORDER BY category_left ASC';        $database->setQuery($query);        $root = null;        $categories = $database->loadObjectList();        $class->categories = array();        foreach ($categories as $cat) {            $class->categories[$cat->category_parent_id][] = $cat;            if (empty($cat->category_parent_id)) {                $root = $cat;            }        }        if (!empty($root)) {            $query = 'UPDATE `#__hikashop_category` SET category_parent_id = ' . (int)$root->category_id . ' WHERE category_parent_id = 0 AND category_id != ' . (int)$root->category_id . '';            $database->setQuery($query);            $database->query();        }        $class->rebuildTree($root, 0, 1);        $app = JFactory::getApplication();        $app->enqueueMessage(JText::_('CATEGORY_TREE_REBUILT'));        $this->listing();    }    function orderdown()    {        $this->getGroupVal();        return parent::orderdown();    }    function orderup()    {        $this->getGroupVal();        return parent::orderup();    }    function saveorder()    {        $this->getGroupVal();        return parent::saveorder();    }    function getGroupVal()    {        $app = JFactory::getApplication();        $this->groupVal = $app->getUserStateFromRequest(HIKASHOP_COMPONENT . '.category.filter_id', 'filter_id', 0, 'string');        if (!is_numeric($this->groupVal)) {            $class = hikashop_get('class.category');            $class->getMainElement($this->groupVal);        }    }    function selectparentlisting()    {        JRequest::setVar('layout', 'selectparentlisting');        return parent::display();    }    function vatgia_import_product()    {        JRequest::setVar('layout', 'vatgia_import_product');        return parent::display();    }    function selectstatus()    {        JRequest::setVar('layout', 'selectstatus');        return parent::display();    }    function getTree()    {        while (ob_get_level())            @ob_end_clean();        $category_id = JRequest::getInt('category_id', 0);        $displayFormat = JRequest::getVar('displayFormat', '');        $search = JRequest::getVar('search', null);        $nameboxType = hikashop_get('type.namebox');        $options = array(            'start' => $category_id,            'displayFormat' => $displayFormat        );        $ret = $nameboxType->getValues($search, 'category', $options);        if (!empty($ret)) {            echo json_encode($ret);            exit;        }        echo '[]';        exit;    }    public function findList()    {        $search = JRequest::getVar('search', '');        $start = JRequest::getInt('start', 0);        $type = JRequest::getVar('category_type', '');        $displayFormat = JRequest::getVar('displayFormat', '');        $types = array(            'manufacturer' => 'brand',            'order_status' => 'order_status'        );        if (!isset($types[$type])) {            echo '[]';            exit;        }        $type = $types[$type];        $options = array();        if (!empty($displayFormat))            $options['displayFormat'] = $displayFormat;        if ($start > 0)            $options['page'] = $start;        $nameboxType = hikashop_get('type.namebox');        $elements = $nameboxType->getValues($search, $type, $options);        echo json_encode($elements);        exit;    }}