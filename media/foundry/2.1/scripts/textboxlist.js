(function(){var e=function(e){var t=this,n=function(){var t={BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,ENTER:13,ESCAPE:27,LEFT:37,RIGHT:39,SPACE:32,TAB:9,UP:38};e.require().library("mvc/controller").done(function(){e.template("textboxlist/item",'<li class="TextboxList-item"><span class="TextboxList-itemContent"><@== html @></span><a class="TextboxList-itemRemoveButton" href="javascript: void(0);"></a></li>'),e.template("textboxlist/itemContent",'<@= title @><input type="hidden" name="items" value="<@= id @>"/>'),e.Controller("TextboxList",{isPlugin:!0,pluginName:"textboxlist",defaultOptions:{view:{item:"textboxlist/item",itemContent:"textboxlist/itemContent"},autocomplete:null,unique:!0,caseSensitive:!1,max:null,filter:null,"{item}":".TextboxList-item","{itemRemoveButton}":".TextboxList-itemRemoveButton","{itemContent}":".TextboxList-itemContent","{textField}":".TextboxList-textField"},implement:function(e){if(e.controller(TextboxList))return;e.implement(TextboxList,{},function(){this.click()})}},function(n){return{init:function(){n.item().each(function(){var t=e(this),r=t.find(n.itemContent.selector);n.createItem({id:t.data("id")||function(){var n=e.uid("item-");return t.data("id",n),n}(),title:t.data("title")||e.trim(r.text()),html:r.html()})});var t=n.options.autocomplete;(t||n.element.data("query"))&&e.module("textboxlist/autocomplete").done(function(){n.element.implement(TextboxList.Autocomplete,e.extend({controller:{textboxList:n}},t||{}))})},items:{},itemsByTitle:{},getItemKey:function(e){return n.options.caseSensitive?e:e.toLowerCase()},filterItem:function(t){var r=n.options,i=r.filterItem;e.isFunction(i)&&(t=i.call(n,t));var s=n.itemsByTitle,o=!1;if(e._.isString(t)&&t!==""){var u=t,a=n.getItemKey(u);t=s.hasOwnProperty(a)?n.itemsByTitle[a]:function(){var t={id:e.uid("item-"),title:u,key:n.getItemKey(u)};return o=!0,t}()}return t.html===undefined&&(t.html=n.view.itemContent(!0,t)),r.unique&&(n.items.hasOwnProperty(t.id)||o&&s.hasOwnProperty[t.key])?null:t},createItem:function(e){e.key=n.getItemKey(e.title),n.items[e.id]=e,n.itemsByTitle[e.key]=e},deleteItem:function(e){var t=n.items[e];delete n.items[e];var r=n.options.caseSensitive?t.title:t.title.toLowerCase();delete n.itemsByTitle[r]},addItem:function(t){if(t==="")return;var r=n.options,i=r.max;if(i===null||n.item().length<i){t=n.filterItem(t);if(!e.isPlainObject(t))return;return n.createItem(t),n.view.item(t).attr("data-id",t.id).insertBefore(n.textField()),t}return},removeItem:function(e){n.item("[data-id="+e+"]").remove(),n.deleteItem(e)},click:function(){n.textField().focus()},"{itemRemoveButton} click":function(e){n.removeItem(e.data("id"))},"{textField} keydown":function(r,i){var s=i.keyCode;r.data("realEnterKey",s==t.ENTER);var o=n.options.textFieldKeydown;e.isFunction(o)&&o.call(n,r,i)},"{textField} keypress":function(r,i){var s=r.data("realEnterKey"),o=i.keyCode==t.ENTER;r.data("realEnterKey",s&&o);var u=e.trim(n.textField().val()),a=n.options.textFieldKeypress;e.isFunction(a)&&(u=a.call(n,r,i,u));if(u===undefined||u===null)return;switch(i.keyCode){case t.ENTER:r.data("realEnterKey")&&(n.addItem(u),r.val(""))}},"{textField} keyup":function(r,i){var s=e.trim(n.textField().val()),o=n.options.textFieldKeyup;e.isFunction(o)&&(s=o.call(n,r,i,s));if(s===undefined||s===null)return;var u="canRemoveItemUsingBackspace";switch(i.keyCode){case t.BACKSPACE:if(s==="")if(!n[u])n[u]=!0;else{var a=r.prev(n.item.selector);a.length>0&&n.removeItem(a.data("id"))}break;default:n[u]=!1}}}}),e(document).on("click.textboxlist.data-api",'[data-provide="textboxlist"]',function(t){TextboxList.implement(e(this))}).on("focus.textboxlist.data-api",'[data-provide="textboxlist"] .TextboxList-textField',function(t){TextboxList.implement(e(this).parents(".TextboxList"))})}),e.module("textboxlist/autocomplete",function(){var n=this;e.require().library("mvc/controller","ui/position").done(function(){e.template("textboxlist/menu",'<div class="TextboxList-autocomplete"><div class="inner"><ul class="TextboxList-menu"></ul></div></div>'),e.template("textboxlist/menuItem",'<li class="TextboxList-menuItem"><@== html @></li>'),e.Controller("TextboxList.Autocomplete",{defaultOptions:{view:{menu:"textboxlist/menu",menuItem:"textboxlist/menuItem"},minLength:1,limit:10,highlight:!0,caseSensitive:!1,exclusive:!1,query:null,position:{my:"left top",at:"left bottom",collision:"none"},filterItem:null,"{menu}":".TextboxList-menu","{menuItem}":".TextboxList-menuItem"}},function(n){return{init:function(){if(!n.element.data(n.Class.fullName)){n.destroy(),n.view.menu().appendTo("body").data(n.Class.fullName,!0).implement(TextboxList.Autocomplete,n.options);return}n.textboxList.update({textFieldKeypress:n.textFieldKeypress,textFieldKeyup:n.textFieldKeyup}),n.options.position.of=n.textboxList.element,n.initQuery()},initQuery:function(){var t=n.options.query||n.textboxList.element.data("query");if(e.isUrl(t)){var r=t;n.query=function(t){return e.ajax(r+t)};return}if(e.isFunction(t)){var i=t;n.query=function(e){return i.call(n,e)};return}if(e.isArray(t)){var s=t;n.query=function(t){var n=e.Deferred(),t=t.toLowerCase();return setTimeout(function(){var r=e.grep(s,function(e){return e.title.toLowerCase().indexOf(t)>-1});n.resolve(r)},0),n};return}},show:function(){var e=n.textboxList.element;n.element.show().css({width:e.outerWidth()}).position(n.options.position),n.hidden=!1},hide:function(){n.element.hide(),n.menuItem().removeClass("active"),n.render.reset(),n.hidden=!0},queries:{},populated:!1,populate:function(t){n.populated=!1;var r=n.options,i=r.caseSensitive?t:t.toLowerCase(),s=n.queries[i],o=!e.isDeferred(s),u=function(){if(o||!o&&s.state()=="rejected")s=n.queries[i]=n.query(t);s.done(n.render(function(e){return[e,t]})).fail(function(){n.hide()})};o?(clearTimeout(n.queryTask),n.queryTask=setTimeout(u,250)):u()},render:e.Enqueue(function(t,r){if(!e.isArray(t))return;if(t.length<1){n.hide();return}var i=n.menu();i.data("keyword")!==r&&(i.empty(),e.each(t,function(t,s){var o=n.options.filterItem;e.isFunction(o)&&(s=o.call(n,s,r));if(!e.isPlainObject(s))return;var u=s.menuHtml||s.title;n.view.menuItem({html:u}).data("item",s).appendTo(i)}),i.data("keyword",r)),n.show()}),getActiveMenuItem:function(){var e=n.menuItem(".active");return e.length<1&&(e=undefined),e},textFieldKeypress:function(e,r,i){var s=n.options.exclusive;if(n.hidden)return s?null:i;var o=n.getActiveMenuItem();switch(r.keyCode){case t.UP:n.menuItem().removeClass("active"),o?o.prev(n.menuItem.selector).addClass("active"):n.menuItem(":last").addClass("active");break;case t.DOWN:n.menuItem().removeClass("active"),o?o.next(n.menuItem.selector).addClass("active"):n.menuItem(":first").addClass("active");break;case t.ENTER:var o=n.getActiveMenuItem();n.hide();if(o){var u=o.data("item");return u}if(s)return null;break;case t.ESCAPE:n.hide()}return s?null:i},textFieldKeyup:function(e,r,i){var s=n.options.exclusive;switch(r.keyCode){case t.UP:case t.DOWN:case t.ENTER:case t.ESCAPE:break;default:i===""||i.length<n.options.minLength?n.hide():n.populate(i)}return s?null:i},"{menuItem} click":function(e){n.hide();var t=e.data("item");n.textboxList.addItem(t);var r=n.textboxList.textField().val("");setTimeout(function(){r.focus()},150)}}}),n.resolve(TextboxList.Autocomplete)})})};n(),t.resolveWith(n)};dispatch("textboxlist").containing(e).to("Foundry/2.1 Modules")})();