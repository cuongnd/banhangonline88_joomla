(function(){var e=function(e){var t=this;e.require().script("mvc/lang.vector","mvc/event.livehack").done(function(){var n=function(){var t=function(t,n){var r=Array.prototype.slice.call(arguments,2);return function(){var i=[this].concat(r,e.makeArray(arguments));return n.apply(t,i)}},n=e.event,r=window.getSelection?function(){window.getSelection().removeAllRanges()}:function(){};e.Drag=function(){},e.extend(e.Drag,{lowerName:"drag",current:null,distance:0,mousedown:function(t,r){var i=t.button===0||t.button==1;if(!i||this.current)return;var s=new e.Drag,o=t.delegateTarget||r,u=t.handleObj.selector,a=this;this.current=s,s.setup({element:r,delegate:t.delegateTarget||r,selector:t.handleObj.selector,moved:!1,_distance:this.distance,callbacks:{dragdown:n.find(o,["dragdown"],u),draginit:n.find(o,["draginit"],u),dragover:n.find(o,["dragover"],u),dragmove:n.find(o,["dragmove"],u),dragout:n.find(o,["dragout"],u),dragend:n.find(o,["dragend"],u)},destroyed:function(){a.current=null}},t)}}),e.extend(e.Drag.prototype,{setup:function(n,i){e.extend(this,n),this.element=e(this.element),this.event=i,this.moved=!1,this.allowOtherDrags=!1;var s=t(this,this.mousemove),o=t(this,this.mouseup);this._mousemove=s,this._mouseup=o,this._distance=n.distance?n.distance:0,this.mouseStartPosition=i.vector(),e(document).bind("mousemove",s),e(document).bind("mouseup",o),this.callEvents("down",this.element,i)||(this.noSelection(this.delegate),r())},destroy:function(){e(document).unbind("mousemove",this._mousemove),e(document).unbind("mouseup",this._mouseup),this.moved||(this.event=this.element=null),this.selection(this.delegate),this.destroyed()},mousemove:function(e,t){if(!this.moved){var n=Math.sqrt(Math.pow(t.pageX-this.event.pageX,2)+Math.pow(t.pageY-this.event.pageY,2));if(n<this._distance)return!1;this.init(this.element,t),this.moved=!0}var r=t.vector();if(this._start_position&&this._start_position.equals(r))return;this.draw(r,t)},mouseup:function(e,t){this.moved&&this.end(t),this.destroy()},noSelection:function(t){t=t||this.delegate,document.documentElement.onselectstart=function(){return!1},document.documentElement.unselectable="on",this.selectionDisabled=this.selectionDisabled?this.selectionDisabled.add(t):e(t),this.selectionDisabled.css("-moz-user-select","-moz-none")},selection:function(e){this.selectionDisabled&&(document.documentElement.onselectstart=function(){},document.documentElement.unselectable="off",this.selectionDisabled.css("-moz-user-select",""))},init:function(t,n){t=e(t);var r=this.movingElement=this.element=e(t);this._cancelled=!1,this.event=n,this.mouseElementPosition=this.mouseStartPosition.minus(this.element.offsetv()),this.callEvents("init",t,n);if(this._cancelled===!0)return;this.startPosition=r!=this.movingElement?this.movingElement.offsetv():this.currentDelta(),this.makePositioned(this.movingElement),this.oldZIndex=this.movingElement.css("zIndex"),this.movingElement.css("zIndex",1e3),!this._only&&this.constructor.responder&&this.constructor.responder.compile(n,this)},makePositioned:function(e){var t,n=e.css("position");if(!n||n=="static")t={position:"relative"},window.opera&&(t.top="0px",t.left="0px"),e.css(t)},callEvents:function(e,t,n,r){var i,s=this.callbacks[this.constructor.lowerName+e];for(i=0;i<s.length;i++)s[i].call(t,n,this,r);return s.length},currentDelta:function(){return new e.Vector(parseInt(this.movingElement.css("left"),10)||0,parseInt(this.movingElement.css("top"),10)||0)},draw:function(e,t){if(this._cancelled)return;r(),this.location=e.minus(this.mouseElementPosition),this.move(t);if(this._cancelled)return;t.isDefaultPrevented()||this.position(this.location),!this._only&&this.constructor.responder&&this.constructor.responder.show(e,this,t)},position:function(e){var t,n=this.currentDelta(),r=this.movingElement.offsetv().minus(n);this.required_css_position=e.minus(r),this.offsetv=e,t=this.movingElement[0].style,!this._cancelled&&!this._horizontal&&(t.top=this.required_css_position.top()+"px"),!this._cancelled&&!this._vertical&&(t.left=this.required_css_position.left()+"px")},move:function(e){this.callEvents("move",this.element,e)},over:function(e,t){this.callEvents("over",this.element,e,t)},out:function(e,t){this.callEvents("out",this.element,e,t)},end:function(e){if(this._cancelled)return;!this._only&&this.constructor.responder&&this.constructor.responder.end(e,this),this.callEvents("end",this.element,e);if(this._revert){var t=this;this.movingElement.animate({top:this.startPosition.top()+"px",left:this.startPosition.left()+"px"},function(){t.cleanup.apply(t,arguments)})}else this.cleanup();this.event=null},cleanup:function(){this.movingElement.css({zIndex:this.oldZIndex}),this.movingElement[0]!==this.element[0]&&!this.movingElement.has(this.element[0]).length&&!this.element.has(this.movingElement[0]).length&&this.movingElement.css({display:"none"}),this._removeMovingElement&&this.movingElement.remove(),this.movingElement=this.element=this.event=null},cancel:function(){this._cancelled=!0,!this._only&&this.constructor.responder&&this.constructor.responder.clear(this.event.vector(),this,this.event),this.destroy()},ghost:function(t){var n=this.movingElement.clone().css("position","absolute");return(t?e(t):this.movingElement).after(n),n.width(this.movingElement.width()).height(this.movingElement.height()),n.offset(this.movingElement.offset()),this.movingElement=n,this.noSelection(n),this._removeMovingElement=!0,n},representative:function(t,n,r){this._offsetX=n||0,this._offsetY=r||0;var i=this.mouseStartPosition;this.movingElement=e(t),this.movingElement.css({top:i.y()-this._offsetY+"px",left:i.x()-this._offsetX+"px",display:"block",position:"absolute"}).show(),this.noSelection(this.movingElement),this.mouseElementPosition=new e.Vector(this._offsetX,this._offsetY)},revert:function(e){return this._revert=e===undefined?!0:e,this},vertical:function(){return this._vertical=!0,this},horizontal:function(){return this._horizontal=!0,!0},only:function(e){return this._only=e===undefined?!0:e},distance:function(e){return e!==undefined?(this._distance=e,this):this._distance}}),n.setupHelper(["dragdown","draginit","dragover","dragmove","dragout","dragend"],"mousedown",function(t){e.Drag.mousedown.call(e.Drag,t,this)})};n(),t.resolveWith(n)})};dispatch("mvc/event.drag").containing(e).to("Foundry/2.1 Modules")})();