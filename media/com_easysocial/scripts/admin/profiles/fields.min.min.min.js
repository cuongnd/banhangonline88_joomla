EasySocial.module("admin/profiles/fields",function($){var module=this;EasySocial.require().library("ui/draggable","ui/sortable","ui/droppable").script("site/layout/dialog","field").view("admin/profiles/form.fields.editorItem","admin/profiles/form.fields.stepItem","admin/profiles/form.fields.editorPage","admin/profiles/form.fields.config","admin/profiles/dialog.move.field").language("COM_EASYSOCIAL_PROFILES_FORM_FIELDS_ITEM_CONFIG_LOADING","COM_EASYSOCIAL_PROFILES_FORM_FIELDS_DELETE_PAGE_DIALOG_TITLE",
"COM_EASYSOCIAL_PROFILES_FORM_FIELDS_DELETE_PAGE_DIALOG_CONFIRMATION","COM_EASYSOCIAL_PROFILES_FORM_FIELDS_DELETE_PAGE_DIALOG_CONFIRM","COM_EASYSOCIAL_PROFILES_FORM_FIELDS_DELETE_PAGE_DIALOG_CANCEL","COM_EASYSOCIAL_PROFILES_FORM_FIELDS_DELETE_PAGE_DIALOG_DELETING","COM_EASYSOCIAL_PROFILES_FORM_FIELDS_DELETE_ITEM_DIALOG_TITLE","COM_EASYSOCIAL_PROFILES_FORM_FIELDS_DELETE_ITEM_DIALOG_CONFIRMATION","COM_EASYSOCIAL_PROFILES_FORM_FIELDS_DELETE_ITEM_DIALOG_CONFIRM","COM_EASYSOCIAL_PROFILES_FORM_FIELDS_DELETE_ITEM_DIALOG_CANCEL",
"COM_EASYSOCIAL_PROFILES_FORM_FIELDS_DELETE_ITEM_DIALOG_DELETING","COM_EASYSOCIAL_PROFILES_FORM_FIELDS_PARAMS_CORE_UNIQUE_KEY_SAVE_FIRST","COM_EASYSOCIAL_PROFILES_FORM_FIELDS_CONFIGURE_PAGE","COM_EASYSOCIAL_PROFILES_FORM_FIELDS_CONFIGURE_FIELD","COM_EASYSOCIAL_FIELDS_REQUIRE_MANDATORY_FIELDS","COM_EASYSOCIAL_FIELDS_UNSAVED_CHANGES","COM_EASYSOCIAL_FIELDS_INVALID_VALUES").done(function(){var $Parent,$Browser,$Editor,$Steps,$Config;var $Apps={},$Core={},$Check={},$Fields={},$Pages={};var $Deleted={pages:[],
fields:[]};EasySocial.Controller("Fields",{defaultOptions:{id:0,group:null,"{wrap}":"[data-fields-wrap]","{browser}":"[data-fields-browser]","{editor}":"[data-fields-editor]","{steps}":"[data-fields-steps]","{config}":"[data-fields-config]","{saveForm}":"[data-fields-save]",view:{config:"admin/profiles/form.fields.config"}}},function(self){return{init:function(){$Parent=self;self.options.id=self.element.data("id");$Browser=self.addPlugin("browser");$Editor=self.addPlugin("editor");$Steps=self.addPlugin("steps");
var controllers=[$Browser.state,$Editor.state,$Steps.state];$.when.apply(null,controllers).done(function(){$Parent.trigger("controllersReady")});$(".profileForm").on("save",function(ev,task,result){var data=self.save(task);result.push(data)})},changed:false,customFieldChanged:function(){self.changed=true},"{window} beforeunload":function(el,ev){if(self.changed)return $.language("COM_EASYSOCIAL_FIELDS_UNSAVED_CHANGES")},"{saveForm} click":function(){self.save()},save:function(task){var dfd=$.Deferred();
self.element.find("input,select").not(self.saveForm()).prop("disabled",true);self.saveForm().val("");if(task==="savecopy")self.changed=true;if(!self.changed){dfd.resolve();return dfd}$Parent.trigger("saving");if($Config&&$Config.state)if(!$Config.checkConfig()){EasySocial.dialog({content:$.language("COM_EASYSOCIAL_FIELDS_INVALID_VALUES")});dfd.reject();return dfd}$Check=$.extend(true,{},$Core);var data=[];$.each($Steps.step(),function(i,step){step=$(step);var page=$Editor.getPage(step.data("id"));
data.push(page._export())});if($._.keys($Check).length>0){$Parent.trigger("saved",[false]);EasySocial.dialog({content:$.language("COM_EASYSOCIAL_FIELDS_REQUIRE_MANDATORY_FIELDS")});dfd.reject();return dfd}$Parent.changed=false;var saveData={data:data,deleted:$Deleted};self.injectSaveData(saveData);dfd.resolve();return dfd},injectSaveData:function(data){data=JSON.stringify(data);self.saveForm().val(data)},updateResult:function(data){$.each(data,function(i,dataStep){var step=$Steps.step().eq(i);var stepid=
step.data("id");var page=$Editor.getPage(stepid);$Steps.updateResult(i,dataStep.id);page.updateResult(stepid,dataStep)})},"{self} doneConfiguring":function(){self.element.removeClass("editting")},loadConfiguration:function(item,type){self.element.addClass("editting");var config=$(self.view.config());$Config=config.addController("EasySocial.Controller.Fields.Config",{controller:{item:item}});if(type==="page")item.pageHeader().append(config);else item.element.append(config);self.element.trigger("loadingConfig",
[type])}}});EasySocial.Controller("Fields.Browser",{defaultOptions:{"{browser}":"[data-fields-browser]","{mandatory}":"[data-fields-browser-group-mandatory]","{unique}":"[data-fields-browser-group-unique]","{standard}":"[data-fields-browser-group-standard]","{list}":"[data-fields-browser-list]","{item}":"[data-fields-browser-item]","affixClass":"es-browser-affix"}},function(self){return{state:$.Deferred(),init:function(){self.registerApps();self.ready();self.affixHandler();self.initAffix()},ready:function(){self.state.resolve()},
"{parent} controllersReady":function(){var id=$Steps.getCurrentStep().data("id");self.initDraggable(id)},"{parent} pageChanged":function(el,ev,page,uid){self.item().draggable("destroy");self.initDraggable(uid)},"{parent} pageAdded":function(el,ev,page,uid){self.item().draggable("destroy");self.initDraggable(uid)},initDraggable:function(id){self.item().draggable({revert:"invalid",helper:"clone",connectToSortable:"[data-fields-editor-page-items-"+id+"]"})},affixHandler:function(){var parent=$(window),
wrap=self.parent.wrap(),height=wrap.offset().top,scroll=parent.scrollTop();if(scroll>height&&!self.browser().hasClass(self.options.affixClass))self.browser().addClass(self.options.affixClass);if(scroll<=height&&self.browser().hasClass(self.options.affixClass))self.browser().removeClass(self.options.affixClass)},initAffix:function(){$(window).scroll(self.affixHandler)},registerApps:function(){$.each(self.item(),function(index,item){item=$(item);var id=item.data("id");$Apps[id]={id:id,element:item.data("element"),
title:item.data("title"),params:item.data("params"),core:item.data("core"),unique:item.data("unique"),item:item};if(item.data("core"))$Core[id]=$Apps[id]})},checkout:function(id){if($Check[id]!==undefined)delete $Check[id]},"{item} click":function(el){var currentPage=$Editor.currentPage();var appid=el.data("id");currentPage.addNewField(appid)},"{parent} fieldAdded":function(el,event,appid){var app=$Apps[appid];if(app&&app.core){app.item.hide();var items=self.mandatory().find(self.item.selector).filter(":visible");
self.mandatory().toggle(items.length>0)}if(app&&app.unique){app.item.hide();var items=self.unique().find(self.item.selector).filter(":visible");self.unique().toggle(items.length>0)}},"{parent} fieldDeleted":function(el,event,appid,fieldid){var app=$Apps[appid];if(app&&app.core){app.item.show();self.mandatory().show();return}if(app&&app.unique){app.item.show();self.unique().show();return}}}});EasySocial.Controller("Fields.Config",{defaultOptions:{"{config}":"[data-fields-config]","{header}":"[data-fields-config-header]",
"{close}":"[data-fields-config-close]","{form}":"[data-fields-config-form]","{param}":"[data-fields-config-param]","{tabnav}":"[data-fields-config-tab-nav]","{tabcontent}":"[data-fields-config-tab-content]","{done}":"[data-fields-config-done]"}},function(self){return{init:function(){},state:false,load:function(config){self.state=true;config.find("[data-fields-config-param-choices]").addController("EasySocial.Controller.Config.Choices",{controller:{item:self.item}});config.find("h4").hide();self.header().html(config.find("h4").html());
self.form().html(config);if(self.item.options.newfield)self.param("[data-fields-config-param-field-unique_key]").attr("disabled",true).val($.language("COM_EASYSOCIAL_PROFILES_FORM_FIELDS_PARAMS_CORE_UNIQUE_KEY_SAVE_FIRST"));if(self.tabnav().length>0){var coreTab=self.tabnav().find('a[data-tabname="core"]');if(coreTab.length>0)coreTab.tab("show");else self.tabnav().find("a:first").tab("show")}self.populateConfig();var configHeight=self.element.height();$Parent.wrap().css("padding-bottom",configHeight+
"px");$Parent.trigger("configLoaded")},"{close} click":function(el,ev){self.closeConfig()},"{done} click":function(el,ev){self.closeConfig()},closeConfig:function(){var values=self.populateConfig();var state=self.checkConfig(values);if(state){self.item.updateHtml(self.form().html());self.item.content().trigger("onConfigSave",[values]);self.element.remove();$Config=null;$Parent.trigger("doneConfiguring")}else EasySocial.dialog({content:$.language("COM_EASYSOCIAL_PROFILES_FORM_FIELDS_INVALID_VALUES"),
width:400,height:100})},"{parent} loadingConfig":function(el,ev,header){if(header!==undefined&&header!="field"){var headerText=$.language("COM_EASYSOCIAL_PROFILES_FORM_FIELDS_CONFIGURE_"+header.toUpperCase());self.header().html(headerText)}self.config().show();self.close().hide();self.form().html($.language("COM_EASYSOCIAL_PROFILES_FORM_FIELDS_ITEM_CONFIG_LOADING"))},"{parent} configLoaded":function(el,ev){self.close().show()},"{param} change":function(el){self.paramChanged(el)},"{param} keyup":function(el){self.paramChanged(el)},
paramChanged:function(el){var name=el.data("name"),value=self.getConfigValue(name);var field=self.item.appParams[name];if(field.type==="boolean")value=!!value;self.item.fieldItem().trigger("onConfigChange",[name,value]);$Parent.customFieldChanged()},getConfigValue:function(name){var field=self.item.appParams[name],element=self.param().filterBy("name",name);if(element.length===0)return undefined;var values="";switch(field.type){case "choices":values=[];$.each(element.find("li"),function(i,choice){choice=
$(choice);var titleField=choice.find("[data-fields-config-param-choice-title]"),valueField=choice.find("[data-fields-config-param-choice-value]"),defaultField=choice.find("[data-fields-config-param-choice-default]");values.push({"id":choice.data("id"),"title":titleField.val(),"value":valueField.val(),"default":defaultField.val()});titleField.attr("value",titleField.val());valueField.attr("value",valueField.val());defaultField.attr("value",defaultField.val())});break;case "boolean":var tmp=element.val();
values=tmp==="true"||tmp==="1"||tmp===1?1:0;element.attr("value",values);break;case "checkbox":values=[];$.each(field.option,function(k,option){var checkbox=element.filter("[data-fields-config-param-option-"+option.value+"]");if(checkbox.length>0&&checkbox.is(":checked")){values.push(option.value);checkbox.attr("checked","checked")}else checkbox.removeAttr("checked")});break;case "list":case "select":case "dropdown":values=element.length>0?element.val():field["default"]||"";element.find("option").prop("selected",
false);element.find('option[value="'+values+'"]').prop("selected",true);break;case "input":case "text":default:values=element.length>0?element.val():field["default"]||"";element.attr("value",values);break}return values},populateConfig:function(){var data={};$.each(self.item.appParams,function(name,field){var value=self.getConfigValue(name);if(value===undefined)return false;data[name]=value});self.item.trigger("onPopulateConfig",[data]);return data},checkConfig:function(values){if(values===undefined)values=
self.populateConfig();var state=true;$.each(values,function(name,value){var field=self.item.appParams[name];switch(field.type){case "choices":var choiceValues=[];$.each(value,function(i,choice){if($.isEmpty(choice.value)&&!$.isEmpty(choice.title))choice.value=choice.title.toLowerCase().replace(" ","");if(!$.isEmpty(choice.value)&&$.inArray(choice.value,choiceValues)>-1){state=false;return false}choiceValues.push(choice.value)});break}if(state===false)return false});return state},"{parent} fieldDeleted":function(){if(self.state)$Parent.trigger("doneConfiguring")},
"{parent} pageDeleted":function(){if(self.state)$Parent.trigger("doneConfiguring")},"{parent} pageAdded":function(){if(self.state)$Parent.trigger("doneConfiguring")},"{parent} pageChanged":function(){if(self.state)$Parent.trigger("doneConfiguring")}}});EasySocial.Controller("Fields.Steps",{defaultOptions:{"{steps}":"[data-fields-step]","{step}":"[data-fields-step-item]","{stepLink}":"[data-fields-step-item-link]","{add}":"[data-fields-step-add]",view:{stepItem:"admin/profiles/form.fields.stepItem"}}},
function(self){return{state:$.Deferred(),init:function(){self.ready()},ready:function(){self.state.resolve()},"{parent} controllersReady":function(){self.initSort()},initSort:function(){self.steps().sortable({items:self.step.selector,placeholder:"ui-state-highlight",cursor:"move",helper:"clone",forceHelperSize:true,stop:function(){$(".tooltip-es").remove();$Parent.customFieldChanged()}})},"{parent} pageDeleted":function(el,event,uid){self.deleteStep(uid);if($Steps.step().length>0)$Steps.stepLink(":first").tab("show")},
"{step} click":function(el,ev){if(!el.hasClass("active")){var id=el.data("id");$Parent.trigger("pageChanged",[$Editor.getPage(id),id])}},"{add} click":function(){var stepuid=$.uid("step");self.addStep(stepuid);$Editor.addPage(stepuid);self.stepLink(":last").tab("show")},addStep:function(uid){self.add().before(self.view.stepItem({uid:uid}))},getStep:function(uid){return self.step().filterBy("id",uid)},getStepLink:function(uid){return self.stepLink().filterBy("id",uid)},deleteStep:function(uid){self.getStep(uid).remove()},
getCurrentStep:function(){return self.step(".active")},currentStepIndex:function(){return self.step().index(self.step(".active"))+1},updateResult:function(sequence,newid){var step=self.step(":eq("+sequence+")");if(step.data("id")!=newid){var oldid=step.data("id");step.removeAttr("data-fields-step-item-"+oldid);step.attr("data-fields-step-item-"+newid,true);step.data("id",newid);step.attr("data-id",newid);var stepLink=self.stepLink().eq(sequence);stepLink.removeAttr("data-fields-step-item-link-"+oldid);
stepLink.attr("data-fields-step-item-link-"+newid,true);stepLink.attr("href","#formStep_"+newid)}},toObject:function(){var data=[];$.each(self.stepLink(),function(i,step){step=$(step);data.push({uid:step.data("id"),title:step.text(),description:step.attr("data-original-title")})});return data}}});EasySocial.Controller("Fields.Editor",{defaultOptions:{"{editor}":"[data-fields-editor]","{page}":"[data-fields-editor-page]","{items}":"[data-fields-editor-page-items]","{item}":"[data-fields-editor-page-item]",
view:{editorPage:"admin/profiles/form.fields.editorPage"}}},function(self){return{state:$.Deferred(),init:function(){self.ready()},ready:function(){self.state.resolve()},"{parent} controllersReady":function(){self.page().addController("EasySocial.Controller.Fields.Editor.Page")},currentPage:function(){return self.page(".active").controller()},addPage:function(uid){var newPage=self.view.editorPage({uid:uid});newPage.addController("EasySocial.Controller.Fields.Editor.Page",{uid:uid,newpage:true});self.editor().append(newPage);
self.page().trigger("pageAdded",[newPage,uid]);$Parent.customFieldChanged()},getPage:function(uid){return self.page().filterBy("id",uid).controller()},"{parent} saving":function(el,event){self.element.addClass("saving")},"{parent} saved":function(el,event,state){if(state===false);self.element.removeClass("saving")}}});EasySocial.Controller("Fields.Editor.Page",{defaultOptions:{pageid:0,uid:0,newpage:false,"{items}":"[data-fields-editor-page-items]","{item}":"[data-fields-editor-page-item]","{pageHeader}":"[data-fields-editor-page-header]",
"{content}":"[data-fields-editor-page-header]","{fieldItem}":"[data-fields-editor-page-header]","{pageTitle}":"[data-fields-editor-page-title]","{pageDescription}":"[data-fields-editor-page-description]","{inputTitle}":"[data-fields-editor-page-title-input]","{inputDescription}":"[data-fields-editor-page-description-input]","{pageVisibleRegistration}":"[data-fields-editor-page-visible-registration]","{pageVisibleEdit}":"[data-fields-editor-page-visible-edit]","{pageVisibleView}":"[data-fields-editor-page-visible-view]",
"{pageDelete}":"[data-fields-editor-page-delete]","{pageEdit}":"[data-fields-editor-page-edit]","{pageInfo}":"[data-fields-editor-page-info]","{pageInfoDone}":"[data-fields-editor-page-done]",view:{editorItem:"admin/profiles/form.fields.editorItem"}}},function(self){return{init:function(){if(!self.options.newpage)self.options.uid=self.options.pageid=self.element.data("id");self.registerPage();self.item().addController("EasySocial.Controller.Fields.Editor.Item",{pageid:self.options.uid});self.checkPageDeleteButton();
self.initSort()},fields:{},getStep:function(){return $Steps.getStep(self.options.uid)},registerPage:function(){$Pages[self.options.uid]=self},initSort:function(){self.items().sortable({items:self.item.selector,handle:"[data-fields-editor-page-item-handle]",placeholder:"ui-state-highlight",cursor:"move",helper:"clone",forceHelperSize:true,stop:function(event,ui){if(ui.item.is($Browser.item.selector)){var appid=ui.item.data("id");var placeholder=self.createPlaceholder();ui.item.replaceWith(placeholder);
self.createNewField(appid,placeholder)}$Parent.customFieldChanged()}})},addNewField:function(appid){var placeholder=self.createPlaceholder();self.items().append(placeholder);$.scrollTo(placeholder,200);self.createNewField(appid,placeholder);$Parent.customFieldChanged()},createPlaceholder:function(){var uid=$.uid("newfield");var placeholder=self.view.editorItem({uid:uid});return placeholder},createNewField:function(appid,placeholder){$Parent.trigger("fieldAdded",[appid]);self.getFieldHtml(appid).done(function(html){html=
$.parseHTML(html,document,true);html=$(html);placeholder.replaceWith(html);var div=html.filter('[data-appid="'+appid+'"]');div.addController("EasySocial.Controller.Fields.Editor.Item",{controller:{page:self},appid:appid,pageid:self.options.uid,newfield:true})}).fail(function(msg){placeholder.html(msg)})},getFieldHtml:function(appid){var state=$.Deferred();if($Apps[appid].html===undefined)EasySocial.ajax("admin/controllers/fields/renderSample",{appid:appid,profileid:$Parent.options.id,group:$Parent.options.group}).done(function(html){$Apps[appid].html=
html;state.resolve(html)}).fail(function(msg){state.reject(msg)});else state.resolve($Apps[appid].html);return state},"{pageHeader} click":function(el,event){var clickedTarget=$(event.target);if(clickedTarget.not("[data-fields-editor-page-delete]")&&!el.hasClass("editting")){if($Config&&$Config.state){var state=$Config.checkConfig();if(state)$Config.closeConfig();else{EasySocial.dialog({content:$.language("COM_EASYSOCIAL_PROFILES_FORM_FIELDS_INVALID_VALUES"),width:400,height:100});return}}self.loadConfiguration()}},
loadConfiguration:function(){$Parent.loadConfiguration(self,"page");self.pageHeader().addClass("editting");self.getPageConfig().done(function(){var pageConfig=$(self.html);$Config.load(pageConfig)}).fail(function(msg){$Config.load(msg)})},updateHtml:function(html){self.html=html},getPageConfig:function(){var state=$.Deferred();if(!$.isEmptyObject(self.params))state.resolve();else EasySocial.ajax("admin/controllers/profiles/getPageConfig",{pageid:self.options.pageid}).done(function(params,values,html){self.params=
params;self.values=values;self.html=html;self.appParams=params;state.resolve()}).fail(function(msg){state.reject(msg)});return state},getConfigValues:function(){return self.values},"{fieldItem} onConfigChange":function(el,ev,name,value){self.values[name]=value;var step=$Steps.getStepLink(self.options.uid);if(name==="title"){step.text(value);self.pageTitle().html(value)}if(name==="description"){step.attr("data-original-title",value);self.pageDescription().html(value)}$Parent.customFieldChanged()},
"{pageDelete} click":function(el){if(el.enabled()){el.disabled(true);if($Editor.page().length==1){el.enabled(true);return false}EasySocial.dialog({width:400,height:150,title:$.language("COM_EASYSOCIAL_PROFILES_FORM_FIELDS_DELETE_PAGE_DIALOG_TITLE"),content:$.language("COM_EASYSOCIAL_PROFILES_FORM_FIELDS_DELETE_PAGE_DIALOG_CONFIRMATION"),showOverlay:false,buttons:[{name:$.language("COM_EASYSOCIAL_PROFILES_FORM_FIELDS_DELETE_PAGE_DIALOG_CANCEL"),classNames:"btn btn-es",click:function(){el.enabled(true);
EasySocial.dialog().close()}},{name:$.language("COM_EASYSOCIAL_PROFILES_FORM_FIELDS_DELETE_PAGE_DIALOG_CONFIRM"),classNames:"btn btn-es-danger",click:function(){EasySocial.dialog().update({content:$.language("COM_EASYSOCIAL_PROFILES_FORM_FIELDS_DELETE_PAGE_DIALOG_DELETING")});self.deletePage();EasySocial.dialog().close()}}]})}},deletePage:function(){self.item().trigger("pageDeleted");$Parent.trigger("pageDeleted",[self.options.uid]);delete $Pages[self.options.uid];if(!self.options.newpage)$Deleted.pages.push(self.options.uid);
self.element.remove();$.each($Editor.page(),function(i,page){$(page).controller().checkPageDeleteButton()});$Parent.customFieldChanged()},_export:function(){var fields=[];$.each(self.item(),function(j,item){item=$(item).controller();if(item!==undefined)fields.push(item._export())});var data={fields:fields,newpage:self.options.newpage,id:self.options.uid};if(self.values!==undefined)var data=$.extend(data,self.values);return data},updateResult:function(oldid,data){if(self.options.newpage){self.element.attr("id",
"formStep_"+data.id);self.element.removeAttr("data-fields-editor-page-"+oldid);self.element.attr("data-fields-editor-page-"+data.id,true);self.options.pageid=self.options.uid=data.id;$Pages[data.id]=$.extend(true,{},$Pages[oldid]);delete $Pages[oldid];self.options.newpage=false}if(data.fields!==undefined)$.each(data.fields,function(i,field){var item=self.item().eq(i).controller();item.updateResult(field)})},"{self} pageAdded":function(el,event,page){self.checkPageDeleteButton();$Parent.customFieldChanged()},
checkPageDeleteButton:function(){if($Editor.page().length>1)self.pageDelete().show();else self.pageDelete().hide()},"{parent} loadingConfig":function(){self.pageHeader().removeClass("editting");self.item().removeClass("editting")},"{parent} doneConfiguring":function(){self.pageHeader().removeClass("editting");self.item().removeClass("editting")}}});EasySocial.Controller("Fields.Editor.Item",{defaultOptions:{appid:0,fieldid:0,pageid:0,newfield:false,"{edit}":"[data-fields-editor-page-item-edit]","{deleteButton}":"[data-fields-editor-page-item-delete]",
"{moveButton}":"[data-fields-editor-page-item-move]","{content}":"[data-fields-editor-page-item-content]","{fieldItem}":"[data-field]","{config}":"[data-fields-config]","{closeConfig}":"[data-fields-config-close]",view:{moveDialog:"admin/profiles/dialog.move.field"}}},function(self){return{app:{},field:{id:0,appid:0,params:{}},state:$.Deferred(),appParams:{},init:function(){if(self.options.appid==0&&self.element.data("appid")!==undefined)self.options.appid=self.element.data("appid");if($Apps[self.options.appid]!==
undefined)self.app=$Apps[self.options.appid];if(self.options.fieldid==0&&self.element.data("id")!==undefined)self.options.fieldid=self.element.data("id");self.registerFields();self.uniqueid=$.uid(self.app.id+"_");self.loadedInit()},registerFields:function(){if(self.options.fieldid!=0){$Fields[self.options.fieldid]={id:self.options.fieldid,appid:self.options.appid,params:self.field.params||{}};self.field=$Fields[self.options.fieldid]}},loadedInit:function(){self.element.addController("EasySocial.Controller.Field.Base",
{mode:"sample",element:self.app.element});self.content().addController("EasySocial.Controller.Fields.Editor.Item.Config")},_export:function(){$Browser.checkout(self.options.appid);var exportData={"fieldid":self.options.fieldid,"appid":self.options.appid,"newfield":self.options.newfield};exportData=$.extend(exportData,self.expandConfig(self.field.params));return exportData},"{self} click":function(el,event){var clickedElement=$(event.target);if(!clickedElement.is(self.deleteButton.selector)&&!clickedElement.is(self.moveButton.selector)&&
!clickedElement.is(self.config.selector)&&!clickedElement.is(self.closeConfig.selector)&&!el.hasClass("editting")){if($Config&&$Config.state){var state=$Config.checkConfig();if(state)$Config.closeConfig();else{EasySocial.dialog({content:$.language("COM_EASYSOCIAL_PROFILES_FORM_FIELDS_INVALID_VALUES"),width:400,height:100});return}}self.loadConfiguration()}},loadConfiguration:function(){$Parent.loadConfiguration(self,"field");self.element.addClass("editting");self.getAppParams().done(function(){var html=
$(self.field.html);$Config.load(html)}).fail(function(){})},updateHtml:function(html){self.field.html=html},getAppParams:function(){var state=$.Deferred();if(self.field.html)state.resolve();else EasySocial.ajax("admin/controllers/fields/renderConfiguration",{appid:self.options.appid,fieldid:self.options.fieldid}).done(function(params,values,html){self.app.params=params;self.field.params=values;self.field.html=html;self.populateAppParams();state.resolve()}).fail(function(msg){state.reject(msg)});return state},
populateAppParams:function(){$.each(self.app.params,function(i,paramProperties){$.each(paramProperties.fields,function(name,field){if(field.subfields)$.each(field.subfields,function(subname,subfield){self.appParams[name+"_"+subname]=subfield});else self.appParams[name]=field})})},getConfigValues:function(){return self.field.params},expandConfig:function(){var newData={params:{},choices:{}};$.each(self.field.params,function(name,value){var field=self.appParams[name];if(!field)return false;var type=
field.type=="choices"?"choices":"params";newData[type][name]=value});if(self.options.newfield)newData.params.unique_key="";return newData},"{moveButton} click":function(el){var pages=$Steps.toObject(),currentPageId=el.parents($Editor.page.selector).data("id"),newPages=[];$.each(pages,function(i,page){if(page.uid!=currentPageId)newPages.push(page)});EasySocial.dialog({content:self.view.moveDialog(true,{pages:newPages}),selectors:{"{selection}":"[data-move-selection]","{confirmButton}":"[data-move-confirm]",
"{cancelButton}":"[data-move-cancel]"},bindings:{"{cancelButton} click":function(){EasySocial.dialog().close()},"{confirmButton} click":function(){var id=this.selection().val(),page=$Editor.getPage(id);page.items().append(self.element);$Parent.customFieldChanged();EasySocial.dialog().close()}}})},"{deleteButton} click":function(el){if(el.enabled()){el.disabled(true);EasySocial.dialog({width:400,height:150,title:$.language("COM_EASYSOCIAL_PROFILES_FORM_FIELDS_DELETE_ITEM_DIALOG_TITLE"),content:$.language("COM_EASYSOCIAL_PROFILES_FORM_FIELDS_DELETE_ITEM_DIALOG_CONFIRMATION"),
showOverlay:false,buttons:[{name:$.language("COM_EASYSOCIAL_PROFILES_FORM_FIELDS_DELETE_ITEM_DIALOG_CANCEL"),classNames:"btn btn-es btn-sm",click:function(){el.enabled(true);EasySocial.dialog().close()}},{name:$.language("COM_EASYSOCIAL_PROFILES_FORM_FIELDS_DELETE_PAGE_DIALOG_CONFIRM"),classNames:"btn btn-es-danger btn-sm",click:function(){EasySocial.dialog().update({content:$.language("COM_EASYSOCIAL_PROFILES_FORM_FIELDS_DELETE_ITEM_DIALOG_DELETING")});self.deleteField();EasySocial.dialog().close()}}]})}},
deleteField:function(){$Parent.trigger("fieldDeleted",[self.options.appid,self.options.fieldid]);if(!self.options.newfield){delete $Fields[self.options.fieldid];$Deleted.fields.push(self.options.fieldid)}self.element.remove();$Parent.customFieldChanged()},"{self} pageDeleted":function(){self.deleteField()},"{content} onConfigChange":function(el,event,name,value){self.field.params[name]=value},"{self} onPopulateConfig":function(el,event,values){self.field.params=values},updateResult:function(data){self.field.params.unique_key=
data.unique_key;self.itemParam("[data-fields-config-param-field-unique_key]").val(data.unique_key);if(self.options.newfield){self.options.newfield=false;self.options.fieldid=data.fieldid;self.element.data("id",data.fieldid);self.itemParam("[data-fields-editor-page-item-param-field-unique_key]").removeAttr("disabled");self.registerFields()}if(data.choices!==undefined)$.each(data.choices,function(name,choices){var element=self.itemParam("[data-fields-config-param-field-"+name+"]");$.each(choices,function(i,
choice){var item=element.find("li").eq(i);if(!item.data("id")){item.attr("data-id",choice.id);item.data("id",choice.id)}})})}}});EasySocial.Controller("Config.Choices",{defaultOptions:{"{choiceItems}":"[data-fields-config-param-choice]",unique:1}},function(self){return{init:function(){self.options.unique=self.element.data("unique")!==undefined?self.element.data("unique"):1;self.choiceItems().implement(EasySocial.Controller.Config.Choices.Choice,{controller:{"item":self.item,"choices":self}});self.initSortable()},
initSortable:function(){self.element.sortable({items:self.choiceItems.selector,placeholder:"ui-state-highlight",cursor:"move",forceHelperSize:true,handle:"[data-fields-config-param-choice-drag]",stop:function(){$(".tooltip-es").remove();$Parent.customFieldChanged()}})}}});EasySocial.Controller("Config.Choices.Choice",{defaultOptions:{"{choiceValue}":"[data-fields-config-param-choice-value]","{choiceTitle}":"[data-fields-config-param-choice-title]","{choiceDefault}":"[data-fields-config-param-choice-default]",
"{addChoice}":"[data-fields-config-param-choice-add]","{removeChoice}":"[data-fields-config-param-choice-remove]","{setDefault}":"[data-fields-config-param-choice-setdefault]","{defaultIcon}":"[data-fields-config-param-choice-defaulticon]"}},function(self){return{init:function(){},"{choiceTitle} keyup":$._.debounce(function(el,event){var index=self.element.index();self.item.fieldItem().trigger("onChoiceTitleChanged",[index,el.val()]);$Parent.customFieldChanged()},500),"{choiceValue} keyup":$._.debounce(function(el,
event){var index=self.element.index();self.item.fieldItem().trigger("onChoiceValueChanged",[index,el.val()]);$Parent.customFieldChanged()},500),"{addChoice} click":function(){var newItem=self.element.clone();var inputElement=newItem.find('input[type="text"]');inputElement.attr("value","");inputElement.val("");var inputDefault=newItem.find('input[type="hidden"]');inputDefault.attr("value",0);inputDefault.val(0);var defaultLabel=newItem.find("[data-fields-config-param-choice-defaulticon]");defaultLabel.removeClass("es-state-featured").addClass("es-state-default");
newItem.attr("data-id",0);newItem.data("id",0);newItem.implement(EasySocial.Controller.Config.Choices.Choice,{controller:{"item":self.item,"choices":self.choices}});self.element.after(newItem);var index=newItem.index();self.item.fieldItem().trigger("onChoiceAdded",[index]);$Parent.customFieldChanged()},"{removeChoice} click":function(){var remaining=self.choices.choiceItems().length-1;if(remaining>=1){var index=self.element.index();self.item.fieldItem().trigger("onChoiceRemoved",[index]);self.element.remove();
$(".tooltip-es").remove()}$Parent.customFieldChanged()},"{setDefault} click":function(){var index=self.element.index(),title=self.choiceTitle().val(),value=self.choiceValue().val();self.choices.choiceItems().trigger("toggleDefault",[index]);self.item.fieldItem().trigger("onChoiceToggleDefault",[index,parseInt(self.choiceDefault().val())]);$Parent.customFieldChanged()},"{self} toggleDefault":function(el,ev,i){var index=self.element.index(),value=parseInt(self.choiceDefault().val());if(index===i)if(value){self.defaultIcon().removeClass("es-state-featured").addClass("es-state-default");
self.choiceDefault().val(0)}else{self.defaultIcon().removeClass("es-state-default").addClass("es-state-featured");self.choiceDefault().val(1)}else if(self.choices.options.unique){self.defaultIcon().removeClass("es-state-featured").addClass("es-state-default");self.choiceDefault().val(0)}}}});EasySocial.Controller("Fields.Editor.Item.Config",{defaultOptions:{"{required}":"[data-required]","{title}":"[data-title]","{description}":"[data-description]","{displayTitle}":"[data-display-title]","{displayDescription}":"[data-display-description]"}},
function(self){return{init:function(){},"{self} onConfigChange":function(el,event,name,value){switch(name){case "display_title":self.displayTitle().toggle(!!value);break;case "title":self.title().text(value);break;case "display_description":self.displayDescription().toggle(!!value);break;case "description":self.description().text(value);break;case "required":self.required().toggle(!!value);break}}}});module.resolve()})});
