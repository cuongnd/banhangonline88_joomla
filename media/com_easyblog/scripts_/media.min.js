EasyBlog.module("media",function($){var module=this;var htmlentity=function(str){return $("<div>").text(str).html().replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")};var $Media,$Library,$Browser,$Uploader,DS;EasyBlog.Controller("Media",{defaultOptions:{debug:{logging:EasyBlog.debug,itemVisibility:false,delayConfiguration:0,delayCommon:0,delayBrowser:0,delayUploader:0,delayEditor:0},ui:"#EasyBlogMediaManagerUI",overlay:{background:"black",opacity:0},modal:{size:.9},recentActivities:{hideAfter:3E3},
"{modalGroup}":".mediaModalGroup","{modal}":".mediaModal","{loaderModal}":".loaderModal","{uploaderModal}":".uploaderModal","{browserModal}":".browserModal","{editorModal}":".editorModal","{modalContent}":".modalContent","{overlay}":".media-overlay","{modalDashboardButton}":".dashboardButton","{assetItem}":".assetItem"}},function(self){return{console:function(method,args){if(!self.options.debug.logging)return;var console=window.console;if(!console)return;var method=console[method];if(!method)return;
if(method.apply)method.apply(console,args);else method(args.join(" "))},assets:{},getAsset:function(name){if(self.assets[name]===undefined){var asset=self.assets[name]=$.Deferred();asset.done(function(){self.assetItem(".asset-type-"+name).removeClass("loading done failed").addClass("done")}).fail(function(){self.assetItem(".asset-type-"+name).removeClass("loading done failed").addClass("fail")})}return self.assets[name]},createAsset:function(name,factory,delay){var asset=self.getAsset(name);asset.factory=
factory;setTimeout(function(){asset.factory&&asset.factory(asset)},delay);return asset},init:function(){$Media=self;self.IE=function(){var undef,v=3,div=document.createElement("div"),all=div.getElementsByTagName("i");while(div.innerHTML="\x3c!--[if gt IE "+ ++v+"]><i></i><![endif]--\x3e",all[0]);return v>4?v:undef}();if(typeof tinyMCE!="undefined")if(tinyMCE&&tinyMCE.isIE&&self.IE==9)var waitForTinyMCE=setInterval(function(){var editor=tinyMCE.editors.write_content;if(!editor)return;var events="keydown.mediaManager mousedown.mediaManager focus.mediaManager";
$(editor.contentWindow).off(events).on(events,function(){self.bookmark={element:editor.selection.getEnd(),range:editor.selection.getBookmark(1).rng}});clearInterval(waitForTinyMCE)},500);self.originalBodyOverflow=$("body").css("overflow");self.createAsset("configuration",function(asset){EasyBlog.module("media/configuration").done(function(){var options=this;self.initialize(this);asset.resolve()}).fail(function(){asset.reject()})},self.options.debug.delayConfiguration);self.createAsset("common",function(asset){EasyBlog.require().script("media/navigation").view("media/recent.item",
"media/browser","media/browser.item-group","media/browser.item","media/browser.tree-item-group","media/browser.tree-item","media/browser.pagination-page","media/browser.uploader","media/browser.uploader.item","media/editor","media/editor.viewport","media/navigation.item","media/navigation.itemgroup").language("COM_EASYBLOG_MM_UNABLE_TO_FIND_EXPORTER","COM_EASYBLOG_MM_GETTING_IMAGE_SIZES","COM_EASYBLOG_MM_UNABLE_TO_RETRIEVE_VARIATIONS","COM_EASYBLOG_MM_ITEM_INSERTED","COM_EASYBLOG_MM_UPLOADING","COM_EASYBLOG_MM_UPLOADING_STATE",
"COM_EASYBLOG_MM_UPLOADING_PENDING","COM_EASYBLOG_MM_UPLOAD_COMPLETE","COM_EASYBLOG_MM_UPLOAD_PREPARING","COM_EASYBLOG_MM_UPLOAD_UNABLE_PARSE_RESPONSE","COM_EASYBLOG_MM_UPLOADING_LEFT","COM_EASYBLOG_MM_CONFIRM_DELETE_ITEM","COM_EASYBLOG_MM_CANCEL_BUTTON","COM_EASYBLOG_MM_YES_BUTTON","COM_EASYBLOG_MM_ITEM_DELETE_CONFIRMATION").stylesheet("media/style").done(function(){asset.resolve()}).fail(function(){asset.reject()})},self.options.debug.delayCommon);self.createAsset("uploader",function(asset){$.when(self.getAsset("configuration"),
self.getAsset("common"),EasyBlog.require().script("media/uploader").done()).done(function(){var modal=self.createModal("uploader");$Uploader=modal.controller=new EasyBlog.Controller.Media.Uploader(modal.element,self.options.uploader);asset.resolve()}).fail(function(){asset.reject()})},self.options.debug.delayUploader);self.createAsset("browser",function(asset){$.when(self.getAsset("configuration"),self.getAsset("common"),EasyBlog.require().script("media/browser").done()).done(function(){var modal=
self.createModal("browser");$Browser=modal.controller=new EasyBlog.Controller.Media.Browser(modal.element,self.options.browser);asset.resolve()}).fail(function(){asset.reject()})},self.options.debug.delayBrowser);self.createAsset("editor",function(asset){$.when(self.getAsset("browser"),EasyBlog.require().script("media/editor").done()).done(function(){var modal=self.createModal("editor");modal.controller=new EasyBlog.Controller.Media.Editor(modal.element,self.options.editor);asset.resolve()}).fail(function(){asset.reject()})},
self.options.debug.delayEditor);EasyBlog.require().library("throttle-debounce").done(function(){self.setLayout=$.debounce(200,self._setLayout)})},initialize:function(options){var media={controller:{media:self}},options=$.extend(true,options,{browser:media,uploader:media,library:media,editor:media,exporter:media});self.update(options);DS=options.directorySeparator;var UI=$(self.options.ui);self.element.append(UI.html());UI.remove();self.overlay().css(self.options.overlay);self.loader=new EasyBlog.Controller.Media.Loader(self.createModal("loader"),
{controller:{media:self}});self.element.implement(EasyBlog.Controller.Media.Library,self.options.library,function(){});self.element.implement(EasyBlog.Controller.Media.Exporter,self.options.exporter);module.resolve()},setLayout:function(){self._setLayout()},_setLayout:function(){self.layout=self.element.hasClass("active")?$.uid():null;if(self.layout)self.setModalLayout();return self.layout},modals:{},createModal:function(name){var element=self.modal("."+name+"Modal");if(element.length<1)element=$('<div class="mediaModal"></div>').addClass(name+
"Modal").appendTo(self.modalGroup());return self.modals[name]={name:name,element:element}},activateModal:function(name,args){if(self.modals[name]===undefined){self.loader.when(self.assets[name]).done(function(){setTimeout(function(){self.activateModal(name,args)},1E3)});return}if(self.currentModal===name)return true;var modal=self.modals[name];if(!modal)return false;self.deactivateModal(self.currentModal);self.currentModal=name;self.show();var controller=modal.controller;if(controller)controller.trigger("modalActivate",
args);return true},deactivateModal:function(name,args){var modal=self.modals[name];if(!modal)return false;var controller=modal.controller;if(controller)try{controller.trigger("modalDeactivate",args)}catch(e){console.error(e)}modal.element.removeClass("active");self.currentModal=undefined;return true},setModalLayout:function(){clearTimeout(self.setModalLayout.task);var modal=self.modals[self.currentModal];if(!modal)return;if(!self.layout)return self._setLayout();modal.element.addClass("active");var controller=
modal.controller;if(controller&&$.isFunction(controller.setLayout)){var task=function(){var offset=controller.element.offset();if(offset.top===0||offset.left===0)self.setModalLayout.task=setTimeout(task,50);else controller.setLayout()};task()}},show:function(){self.element.addClass("active");self._setLayout();self.trigger("showModal")},hide:function(){self.element.removeClass("active");self.deactivateModal(self.currentModal);self.trigger("hideModal")},"{overlay} click":function(){self.hide()},"{window} resize":function(){self.setLayout()},
"{modalDashboardButton} click":function(el,event){if(event.shiftKey)return self.console("dir",[self]);self.hide()},upload:function(){self.activateModal("uploader",arguments)},browse:function(){self.activateModal("browser",arguments)},edit:function(){self.activateModal("editor",arguments)}}});EasyBlog.Controller("Media.Loader",{defaultOptions:{}},function(self){return{init:function(){},when:function(){self.media.activateModal("loader");var queue=$.when.apply(null,arguments),onQueueDone=queue.done;
queue.id=$.uid();queue.done=function(callback){onQueueDone(function(){if(self.currentQueueId==queue.id)callback&&callback()})};self.currentQueueId=queue.id;return queue},"{self} hide":function(){self.currentQueueId=null}}});EasyBlog.Controller("Media.Prompt",{defaultOptions:{"{dialog}":".modalPromptDialog","{cancelButton}":".promptCancelButton"}},function(self){return{init:function(){},get:function(name){var dialog=self.dialog("."+name);return self.instantiate(dialog)},instantiate:function(dialog){var methods=
{element:dialog,show:function(){dialog.addClass("active");self.element.addClass("active");return methods},hide:function(){dialog.removeClass("active");self.element.removeClass("active");return methods},state:function(state){var lastState=dialog.data("lastPromptState");if(state===undefined)return lastState;var getStateElement=function(state){return dialog.find(".promptState"+".state-"+state)},currentState=getStateElement(state),lastState=getStateElement(lastState);if(currentState.length<1)return;lastState.removeClass("active");
currentState.addClass("active");dialog.data("lastPromptState",state);return methods}};return methods},hideAll:function(){self.dialog().removeClass("active");self.element.removeClass("active")},"{cancelButton} click":function(){self.hideAll()}}});EasyBlog.Controller("Media.Library",{defaultOptions:{places:[],place:{files:{},acl:{canCreateFolder:false,canUploadItem:false,canRenameItem:false,canRemoveItem:false,canCreateVariation:false,canDeleteVariation:false},populateImmediately:false}}},function(self){return{init:function(){self.media.library=
self;$.each(self.options.places,function(i,place){self.addPlace(place)})},places:{},getPlace:function(place){if(!place)return;if(place.acl)return place;if(typeof place==="string")return self.places[place.split("|")[0]]},addPlace:function(place){var place=self.places[place.id]=$.extend({tasks:$.Threads({threadLimit:1}),ready:$.Deferred(),baseFolder:function(){return self.getMeta(place.id+"|"+self.media.options.directorySeparator)}},self.options.place,place);place.done=place.ready.done;place.fail=place.ready.fail;
place.always=place.ready.always;var importJSON=function(data){if($.isEmptyObject(data))return;if(typeof data==="string")try{data=$.evalJSON(data)}catch(e){}return typeof data==="object"?data:undefined};place.files=importJSON(place.files);if(place.files)place.tasks.add(function(){self.importMeta(place.files);place.ready.resolve(place)});place.populate=function(){if(place.populate.task!==undefined)return place.populate.task;place.populate.task=$.Deferred();place.populate[/jomsocial|flickr/.test(place.id)||
place.files?"getFileTree":"getFolderTree"]();return place.populate.task};place.populate.getFolderTree=function(){return self.getRemoteMeta({place:place.id,foldersOnly:1}).done(function(meta){place.tasks.add(function(){self.importMeta(meta);place.ready.resolve(place)});place.populate.getFileTree()}).fail(function(){place.populate.task.reject(place);delete place.populate.task;place.ready.reject(place)})};place.populate.getFileTree=function(){return self.getRemoteMeta({place:place.id}).done(function(meta){place.tasks.add(function(){self.importMeta(meta);
place.ready.resolve(place);place.populate.task.resolve(place)})}).fail(function(){place.populate.task.reject(place);delete place.populate.task})};if(place.populateImmediately)place.populate();return place},meta:{},metadata:{},isMeta:function(meta){return!(meta===undefined||!$.isPlainObject(meta)||$.isEmptyObject(meta))},get:function(key){if(!self.meta.hasOwnProperty(key))return;var meta=$.extend({},self.meta[key]);meta.data=self.metadata[key];return meta},getKey:function(meta){return meta?meta.place+
"|"+meta.path:null},getParentKey:function(meta){if(!meta)return;var key=typeof meta==="string"?meta:meta.key||self.getKey(meta),start=key.indexOf(DS),end=key.lastIndexOf(DS);return end===key.length-1?undefined:key.substring(0,end+(start===end?1:0))},getMeta:function(meta){if(!meta)return;if(self.isMeta(meta))return self.get(self.getKey(meta))||meta;if(typeof meta==="string")return self.get(meta)},getRemoteMeta:function(options){var task=$.Deferred();task.retry=0;var defaultOptions={path:self.media.options.directorySeparator,
retry:3,retryAfter:1E3,variation:0,foldersOnly:0},options=$.extend(defaultOptions,options);if(options.place===undefined)return task.rejectWith(task,"Error: Place not given!");var loadRemoteMeta=function(){task.loader=EasyBlog.ajax("site.views.media.getMeta",options,{success:function(data){task.resolveWith(task,arguments)},fail:function(){task.rejectWith(task,arguments)},error:function(){task.retry++;if(task.retry<options.retry)loadRemoteMeta();else task.rejectWith(task,arguments)}});return arguments.callee}();
return task},getMetaVariations:function(meta){var meta=self.getMeta(meta);if(meta===undefined)return;return self.getRemoteMeta({place:meta.place,path:meta.path,variation:1}).done(function(meta){self.addMeta(meta)})},removeMetaVariation:function(meta,variationName){var meta=self.getMeta(meta);if(meta===undefined)return;if(meta.variations===undefined)return;var variation;for(var i=0;i<meta.variations.length;i++)if(meta.variations[i].name===variationName){variation=meta.variations[i];meta.variations.splice(i,
1);break}return variation},addMeta:function(meta){var key=self.getKey(meta),existingMeta=self.getMeta(key);if(existingMeta&&meta.hash===existingMeta.hash)return existingMeta;meta.key=key;meta.hash=$.uid();meta.group=meta.type=="folder"?"folders":"files";meta.parentKey=self.getParentKey(meta);var place=self.getPlace(meta.place);meta.friendlyPath=meta.path===DS?place.title:place.title+meta.path.substring(meta.path.indexOf(DS),meta.path.length);self.meta[key]=meta;var data=meta.data=self.metadata[key]||
(self.metadata[key]=$.eventable({}));if(meta.type=="folder"){data.files=data.files||{};data.folders=data.folders||{};data.views=data.views||self.createMetaView(meta)}if(!existingMeta){var parentMeta=self.getMeta(meta.parentKey);if(parentMeta)parentMeta.data.views.addMeta(meta)}else setTimeout(function(){meta.data.fire("updated",meta)},0);return meta},removeMeta:function(meta){var meta=self.getMeta(meta);if(meta===undefined)return;if(meta.type==="folder"){var folders=meta.data.folders,files=meta.data.files;
for(key in folders)self.removeMeta(key);for(key in files)self.removeMeta(key)}if(meta.parentKey){var parentMeta=self.getMeta(meta.parentKey);if(parentMeta)parentMeta.data.views.removeMeta(meta);delete self.meta[meta.key];setTimeout(function(){meta.data.fire("removed",meta)},0)}return meta},removeRemoteMeta:function(meta){var task=$.Deferred();var meta=self.getMeta(meta);if(meta===undefined)return task.rejectWith(task,"The file does not exist in the media library.");task.loader=EasyBlog.ajax("site.views.media.delete",
{place:meta.place,path:meta.path},{success:function(){self.removeMeta(meta);task.resolveWith(task,[meta])},fail:function(){task.rejectWith(task,arguments)},error:function(xhr,errorStatus){task.rejectWith(task,[errorStatus])}});return task},createFolder:function(meta,name){var task=$.Deferred();var meta=self.getMeta(meta),place=meta.place;if(meta===undefined||meta.type!=="folder")return task.rejectWith(task,"Parent folder was not found.");task.loader=EasyBlog.ajax("site.views.media.createFolder",{place:place,
path:meta.path+DS+name},{success:function(meta){meta.place=place;var meta=self.addMeta(meta);task.resolveWith(task,[meta])},fail:function(){task.rejectWith(task,arguments)},error:function(xhr,errorStatus){task.rejectWith(task,[errorStatus])}});return task},importMeta:function(meta,recursive){if(meta===undefined)return;if(meta.type!=="folder")return;if(recursive===undefined)recursive=true;var contents=meta.contents,length=contents.length;delete meta.contents;contents.reverse();var folder=self.addMeta(meta),
data=folder.data,_data={files:{},folders:{}};var i=0;while(i<length){var meta=self.addMeta(contents[i]),key=meta.key,group=meta.group;_data[group][key]=delete data[group][key];i++}for(key in data.files)self.removeMeta(key);for(key in data.folders)self.removeMeta(key);data.folders=_data.folders;data.files=_data.files;if(recursive)for(key in data.folders)self.importMeta(self.getMeta(key),recursive);return folder},createMetaView:function(meta){var view={meta:meta,addMeta:function(meta){for(mode in view.modes){var viewMap=
view.modes[mode][meta.group];viewMap&&viewMap.add(meta)}},removeMeta:function(meta){for(mode in view.modes){var viewMap=view.modes[mode][meta.group];viewMap&&viewMap.remove(meta)}},create:function(options){var defaultOptions={from:0,to:1024,mode:"dateModified",group:"files"};var monitor=$.Callbacks("unique memory");$.extend(monitor,defaultOptions,options,{uid:$.uid(),select:function(options){$.extend(monitor,options);if(monitor.map)delete monitor.map.monitors[monitor.uid];monitor.map=view.modes[monitor.mode][monitor.group];
monitor.map.monitors[monitor.uid]=monitor;return monitor.refresh()},updated:monitor.add,refresh:function(){return monitor.fire(monitor.map.slice(monitor.from,monitor.to))},destroy:function(){monitor.disable();if(monitor.map)delete monitor.map.monitors[monitor.uid];return monitor}});return monitor.select()}};self.createViewModes(view);return view},createViewModes:function(view){view.modes={dateModified:{folders:self.createViewMap(view,true),files:self.createViewMap(view)}};return view},createViewMap:function(view,
folderGroup){var map=$.extend([],{task:$.Threads({threadLimit:1}),affectedIndex:[],add:function(meta){map.task.add(function(){map.unshift(meta.key);map.affectedIndex.push(0);if(folderGroup)map.sort().reverse();map.refreshMonitor()})},remove:function(meta){map.task.add(function(){var key=meta.key,i=map.length,position;while(i--)if(map[i]===key){position=i;break}if(position===undefined)return;map.splice(i,1);map.affectedIndex.push(i);map.refreshMonitor()})},monitors:{},refreshMonitor:function(){clearTimeout(map.refreshMonitor.timer);
map.refreshMonitor.timer=setTimeout(function(){var affectedIndex=map.affectedIndex;map.affectedIndex=[];map.task.add(function(){var l=affectedIndex.length,i=0;for(id in map.monitors){var monitor=map.monitors[id],from=monitor.from,to=monitor.to,i;for(i=0;i<l;i++){var a=affectedIndex[i];if(a>=from||a<=to){monitor.refresh();break}}}})},250)}});return map},search:function(keyword){if($.trim(keyword)==="")return[];var keyword=keyword.toLowerCase();var results=self.createMetaView({type:"search"});for(key in self.meta){var parts=
key.split("|"),place=parts[0],path=parts[1],meta=self.meta[key];if(/jomsocial|flickr/.test(place))path=meta.title||"";if(path.toLowerCase().match(keyword))results.addMeta(meta)}return results}}});EasyBlog.Controller("Media.Exporter",{defaultOptions:{view:{recentItem:"media/recent.item"},"{recentActivities}":".recentActivities","{recentActivitiesDialog}":".recentActivities .modalPromptDialog","{hideRecentActivitiesButton}":".recentActivities .promptHideButton","{dashboardButton}":".recentActivities .dashboardButton",
"{recentItemGroup}":".recentItemGroup","{recentItem}":".recentItem"}},function(self){return{init:function(){$Media.exporter=self;$Media.insert=self.insert},handler:{},showDialog:function(){self.recentActivitiesDialog().addClass("active");self.recentActivities().css({top:0,opacity:1}).addClass("active")},hideDialog:function(){self.recentActivities().animate({top:"-=50px",opacity:0},{duration:250,complete:function(){self.recentActivities().removeClass("active");self.recentActivitiesDialog().removeClass("active")}})},
"{dashboardButton} click":function(){self.hideDialog()},"{hideRecentActivitiesButton} click":function(){self.hideDialog()},insert:function(item,settings){var meta=$Media.library.getMeta(item);if(meta===undefined)return;var task=self.create(meta.type,meta.key,settings);self.showDialog();task.recentItem=self.view.recentItem({meta:meta}).addClass("loading").css({opacity:0}).prependTo(self.recentItemGroup()).animate({opacity:1},{duration:500,complete:function(){task.done(function(html){if(html==="")task.recentItem.removeClass("loading done").addClass("error").find(".itemProgress").html($.language("COM_EASYBLOG_MM_UNABLE_TO_EXPORT_ITEM"));
if(typeof tinyMCE!="undefined")if(tinyMCE&&tinyMCE.isIE&&$Media.IE==9){var bookmark=$Media.bookmark;if(bookmark){var editor=tinyMCE.editors.write_content;editor.selection.moveToBookmark({rng:bookmark.range});editor.execCommand("mceInsertContent",false,html)}else EasyBlog.dashboard.editor.insert(html)}else EasyBlog.dashboard.editor.insert(html);else EasyBlog.dashboard.editor.insert(html);task.recentItem.removeClass("loading failed").addClass("done").find(".itemProgress").html($.language("COM_EASYBLOG_MM_ITEM_INSERTED"));
if($Media.options.recentActivities.hideAfter>0)setTimeout(function(){self.hideDialog()},$Media.options.recentActivities.hideAfter)}).progress(function(message){if(task.recentItem.hasClass("done"))return;task.recentItem.find(".itemProgress").html(message)}).fail(function(message){task.recentItem.removeClass("loading done").addClass("error").find(".itemProgress").html(message)})}});return task},create:function(type,key,settings){var handler=self.handler[type],task=$.Deferred();if(handler===undefined){var Exporter=
EasyBlog.Controller.Media.Exporter[$.String.capitalize(type)];if(Exporter===undefined){task.reject($.language("COM_EASYBLOG_MM_UNABLE_TO_FIND_EXPORTER"));return task}handler=self.handler[type]=new Exporter(self.element,$.extend({},{settings:self.options[type],controller:{media:self.media}}))}handler.create(task,key,settings);return task}}});EasyBlog.Controller("Media.Exporter.File",{defaultOptions:{settings:{title:"",target:"_self",content:""}}},function(self){return{init:function(){},create:function(task,
key,customSettings){var settings=$.extend({},self.options.settings,customSettings),meta=self.media.library.getMeta(key),link=$(document.createElement("A")).attr({title:settings.title,target:settings.target,href:meta.url}).html(settings.content?settings.content:meta.title);task.resolve(link.toHTML());return task}}});EasyBlog.Controller("Media.Exporter.Folder",{defaultOptions:{settings:{}}},function(self){return{init:function(){},create:function(task,key,customSettings){var settings=$.extend({},self.options.settings,
customSettings),meta=self.media.library.getMeta(key),embedType=meta.place=="jomsocial"?"album":"gallery";settings.file=meta.path;settings.place=meta.place;var snippet="[embed="+embedType+"]"+$.toJSON(settings)+"[/embed]";task.resolve(snippet);return task}}});EasyBlog.Controller("Media.Exporter.Image",{defaultOptions:{settings:{zoom:null,caption:null,enforceDimension:false,enforceWidth:null,enforceHeight:null,variation:null,defaultVariation:"thumbnail",defaultZoom:"original"}}},function(self){return{init:function(){},
create:function(task,key,customSettings){var settings=$.extend({},self.options.settings,customSettings),meta=self.media.library.getMeta(key),image=$(new Image);var title=htmlentity(meta.title);image.attr({src:meta.thumbnail.url,alt:title,title:title});var resolve=function(){task.resolve(image.toHTML())},process=function(){var variations={};$.each(meta.variations,function(i,variation){variations[variation.name]=variation});var variation=variations[settings.variation]||variations[settings.defaultVariation]||
meta.variations[0];var title=htmlentity(variation.title);image.attr({src:variation.url,alt:title,title:title});if(settings.enforceDimension)if(settings.enforceWidth!==null&&settings.enforceHeight!==null){var sizes=$.Image.resizeWithin(variation.width,variation.height,settings.enforceWidth,settings.enforceHeight);sizes.width=Math.floor(sizes.width);sizes.height=Math.floor(sizes.height);image.attr(sizes)}if(settings.caption!==null){var caption=htmlentity(settings.caption);image.addClass("easyblog-image-caption").attr("title",
caption)}if(settings.zoom!==null){var zoomWith=variations[settings.zoom]||variations[settings.defaultZoom]||{url:meta.thumbnail.url,title:meta.title};var title=htmlentity(settings.caption||zoomWith.title||"");image=$("<a>").addClass("easyblog-thumb-preview").attr({href:zoomWith.url,title:title}).html(image)}resolve()};if(settings.variation||settings.zoom||settings.enforceWidth||settings.enforceHeight)if(meta.variations===undefined){task.notify($.language("COM_EASYBLOG_MM_GETTING_IMAGE_SIZES"));self.media.library.getMetaVariations(key).done(function(metaWithVariations){meta=
metaWithVariations;process()}).fail(function(){task.reject($.language("COM_EASYBLOG_MM_UNABLE_TO_RETRIEVE_VARIATIONS"))})}else process();else resolve();return task}}});EasyBlog.Controller("Media.Exporter.Audio",{defaultOptions:{width:400,height:24,autostart:false,controlbar:"bottom",backcolor:"#333333",frontcolor:"#ffffff"}},function(self){return{init:function(){},create:function(task,key,customSettings){var settings=$.extend({},self.options.settings,customSettings),meta=self.media.library.getMeta(key);
settings.file=meta.path;settings.place=meta.place;var snippet="[embed=audio]"+$.toJSON(settings)+"[/embed]";task.resolve(snippet);return task}}});EasyBlog.Controller("Media.Exporter.Video",{defaultOptions:{settings:{width:400,height:225,autostart:false,controlbar:"bottom",backcolor:"#333333",frontcolor:"#ffffff"}}},function(self){return{init:function(){},create:function(task,key,customSettings){var settings=$.extend({},self.options.settings,customSettings),meta=self.media.library.getMeta(key);settings.file=
meta.path;settings.place=meta.place;var snippet="[embed=video]"+$.toJSON(settings)+"[/embed]";task.resolve(snippet);return task}}});EasyBlog.Controller("MediaLauncher",{defaultOptions:{"{uploadImageButton}":".uploadImageButton","{chooseImageButton}":".chooseImageButton"}},function(self){return{init:function(){$("#media_manager_button").click(function(){EasyBlog.mediaManager.browse()})},"{uploadImageButton} click":function(){EasyBlog.mediaManager.upload()},"{chooseImageButton} click":function(){EasyBlog.mediaManager.browse()}}});
var container=$(document.createElement("div")).attr("id","EasyBlogMediaManager").appendTo("body");EasyBlog.mediaManager=new EasyBlog.Controller.Media(container)});
