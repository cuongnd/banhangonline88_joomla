EasyBlog.module("media/browser",function($){var module=this;EasyBlog.require().library("image","easing","scrollTo","throttle-debounce").script("media/browser.item").done(function(){var $Media,$Library,$Browser,$Uploader,$Prompt,DS;EasyBlog.Controller("Media.Browser",{defaultOptions:{view:{browser:"media/browser",itemGroup:"media/browser.item-group",item:"media/browser.item",treeItemGroup:"media/browser.tree-item-group",treeItem:"media/browser.tree-item",paginationPage:"media/browser.pagination-page"},
path:"",items:undefined,mode:"browse",layout:{viewMode:"tile",tileSize:.125,scrollToItemDuration:500,scrollToItemEasing:"swing",iconMaxLoadThread:8},search:{chunkSize:128,chunkDelay:500},"{modalHeader}":".modalHeader","{modalToolbar}":".modalToolbar","{modalContent}":".modalContent","{modalFooter}":".modalFooter","{modalPrompt}":".modalPrompt","{modalUploaderButton}":".uploaderButton","{header}":".browserHeader","{content}":".browserContent","{footer}":".browserFooter","{treeToggleButton}":".browserTreeToggleButton",
"{tileViewButton}":".browserTileViewButton","{listViewButton}":".browserListViewButton","{itemField}":".browserItemField","{itemGroup}":".browserItemGroup","{item}":".browserItem","{treeItemField}":".browserTreeItemField","{treeItemGroup}":".browserTreeItemGroup","{treeItem}":".browserTreeItem","{headerTitle}":".browserTitle","{headerSearch}":".browserSearch","{headerNavigation}":".browserNavigation","{headerUpload}":".browserUploadButton","{footerStatus}":".browserStatus","{footerMessage}":".browserMessage",
"{itemActionSet}":".browserItemActionSet","{itemFieldHints}":".browserItemField .hints","{browserPagination}":".browserPagination","{currentPage}":".currentPage","{totalPage}":".totalPage","{prevPageButton}":".prevPageButton","{nextPageButton}":".nextPageButton","{pageSelection}":".pageSelection","{paginationPage}":".paginationPage","{searchInput}":".searchInput"}},function(self){return{init:function(){$Media=self.media;$Library=$Media.library;$Browser=$Media.browser=self;DS=$Media.options.directorySeparator;
self.iconThread=$.Threads({threadLimit:self.options.layout.iconMaxLoadThread});self.enqueue=$.Enqueue();self.element.addClass("browser").html(self.view.browser());self.headerNavigation().implement(EasyBlog.Controller.Media.Navigation,{controller:self.controllerProps()},function(){self.navigation=this});self.modalPrompt().implement(EasyBlog.Controller.Media.Prompt,{controller:self.controllerProps()},function(){$Prompt=self.promptDialog=this});self.element.implement(EasyBlog.Controller.Media.Browser.Actions,
{controller:self.controllerProps()},function(){self.actions=this});self.search=$.debounce(500,self._search);self.mode("browse");$Media.element.bind("hideModal",function(){self.mode("browse")});self.viewMode(self.options.layout.viewMode);self.setLayout();self._bind(self.itemField(),"scroll",$.debounce(250,self["{itemField} scroll"]));$.each($Library.places,function(id,place){self.createPlace(place)});self.activatePlace(self.options.initialPlace||$Library.places[0].id).done(self.enqueue(function(place){self.activateItem(place.baseFolder())}))},
controllerProps:function(prop){return $.extend({media:$Media},prop||{})},items:{},createPlace:function(place){var place=$Library.getPlace(place);place.treeItemGroup=self.view.treeItemGroup().appendTo(self.treeItemField());place.treeItem=self.view.treeItem({title:place.title}).addClass("type-place").data("place",place).appendTo(place.treeItemGroup);place.itemGroup=self.view.itemGroup().appendTo(self.itemField());return place},activatePlace:function(place){var place=$Library.getPlace(place);if(place===
undefined)return;self.itemGroup().removeClass("active");place.itemGroup.addClass("active");self.treeItem().removeClass("active");place.treeItem.addClass("active");if(!place.activator)place.activator=$.Deferred();if(place.id==="flickr"&&!place.options.associated){$Browser.currentFolderStatus("flickr");return place.activator}if(!place.populated){place.populated=true;self.currentFolderStatus("loading");var populator=/jomsocial|flickr/.test(place.id)?place.populate():place.ready;populator.done(function(){var baseFolderItem=
self.createFolder(place.baseFolder());place.activator.resolveWith(place,[place,baseFolderItem])}).fail(function(){self.currentFolderStatus("error");place.activator.rejectWith(place,arguments)})}return place.activator},getItem:function(item){if(item===undefined)return;if(item instanceof EasyBlog.Controller.Media.Browser.Item)return item;if(typeof item==="string")return self.items[item];if($Library.isMeta(item))return self.items[$Library.getKey(item)]},createItem:function(meta,options){var meta=$Library.getMeta(meta);
if(!meta)return;return self.items[meta.key]=new EasyBlog.Controller.Media.Browser.Item(self.view.item({meta:meta}),{controller:{key:meta.key,media:$Media}})},createFolder:function(meta,options){var meta=$Library.getMeta(meta);return self.getItem(meta)||function(){var item=self.createItem(meta);var place=item.place(),parentFolder=item.parentFolder();parentFolder?item.element.insertAfter(parentFolder.element):item.element.appendTo(place.itemGroup);item.treeItem=(parentFolder?self.view.treeItem({title:meta.title}).addClass("type-folder").css("marginLeft",
18*(meta.path.split(DS).length-1)).insertAfter(parentFolder.treeItem):place.treeItem).data("item",item);meta.data.views.create({group:"folders"}).updated(function(folders){$.each(folders,function(i,key){self.createFolder(key)})});return item}()},createFile:function(meta,options){var meta=$Library.getMeta(meta);return self.getItem(meta)||self.createItem(meta)},removeItem:function(item){clearTimeout(self.removeItem.revert);var item=self.getItem(item),parentFolder=item.parentFolder();item.remove();if(item.treeItem)item.treeItem.remove();
delete self.items[item.key];if(self.itemField().hasClass("searching"))return;self.removeItem.revert=setTimeout(function(){if(parentFolder)self.activateItem(parentFolder)},500)},focusItem:function(item,alsoActivate){var item=self.getItem(item);if(!item)return;if(!alsoActivate){self.currentItem(item);item.element.removeClass("active")}else self.activateItem(item);self.scrollTo(item);self.trigger("itemFocus",[item])},locateItem:function(meta){if(self.itemField().hasClass("searching"))self.clearSearch(true);
var meta=$Library.getMeta(meta);if(!meta)return;self.activatePlace(meta.place).done(self.enqueue(function(){var isFolder=meta.type==="folder",item=self.activateItem(isFolder?meta:meta.parentKey);if(item===undefined)return;if(!isFolder)item.handler.locateItem(meta);var folderView=item.handler.folderView;if(folderView)folderView.refresh()}))},activateItem:function(item){var item=self.getItem(item);if(!item)return;self.currentItem(item);item.activate();self.trigger("itemActivate",[item]);return item},
scrollTo:function(item){var item=self.getItem(item);if(!item)return;self.itemField().scrollTo(item.element,{duration:self.options.layout.scrollToItemDuration,easing:self.options.layout.scrollToItemEasing,offset:{top:self.itemField().height()*-.1}})},currentItem:function(item){var currentItem=self.currentItem.item;if(currentItem&&currentItem._destroyed)currentItem=self.currentItem.item=undefined;var item=self.getItem(item);if(!item)return currentItem;if(item._destroyed)return currentItem;if(currentItem){currentItem.element.removeClass("active focus");
if(currentItem.meta().type!=="folder")currentItem.parentFolder().element.removeClass("active focus");currentItem.place().itemGroup.removeClass("active")}item.element.addClass("active focus");var isFolder=item.meta().type=="folder";if(!isFolder)item.parentFolder().element.addClass("focus");item.place().itemGroup.addClass("active");self.currentFolder(isFolder?item:item.parentFolder());self.navigation.setPathway(item.key);return self.currentItem.item=item},currentFolder:function(folder){var currentFolder=
self.currentFolder.folder;if(currentFolder&&currentFolder._destroyed)currentFolder=self.currentFolder.folder=undefined;var folder=self.getItem(folder);if(!folder)return currentFolder;self.treeItem().removeClass("active");folder.treeItem.addClass("active");if(folder.meta().path!==DS)folder.place().treeItemGroup.addClass("expanded");if(folder.handler.folderView)if(folder.handler.refreshSeed!==self.folderRefreshSeed){folder.handler.folderView.refresh();folder.handler.refreshSeed=self.folderRefreshSeed}return self.currentFolder.folder=
folder},currentFolderStatus:function(status){if(self.itemField().hasClass("searching")&&!/emptySearch|ready/.test(status))return;var lastStatus=self.currentFolderStatus.lastStatus;if(status===undefined)return lastStatus;if(typeof status!=="string")return;if(lastStatus)self.itemField().removeClass(lastStatus);self.itemField().addClass(status);return self.currentFolderStatus.lastStatus=status},setLayout:function(){if(!$Media.layout||$Media.currentModal!=="browser")return;var contentHeight;self.modalContent().hide().height(contentHeight=
self.element.height()-self.modalHeader().outerHeight()-self.modalToolbar().outerHeight()-self.modalFooter().outerHeight()).show();if($.browser.msie){self.treeItemField().height(contentHeight);self.itemField().height(contentHeight);self.itemFieldHints().height(contentHeight)}self.setItemLayout();self.trigger("setLayout")},setItemStyle:function(force){if(!force){var seed=$Media.layout;if(self.setItemStyle.seed===seed)return;self.setItemStyle.seed=seed}var viewMode=self.viewMode(),cssRules={};if(viewMode==
"tile"){var browserItem="#EasyBlogMediaManager .browser .browserItemField.view-tile .browserItem",availableWidth=function(){var testElement=$(document.createElement("DIV")).prependTo(self.itemField()),availableWidth=testElement.width();testElement.remove();return availableWidth}(),itemWidth=Math.floor(availableWidth*self.options.layout.tileSize),itemHeight=itemWidth-24;cssRules[browserItem]={width:itemWidth+"px",height:itemHeight+"px"}}var head=document.getElementsByTagName("head")[0];if(self.itemStyle)try{head.removeChild(self.itemStyle)}catch(e){}self.itemStyle=
document.createElement("style");self.itemStyle.type="text/css";var cssText="";$.each(cssRules,function(selector,props){cssText+=selector+"{"+$.map(props,function(val,key){return key+":"+val}).join(";")+"}\n"});if(self.itemStyle.styleSheet)self.itemStyle.styleSheet.cssText=cssText;else self.itemStyle.appendChild(document.createTextNode(cssText));head.appendChild(self.itemStyle)},setItemLayout:function(){if(!$Media.layout||$Media.currentModal!=="browser")return;self.setItemStyle();setTimeout(function(){var items=
[];if(self.itemField().hasClass("searching")){if(self.searchItemGroup)items=self.searchItemGroup.find(".browserItem")}else{var currentFolder=self.currentFolder();if(currentFolder===undefined)return;items=currentFolder.childItem()}if(items.length<1)return;var itemFieldOffset=self.itemField().offset(),item,itemOffset,j=items.length,i=1;if(items.length<1)return;while(Math.abs(j-i)>1){item=items.eq(i-1);itemOffset=item.offset();var itemBottom=itemOffset.top-itemFieldOffset.top+item.outerHeight();if(itemBottom<
0)i=Math.ceil((j+i)/2);else{j=i;i=Math.ceil(j/2)}}if(i===1)i=0;var b=i,f=i,min=0,max=items.length-1;setLayout=function(i){if(i<min||i>max)return false;var item=items.eq(i).data("item");if(!item.isVisible())return false;item.setLayout()};while(true){if(setLayout(b)===false)break;b--}while(true){if(setLayout(f)===false)break;f++}},0)},viewMode:function(mode){var currentMode=self.viewMode.mode;if(!currentMode)currentMode=self.viewMode.mode=self.options.layout.viewMode;if(mode!==undefined){self.setItemStyle.seed=
null;self.itemField().removeClass("view-"+currentMode).addClass("view-"+mode);self.viewMode.mode=currentMode=mode;self.setLayout();var currentItem=self.currentItem();if(currentItem!==undefined)self.scrollTo(currentItem)}return currentMode},mode:function(mode){if(mode===undefined)return self.mode.currentMode||"browse";switch(mode){case "browse":self.element.removeClass("mode-blogimage").addClass("mode-browse");$.each($Library.places,function(i,place){if(/jomsocial|flickr/.test(place.id)){place.treeItemGroup&&
place.treeItemGroup.show();place.itemGroup&&place.itemGroup.show()}});break;case "blogimage":self.element.addClass("mode-blogimage").removeClass("mode-browse");var currentItem=self.currentItem(),switchToNearestLocalPlace=false;if(currentItem)if(/jomsocial|flickr/.test(currentItem.place().id))switchToNearestLocalPlace=true;$.each($Library.places,function(i,place){if(/jomsocial|flickr/.test(place.id)){place.treeItemGroup&&place.treeItemGroup.hide();place.itemGroup&&place.itemGroup.hide()}else if(switchToNearestLocalPlace){switchToNearestLocalPlace=
false;if(place.treeItem)place.treeItem.click()}});break}self.mode.currentMode=mode},"{self} itemActivate":function(el,event,item){self.itemActionSet().removeClass("active");if(item.meta().type=="folder")self.itemActionSet(".type-folder").addClass("active");else self.itemActionSet(".type-item").addClass("active")},"{headerNavigation} activate":function(el,event,key){self.activateItem(key)},"{tileViewButton} click":function(el,event){el.addClass("active").siblings().removeClass("active");self.viewMode("tile")},
"{listViewButton} click":function(el,event){el.addClass("active").siblings().removeClass("active");self.viewMode("list")},"{treeItem} click":function(el,event){self.clearSearch(true);var item=el.data("item");if(el.hasClass("type-place")){var place=el.data("place");if($(event.target).hasClass("treeItemToggle"))place.treeItemGroup.toggleClass("expanded");self.activatePlace(place).done(self.enqueue(function(place,baseFolder){if(place.id==="jomsocial")place.treeItemGroup.addClass("expanded");self.activateItem(baseFolder)}));
return}self.activateItem(item)},"{itemField} scroll":function(el,event){self.setItemLayout()},"{item} click":function(el,event){event.stopPropagation();var item=el.data("item");if(item===undefined)return;var place=item.place();self.activatePlace(place).done(self.enqueue(function(place,baseFolder){self.activateItem(item)}))},"{item} dblclick":function(el,event){event.stopPropagation();var item=el.data("item");if(event.shiftKey){$Media.console("log",[item]);return}if(item===undefined)return;if(item.meta().type==
"folder")return;if(self.mode.currentMode==="blogimage"){if(item.meta().type=="image"){var meta=$Library.meta[item.key];EasyBlog.dashboard.blogImage.setImage(meta);$Media.hide()}}else $Media.edit(item.key)},"{modalUploaderButton} click":function(){var item=self.currentFolder();$Media.upload(item.place().acl.canUploadItem?item.key:"")},"{self} modalActivate":function(el,event,meta,mode){if(mode!==undefined)self.mode(mode);var meta=$Library.getMeta(meta)||self.currentItem().meta();if(meta)self.locateItem(meta)},
"{prevPageButton} click":function(){var folder=$Browser.currentFolder();folder.handler.changePage("prev")},"{nextPageButton} click":function(){var folder=$Browser.currentFolder();folder.handler.changePage("next")},"{pageSelection} click":function(el){if(self.paginationPage().length>1)el.toggleClass("expanded")},"{paginationPage} click":function(el){if(self.pageSelection().hasClass("expanded")&&!el.hasClass("selected")){var page=el.data("page"),folder=$Browser.currentFolder();folder.handler.isChangingPage=
true;folder.handler.currentPage(page)}},"{window} click":function(el,event){var className=$(event.target).attr("class");if(!/pageSelection|paginationPage/.test(className))if(self.pageSelection().hasClass("expanded"))self.pageSelection().removeClass("expanded")},_search:function(keyword){if(!self.itemBeforeSearch)self.itemBeforeSearch=self.currentItem().meta();self.element.addClass("searching");self.itemField().addClass("searching");if(!self.searchItemGroup)self.searchItemGroup=self.view.itemGroup().appendTo(self.itemField());
self.searchItemGroup.addClass("active search-mode");var timer;self.searchView=$Library.search(keyword).create({from:0,to:300}).updated(function(files){var l=files.length;if(l<1){timer=setTimeout(function(){$Browser.currentFolderStatus("emptySearch")},500);return}clearTimeout(timer);$Browser.currentFolderStatus("ready");for(i=0;i<l;i++){var key=files[i];var file=$Browser.createFile(key);file.element.appendTo(self.searchItemGroup)}self.setItemLayout()})},clearSearch:function(cancel){self.folderRefreshSeed=
$.uid();if(cancel)self.searchInput().val("").blur();self.element.removeClass("searching");self.itemField().removeClass("searching");if(self.searchItems)$.each(self.searchItems,function(i,item){$(item).detach()});if(self.searchItemGroup){self.searchItemGroup.find(".browserItem").detach();self.searchItemGroup.removeClass("active")}if(self.searchView)self.searchView.destroy();delete self.searchView;if(self.itemBeforeSearch)self.locateItem(self.itemBeforeSearch)},"{searchInput} focusin":function(el){el.parent().addClass("active");
if($.trim(el.val())!=="")el.parent().addClass("showCancelButton")},"{searchInput} focusout":function(el){setTimeout(function(){if($.trim(el.val())==="")el.parent().removeClass("active showCancelButton")},50)},"{searchInput} keyup":function(el){var keyword=$.trim(el.val());if(keyword===""){el.parent().removeClass("showCancelButton");self.clearSearch();delete self.itemBeforeSearch;return}el.parent().addClass("showCancelButton");self.search(keyword)}}});EasyBlog.Controller("Media.Browser.Actions",{defaultOptions:{"{customizeItemButton}":".customizeItemButton",
"{insertAsGalleryButton}":".insertAsGalleryButton","{insertItemButton}":".insertItemButton","{insertBlogImageButton}":".insertBlogImageButton","{createFolderButton}":".createFolderButton","{confirmCreateFolderButton}":".createFolderPrompt .confirmCreateFolderButton","{folderPath}":".createFolderPrompt .folderPath","{folderCreationPath}":".createFolderPrompt .folderCreationPath","{folderInput}":".createFolderPrompt .folderInput","{folderCreationFailedReason}":".createFolderPrompt .folderCreationFailedReason",
"{removeItemButton}":".removeItemButton","{removeItemFilename}":".removeItemPrompt .removeItemFilename","{confirmRemoveItemButton}":".confirmRemoveItemButton","{removeItemFailedReason}":".removeItemPrompt .removeItemFailedReason","{flickrLoginButton}":".flickrLoginButton","{cancelSearchButton}":".cancelSearchButton","{retryPopulateButton}":".retryPopulateButton"}},function(self){return{init:function(){},"{self} itemActivate":function(el,event,item){self.item=item;var acl=item.place().acl;self.removeItemButton().toggle(acl.canRemoveItem);
self.createFolderButton().toggle(acl.canCreateFolder);self.insertBlogImageButton().toggle($Browser.mode()==="blogimage"&&item.meta().type==="image")},"{customizeItemButton} click":function(){$Media.edit(self.item.key)},"{insertAsGalleryButton} click":function(){$Media.insert(self.item.key)},"{insertItemButton} click":function(){$Media.insert(self.item.key)},"{insertBlogImageButton} click":function(){var meta=$Library.meta[self.item.key];EasyBlog.dashboard.blogImage.setImage(meta);$Media.hide()},"{createFolderButton} click":function(){$Prompt.get("createFolderPrompt").show().state("default");
var currentFolder=$Browser.currentFolder();self.folderPath().html(currentFolder.meta().friendlyPath);self.folderInput().focus()[0].select()},"{folderInput} keyup":function(el,event){if(event.keyCode==13)self.confirmCreateFolderButton().click()},"{confirmCreateFolderButton} click":function(){var folderName=$.trim(self.folderInput().val());if(folderName==="")return;var parentMeta=$Browser.currentFolder().meta(),path=parentMeta.friendlyPath+DS+folderName;self.folderCreationPath().html(path);var createFolderPrompt=
$Prompt.get("createFolderPrompt");createFolderPrompt.state("progress");$Library.createFolder(parentMeta,folderName).done(function(meta){var item=$Browser.createFolder(meta);createFolderPrompt.hide();$Browser.activateItem(item)}).fail(function(message){self.folderCreationFailedReason().html(message);createFolderPrompt.state("fail")})},"{removeItemButton} click":function(){self.removeItemFilename().html(self.item.meta().title);$Prompt.get("removeItemPrompt").show().state("default")},"{confirmRemoveItemButton} click":function(el){var removeItemPrompt=
$Prompt.get("removeItemPrompt");removeItemPrompt.state("progress");$Library.removeRemoteMeta(self.item.key).done(function(){removeItemPrompt.hide()}).fail(function(message){self.removeItemFailedReason().html(message);removeItemPrompt.state("fail")})},"{flickrLoginButton} click":function(el){var login=el.data("login"),callback=el.data("callback"),activateFlickrPlace=$Browser.enqueue(function(){$Browser.activatePlace("flickr").done($Browser.enqueue(function(place,baseFolder){$Browser.activateItem(baseFolder)}))});
window[callback]=function(){var place=$Library.getPlace("flickr");place.options.associated=true;activateFlickrPlace()};window.open(login,"Flickr Login","scrollbars=no, resizable=no, width=650, height=700")},"{cancelSearchButton} click":function(){$Browser.clearSearch(true)},"{retryPopulateButton} click":function(){var place=self.item.place();delete place.activator;place.populated=false;place.treeItem.click()}}});module.resolve()})});
