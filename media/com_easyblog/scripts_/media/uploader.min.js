EasyBlog.module("media/uploader",function($){var module=this;EasyBlog.require().library("plupload").done(function(){var $Media,$Library,$Uploader,DS;EasyBlog.Controller("Media.Uploader",{defaultOptions:{view:{uploader:"media/browser.uploader",uploadItem:"media/browser.uploader.item"},"{modalHeader}":".modalHeader","{modalToolbar}":".modalToolbar","{modalContent}":".modalContent","{modalFooter}":".modalFooter","{modalPrompt}":".modalPrompt","{modalBrowserButton}":".modalButton.browserButton","{modalDashboardButton}":".modalButton.dashboardButton",
"{uploadButton}":".uploadButton","{uploadNavigation}":".uploadNavigation","{uploadForm}":".uploadForm","{uploadPath}":".uploadPath","{uploadSize}":".uploadSize","{uploadExtensionList}":".uploadExtensionList","{uploadItemGroup}":".uploadItemGroup","{uploadItem}":".uploadItem","{uploadDropHint}":".uploadDropHint","{uploadInstructions}":".uploadInstructions","{clearListButton}":".clearListButton"}},function(self){return{init:function(){$Media=self.media;$Library=$Media.library;$Uploader=$Media.uploader=
self;DS=$Media.options.directorySeparator;self.element.addClass("uploader").html(self.view.uploader({uploadSize:self.options.settings.max_file_size,uploadExtensionList:self.options.settings.filters[0].extensions.split(",").join(", ")}));self.uploadNavigation().implement(EasyBlog.Controller.Media.Navigation,{controller:self.controllerProps()},function(){self.navigation=this});self.modalPrompt().implement(EasyBlog.Controller.Media.Prompt,{controller:self.controllerProps()},function(){self.promptDialog=
this});self.element.implement(EasyBlog.Controller.Media.Uploader.FolderSwitcher,{controller:self.controllerProps()},function(){self.folderSwitcher=this});self.element.implement("plupload",{settings:self.options.settings,"{uploadButton}":self.options["{uploadButton}"],"{uploadDropsite}":self.options["{uploadItemGroup}"]},function(){self.plupload=this.plupload;if(self.plupload.runtime=="html4"||$.browser.msie){self.uploadDropHint().remove();self.uploadItemGroup().addClass("indefinite-progress");var uploadInstructions=
self.uploadInstructions().appendTo($Media.element);self.element.find("> form").mouseover(function(){var uploadButton=self.uploadButton(),offset=uploadButton.offset();uploadInstructions.addClass("show").css({top:offset.top+uploadButton.outerHeight()-$Media.element.offset().top+3,right:$(window).width()-(offset.left+uploadButton.outerWidth())-1})}).mouseout(function(){uploadInstructions.removeClass("show")})}else self.uploadButton().mouseover(function(){self.uploadInstructions().addClass("show")}).mouseout(function(){self.uploadInstructions().removeClass("show")})});
self.setLayout()},setLayout:function(){if($Media.currentModal!=="uploader")return;var contentHeight;self.modalContent().hide().height(contentHeight=self.element.height()-self.modalHeader().outerHeight()-self.modalToolbar().outerHeight()-self.modalFooter().outerHeight()).show();if($.browser.msie){self.uploadDropHint().height(contentHeight);self.uploadItemGroup().height(contentHeight)}if(self.plupload)self.plupload.refresh()},controllerProps:function(prop){return $.extend({media:self.media,uploader:self},
prop||{})},setUploadFolder:function(key){if(!key)return;self.navigation.setPathway(key);self.currentUploadFolder=key},items:{},createItem:function(file){var item=new EasyBlog.Controller.Media.Uploader.Item(self.view.uploadItem(),{controller:self.controllerProps({id:file.id,originalFile:file,uploadFolder:self.currentUploadFolder})});item.element.appendTo(self.uploadItemGroup());var filesize=item.file().filesize,filesize=filesize?"":" ("+filesize+").";item.setMessage($.language("COM_EASYBLOG_MM_UPLOADING_PENDING")+
filesize);self.items[file.id]=item;return item},"{self} BeforeUpload":function(el,event,uploader,file){var item=self.items[file.id];if(item===undefined)return;item.setMessage($.language("COM_EASYBLOG_MM_UPLOAD_PREPARING"));var uploadUrl=self.options.settings.url,meta=$Library.getMeta(item.uploadFolder),place=meta?meta.place:item.uploadFolder.split("|")[0],path=encodeURIComponent(meta?meta.path:item.uploadFolder.split("|")[1]);uploader.settings.url=uploadUrl+"&place="+place+"&path="+path},"{self} FilesAdded":function(el,
event,uploader,files){try{$.each(files,function(i,file){if(self.items[file.id]!==undefined)return;self.createItem(file)});if(self.uploadItem().length>0)self.uploadItemGroup().removeClass("empty");self.plupload.start()}catch(e){console.error(e)}},"{self} UploadFile":function(el,event,uploader,file){var item=self.items[file.id];if(item===undefined)return;item.setState("uploading");item.setMessage($.language("COM_EASYBLOG_MM_UPLOADING_STATE"))},"{self} UploadProgress":function(el,event,uploader,file){var item=
self.items[file.id];if(item===undefined)return;item.setProgress(file.percent);item.setMessage($.language("COM_EASYBLOG_MM_UPLOADING")+(file.percent!==undefined?" "+file.percent+"%":"")+(file.loaded!==undefined&&!file.size!==undefined?file.size-file.loaded?" ("+$.plupload.formatSize(file.size-file.loaded)+" "+$.language("COM_EASYBLOG_MM_UPLOADING_LEFT")+")":"":""))},"{self} FileUploaded":function(el,event,uploader,file,response){var item=self.items[file.id];if(item===undefined)return;item.response=
response;if(!$.isPlainObject(response)){item.setState("failed");item.setMessage($.language("COM_EASYBLOG_MM_SERVER_RETURNED_INVALID_RESPONSE"));return}if(!$.isPlainObject(response.item)){item.setState("failed");item.setMessage(response.message||$.language("COM_EASYBLOG_MM_UPLOAD_UNABLE_PARSE_RESPONSE"));return}item.setState("done");item.setMessage($.language("COM_EASYBLOG_MM_UPLOAD_COMPLETE"));item.meta=response.item;item.meta.place=$Media.library.get(item.uploadFolder).place;if(item.meta.type!==
"image")item.insertBlogImageButton().remove();$Media.library.addMeta(item.meta)},"{self} FileError":function(el,event,uploader,file,response){var item=self.items[file.id];if(item===undefined)item=self.createItem(file);item.response=response;item.setState("failed");item.setMessage(response.message);if(self.uploadItem().length>0)self.uploadItemGroup().removeClass("empty")},"{self} Error":function(el,event,uploader,error){if(error.file){var file=error.file,item=self.items[file.id];if(item===undefined)item=
self.createItem(file);item.setState("failed");item.setMessage(error.message)}if(self.uploadItem().length>0)self.uploadItemGroup().removeClass("empty")},"{modalBrowserButton} click":function(){$Media.browse()},"{modalDashboardButton} click":function(){$Media.hide()},"{uploadNavigation} activate":function(el,event,key){self.setUploadFolder(key)},"{self} modalActivate":function(el,event,key){self.setUploadFolder(key);if($Media.browser)self.uploadItemGroup().toggleClass("blogimage",$Media.browser.mode()==
"blogimage")},removeItem:function(id){var item=self.items[id];if(item!==undefined){self.plupload.removeFile(item.file());item.element.remove();delete self.items[id]}if(self.uploadItem().length<1)self.uploadItemGroup().addClass("empty")},"{clearListButton} click":function(){for(id in self.items)self.removeItem(id)}}});EasyBlog.Controller("Media.Uploader.Item",{defaultOptions:{"{filename}":".uploadFilename","{progressBar}":".uploadProgressBar progress","{percentage}":".uploadPercentage","{status}":".uploadStatus",
"{removeButton}":".uploadRemoveButton","{insertItemButton}":".insertItemButton","{locateItemButton}":".locateItemButton","{insertBlogImageButton}":".insertBlogImageButton"}},function(self){return{init:function(){var file=self.file();self.filename().html(file.name);self.setState("queued")},file:function(){var file=$Uploader.plupload.getFile(self.id)||self.originalFile;if(file)file.filesize=file.size===undefined||file.size=="N/A"?"":$.plupload.formatSize(self.file.size);return file},"dblclick":function(el,
event){if(event.shiftKey)$Media.console("log",self)},setProgress:function(val){self.progressBar().attr("value",val);self.percentage().html(val)},setState:function(state){self.element.removeClass("upload-state-"+self.state).addClass("upload-state-"+state);self.state=state},setMessage:function(message){self.status().html(message)},"{removeButton} click":function(el,event){event.stopPropagation();$Uploader.removeItem(self.id)},"{insertItemButton} click":function(){$Media.insert(self.meta)},"{locateItemButton} click":function(){$Media.browse(self.meta)},
"{insertBlogImageButton} click":function(){var meta=$Library.meta[$Library.getMeta(self.meta).key];EasyBlog.dashboard.blogImage.setImage(meta);$Media.hide()}}});EasyBlog.Controller("Media.Uploader.FolderSwitcher",{defaultOptions:{view:{treeItemGroup:"media/browser.tree-item-group",treeItem:"media/browser.tree-item"},"{changeUploadFolderButton}":".changeUploadFolderButton","{selectFolderButton}":".selectFolderButton","{treeItemField}":".browserTreeItemField","{treeItemGroup}":".browserTreeItemGroup",
"{treeItem}":".browserTreeItem"}},function(self){return{init:function(){var initialUploadFolder;self.promptDialog=$Uploader.promptDialog.get("changeUploadFolderPrompt");$.each($Media.library.places,function(id,place){if(!place.acl.canUploadItem)return;place.uploaderTreeItemGroup=self.view.treeItemGroup().addClass("expanded").appendTo(self.treeItemField());place.uploaderTreeItem=self.view.treeItem({title:place.title}).addClass("loading").addClass("type-place").data("place",place).appendTo(place.uploaderTreeItemGroup);
if(!initialUploadFolder){initialUploadFolder=place.id+"|"+DS;$Uploader.setUploadFolder(initialUploadFolder)}place.done(function(){self.createTreeItem(place.baseFolder());place.uploaderTreeItem.removeClass("loading")})})},treeItems:{},createTreeItem:function(meta){var meta=$Library.getMeta(meta),treeItem=self.treeItems[meta.key]||function(){var place=$Library.getPlace(meta.place),parentMeta=$Library.getMeta(meta.parentKey),treeItem=self.treeItems[meta.key]=(parentMeta?self.view.treeItem({title:meta.title}).addClass("type-folder").insertAfter(self.treeItems[parentMeta.key]):
place.uploaderTreeItem).data("key",meta.key);meta.data.on("removed",function(){self.removeTreeItem(meta)});meta.data.views.create({group:"folders"}).updated(function(folders){$.each(folders,function(i,key){self.createTreeItem(key)})});return treeItem}();return treeItem},removeTreeItem:function(meta){var meta=$Library.getMeta(meta),treeItem=self.treeItems[meta.key];if(treeItem){treeItem.remove();var parentTreeItem=self.treeItems[meta.parentKey];$Uploader.setUploadFolder(meta.parentKey)}},"{treeItem} click":function(el){self.treeItem().removeClass("active");
el.addClass("active")},"{changeUploadFolderButton} click":function(){var key=self.currentUploadFolder,treeItem=self.treeItems[key]||self.treeItem(":first");treeItem.click();self.promptDialog.show()},"{selectFolderButton} click":function(){var key=self.treeItem(".active").data("key");$Uploader.setUploadFolder(key);self.promptDialog.hide()}}});module.resolve()})});
