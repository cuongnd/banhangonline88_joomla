EasyBlog.module("tag",function(e){var t=this;EasyBlog.require().view("dashboard/dashboard.tags.item").done(function(){EasyBlog.Controller("Tag.Form",{defaultOptions:{tags:[],tagLimit:0,tagSelections:[],tagSelectionLimit:25,"{tagList}":".tag-list.creation","{tagItems}":".tag-list.creation .tag-item","{tagItemRemoveButton}":".remove-tag","{tagCreationForm}":".new-tag-item","{tagInput}":".tagInput","{tagCreateButton}":".tag-create","{totalTags}":".total-tags","{tagSelectionFilter}":".tag-selection-filter","{tagSelectionList}":".tag-list.selection","{tagSelectionItems}":".tag-list.selection .tag-item","{tagSelection}":".tag-selection","{showAllTagsButton}":".show-all-tags",view:{tagItem:"dashboard/dashboard.tags.item"}}},function(t){return{init:function(){EasyBlog.dashboard&&EasyBlog.dashboard.registerPlugin("tags",t),setTimeout(function(){var e=t.options.tagSelections,n,r=e.length;for(n=0;n<r;n++)t.tags[e[n].title.toLowerCase()]=e[n];var e=t.options.tags,r=e.length;for(n=0;n<r;n++){var i=t.getKey(e[n].title);t.selectTag(i)}t.showTagSelections("")},0)},tags:{},items:{},selected:{},sanitizeTitle:function(t){return e.trim(t).replace(/[,\'\"\#\<\>]/gi,"")},getKey:function(e){return t.sanitizeTitle(e).toLowerCase()},getTag:function(e){return Object.prototype.hasOwnProperty.call(t.tags,e)?t.tags[e]:undefined},createTag:function(e){var e=t.sanitizeTitle(e),n=e.toLowerCase();return t.getTag(n)||(t.tags[n]={title:e})},getTagItem:function(e){var n=t.getTag(e);if(!n)return;return n.item||(n.item=t.view.tagItem({title:n.title}).data("key",e))},getTagData:function(n){var r=t.getTag(n);if(!r)return;return r.data||(r.data=e('<input class="tagdata" type="hidden" name="tags[]" value="'+r.title+'" />'))},search:function(n){var n=e.trim(n).toLowerCase(),r=[];for(key in t.tags){if(key.indexOf(n)<0)continue;r.push(key)}return r},selectTag:function(e){clearTimeout(t.selectTag.refreshTagSelection);var n=t.getTagItem(e);if(!n)return;var r=t.tagItems();if(t.options.tagLimit>0&&r.length>=t.options.tagLimit)return;n.css({opacity:0});if(r.length<1)t.tagList().prepend(n);else{var i=r.filter(":last");i[0]!=n[0]&&n.insertAfter(i)}n.animate({opacity:1});var s=t.getTagData(e);s.appendTo(t.element),t.selected[e]=!0,t.checkTagLimit(),t.selectTag.refreshTagSelection=setTimeout(function(){t.showTagSelections()},500)},unselectTag:function(e){var n=t.getTagItem(e);if(!n)return;n.detach();var r=t.getTagData(e);r.detach(),delete t.selected[e],t.checkTagLimit();var i=t.getTag(e);i.alias!==undefined&&t.showTagSelections()},addToTagSelectionList:function(e){var n=t.getTagItem(e);return n&&n.appendTo(t.tagSelectionList())},showTagSelections:function(e){t.tagSelectionItems().detach(),e=t.currentFilter=e===undefined?t.currentFilter||"":e;var n=0,r=t.options.tagSelectionLimit;if(e==="")for(u in t.tags){if(n>=r)break;if(t.selected[u]||t.getTag(u).alias===undefined)continue;t.addToTagSelectionList(u),n++}else{var i=t.search(e),s,o=i.length;for(s=0;s<o;s++){if(n>=r)break;var u=i[s];if(t.selected[u]||t.getTag(u).alias===undefined)continue;t.addToTagSelectionList(u),n++}}t.tagSelection().toggleClass("no-selection",n<1)},"{tagInput} keydown":function(e,n){n.stopPropagation(),t.realEnterKey=n.keyCode==13},"{tagInput} keypress":function(e,n){n.stopPropagation(),t.realEnterKey=t.realEnterKey&&n.keyCode==13},"{tagInput} keyup":function(e,n){clearTimeout(t.filterTask),n.stopPropagation();switch(n.keyCode){case 27:e.val("");break;case 13:t.realEnterKey&&e.hasClass("canCreate")&&t.createTagFromInput()}t.filterTask=setTimeout(function(){t.showTagSelections(e.val())},250)},createTagFromInput:function(){var n=e.trim(t.tagInput().val());if(n!==""){var r=t.getKey(n),i=t.createTag(n);t.selectTag(r),t.tagInput().val("")}t.showTagSelections("")},checkTagLimit:function(){var e=t.options.tagLimit;if(e<1)return;var n=t.tagItems().length;t.totalTags().text(n),t.tagCreationForm()[n<e?"show":"hide"]()},"{tagCreateButton} click":function(){t.createTagFromInput()},"{tagSelectionItems} click":function(e){var n=e.data("key");t.selectTag(n)},"{tagItemRemoveButton} click":function(e){var n=e.parents(".tag-item").data("key");t.unselectTag(n)},"{showAllTagsButton} click":function(e){e.hasClass("active")?(e.removeClass("active"),t.options.tagSelectionLimit=t.originalLimit):(e.addClass("active"),t.originalLimit=t.options.tagSelectionLimit,t.options.tagSelectionLimit=9999),t.showTagSelections("")}}}),t.resolve()})});