EasyBlog.module("media/browser.item",function(e){var t=this;EasyBlog.Controller("Media.Browser.Item",{defaultOptions:{"{itemTitle}":".itemTitle","{itemIcon}":".itemIcon","{childItem}":".browserItem",hasCustomHandler:["folder"]}},function(t){var n,r,i;return{init:function(){n=t.media,r=n.library,i=n.browser,t.element.data("item",t).addClass("item-type-"+t.meta().type),t.meta().data.on("removed",function(){i.removeItem(t)}),t.createHandler()},meta:function(){return r.getMeta(t.key)},place:function(){return r.getPlace(t.key)},parentFolder:function(){return i.getItem(r.getParentKey(t.key))},createHandler:function(){if(e.inArray(t.meta().type,t.options.hasCustomHandler)<0)return;var n=EasyBlog.Controller.Media.Browser.Item[e.String.capitalize(t.meta().type)];if(n===undefined){EasyBlog.require().script("media/browser.item."+t.meta().type).done(function(){t.createHandler()});return}t.handler=new n(t.element,{controller:{media:t.media,item:t}})},activate:function(){t.setLayout(),t.handler&&t.handler.activate()},remove:function(){try{t.handler&&(t.handler._destroyed||t.handler.destroy()),t.element&&t.element.remove()}catch(e){}},isVisible:function(){var e=t.element,n=e.outerHeight(),r=e.offset().top,i=r+n,s=t.media.browser.itemField(),o=s.offset().top,u=o+s.height();return isVisible=!(r<o&&i<o||r>u&&i>u),t.media.options.debug.itemVisiblity&&t.media.console("info",["Item visibility",{title:t.meta().title,isVisible:isVisible,item:t,itemHeight:n,itemTop:r,itemBottom:i,itemFieldTop:o,itemFieldBottom:u}]),isVisible},setLayout:function(n){if(t.meta().type=="folder")return;if(t.handler&&e.isFunction(t.handler.setLayout))return t.handler.setLayout();t.setIcon()},setIcon:function(){if(t.setIcon.loading||t.setIcon.loaded)return;if(t.meta().icon===undefined||t._destroyed)return;t.setIcon.loading=!0,i.iconThread.addDeferred(function(e){var n=t.itemIcon();if(!t.isVisible())t.setIcon.loading=!1,e.reject();else{var r=t.meta(),i=t.place(),s=r.icon.url;!t.setIcon.useNaturalUrl&&!/jomsocial|flickr/.test(i.id)&&r.type==="image"&&(s=EasyBlog.baseUrl+"&view=media&layout=getIconImage"+"&place="+encodeURIComponent(i.id)+"&path="+encodeURIComponent(t.meta().path)+"&format=image&tmpl=component"),t.element.addClass("loading-icon"),n.image("get",s).done(function(){t.element.removeClass("loading-icon"),t.setIcon.loaded=!0,t.setIcon.loading=!1,e.resolve()}).fail(function(){t.element.removeClass("loading-icon"),t.setIcon.loaded=!1,t.setIcon.loading=!1,e.reject(),t.setIcon.triedNaturalUrl||(t.setIcon.useNaturalUrl=!0,t.setIcon.triedNaturalUrl=!0)})}})}}}),EasyBlog.Controller("Media.Browser.Item.Folder",{defaultOptions:{"{childItem}":".browserItem"}},function(t){var n,r,i;return{init:function(){n=t.media,r=n.library,i=n.browser,t.element.empty()},items:{},setLayout:function(){var e=t.item.place(),r;switch(e.ready.state()){case"pending":r="loading";break;case"rejected":r="error";break;case"resolved":if(t.folderView&&t.folderView.map.length>0)r="ready",i.browserPagination().show();else switch(e.populate.task.state()){case"pending":r="loading";break;case"rejected":r="error";break;case"resolved":t.folderView&&t.folderView.map.length<1?(r=e.acl.canUploadItem?"empty canUpload":"empty",t.item.meta().place==="jomsocial"&&t.item.meta().path===n.options.directorySeparator&&(r="selectAlbum")):r="ready",i.browserPagination().toggle(!/empty|selectAlbum/.test(r))}}i.currentFolderStatus(r),i.setItemLayout(),t.isChangingPage?t.isChangingPage=!1:t.populatePages()},populate:function(e){if(i.itemField().hasClass("searching"))return;var n,r=e.length,s=t.items;t.items={};if(r<1)try{t.childItem().detach()}catch(o){}else{for(n=0;n<r;n++){var u=e[n],a=i.createFile(u);a.element.appendTo(t.element),t.items[u]=a,delete s[u]}for(u in s)try{s[u].element.detach()}catch(o){}}t.item.place().itemGroup.hasClass("active")&&t.element.hasClass("focus")&&t.setLayout()},activate:function(){t.folderView||(t.folderView=t.item.meta().data.views.create({from:0,to:i.options.layout.maxIconPerPage}),t.folderView.updated(t.populate)),t.setLayout()},populatePages:function(){var e=t.totalPage();if(e<2)i.browserPagination().hide();else{i.browserPagination().show(),i.pageSelection().html("");for(var n=1;n<=e;n++)i.view.paginationPage({page:n}).appendTo(i.pageSelection());t.folderView.currentPage=t.folderView.currentPage||1,i.paginationPage().removeClass("selected"),i.paginationPage(".page"+t.folderView.currentPage).addClass("selected")}},totalPage:function(){var e=t.folderView.map.length,n=e%i.options.layout.maxIconPerPage,r=Math.floor(n>0?e/i.options.layout.maxIconPerPage+1:e/i.options.layout.maxIconPerPage);return i.totalPage().text()!=r&&i.totalPage().text(r),r},currentPage:function(n,r){var s=parseInt(t.folderView.currentPage);isNaN(s)&&(s=1,t.folderView.currentPage=1,i.paginationPage().removeClass("selected"),i.paginationPage(":first").addClass("selected")),n===undefined&&(n={from:t.folderView.from});if(e.isPlainObject(n)&&n.from!==undefined)var o=t.folderView.map.length,u=Math.floor(n.from/i.options.layout.maxIconPerPage)+1;n=u||n;if(n!=s){var a=(n-1)*i.options.layout.maxIconPerPage,f=a+i.options.layout.maxIconPerPage;a!=n.from&&t.folderView.select({from:a,to:f}),t.folderView.currentPage=n,i.paginationPage().removeClass("selected"),i.paginationPage(".page"+n).addClass("selected"),i.trigger("pageChanged",[s,n])}return r&&r(),n},next:function(){t.changePage("next")},prev:function(){t.changePage("prev")},changePage:function(e){t.isChangingPage=!0;var n=t.totalPage(),r=t.currentPage();e=="next"&&r<n&&(r+=1),e=="prev"&&r>1&&(r-=1),t.currentPage(r)},locateItem:function(e){var e=r.getMeta(e),n=t.getItemPage(e);n&&t.currentPage(n,function(){i.focusItem(e.key,!0)})},getItemPage:function(n){var n=r.getMeta(n),s=n.key,o=t.folderView.map.length,u;return e.each(t.folderView.map,function(e,t){if(t==s)return u=e,!1}),u!==undefined?Math.floor(u/i.options.layout.maxIconPerPage)+1:!1}}}),t.resolve()});