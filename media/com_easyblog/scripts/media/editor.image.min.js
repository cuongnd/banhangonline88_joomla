EasyBlog.module("media/editor.image",function(e){var t=this;EasyBlog.require().library("ui/position").script("media/constrain").view("media/editor.image","media/editor.image.variation","media/editor.image.caption").done(function(){EasyBlog.Controller("Media.Editor.Image",{defaultOptions:{view:{panel:"media/editor.image",variation:"media/editor.image.variation",caption:"media/editor.image.caption"},defaultVariation:"thumbnail","{editorPreview}":".editorPreview","{editorPanel}":".editorPanel","{imageVariationPanel}":".imageVariationPanel","{imageVariationList}":".imageVariationList","{imageVariations}":".imageVariations","{imageVariation}":".imageVariation","{imageEnforceDimensionOption}":".imageEnforceDimensionOption","{imageEnforceWidth}":".imageEnforceWidth","{imageEnforceHeight}":".imageEnforceHeight","{imageCaptionOption}":".imageCaptionOption","{imageCaption}":".imageCaption","{imageZoomOption}":".imageZoomOption","{imageZoomLargeImageSelection}":".imageZoomLargeImageSelection","{itemFilesize}":".itemFilesize","{itemFilename}":".itemFilename","{itemUrl}":".itemUrl","{itemCreationDate}":".itemCreationDate","{modalPrompt}":".modalPrompt"}},function(t){var n,r,i,s;return{init:function(){n=t.media,r=n.library,i=n.browser;var e=t.meta(),o=t.place(),u={controller:{editor:t,media:t.media}};t.editorPanel().html(t.view.panel({meta:e,acl:o.acl})).implement(EasyBlog.Controller.Media.Editor.Panel,{},function(){t.panel=this,e.place==="jomsocial"&&(t.itemFilesize().remove(),t.itemFilename().css("padding-right",0))}),t.modalPrompt().implement(EasyBlog.Controller.Media.Prompt,u,function(){s=t.promptDialog=this});var a=EasyBlog.Controller.Media.Editor.Image.Filter;t.element.implement(a.Dimension,u).implement(a.Caption,u).implement(a.Lightbox,u),t.editorPreview().implement(EasyBlog.Controller.Media.Editor.Preview,{draggable:!0},function(){t.preview=this,t.previewImage(t.meta().thumbnail.url)}),o.acl.canCreateVariation&&o.acl.canDeleteVariation&&t.element.implement(EasyBlog.Controller.Media.Editor.Image.VariationForm,u),t.populateImageVariations(),t.setLayout()},meta:function(){return r.getMeta(t.key)},place:function(){return r.getPlace(t.meta().place)},setLayout:function(){t.preview.resetLayout()},"{self} insertItem":function(){var e=t.currentImageVariation().data("variation"),r={variation:e.name};t.imageEnforceDimensionOption().is(":checked")&&(r.enforceDimension=!0,r.enforceWidth=t.imageEnforceWidth().val(),r.enforceHeight=t.imageEnforceHeight().val()),t.imageCaptionOption().is(":checked")&&(r.caption=t.imageCaption().val()),t.imageZoomOption().is(":checked")&&(r.zoom=t.imageZoomLargeImageSelection().val()),n.insert(t.meta(),r)},populateImageVariations:function(){var n=t.meta(),i=n.variations;t.imageVariationsData=t.imageVariationsData||{};if(i===undefined){t.imageVariations().empty().addClass("busy"),r.getMetaVariations(n.key).done(function(){t.populateImageVariations(),t.imageVariations().removeClass("busy")}).fail(function(){}).always(function(){t.imageVariations().removeClass("busy")});return}e.each(i,function(e,n){if(n.name=="icon")return;t.createImageVariation(n)}),t.trigger("variationPopulated",[t.imageVariationsData])},createImageVariation:function(e){var n=t.view.variation({variation:e});return n.data("variation",e).appendTo(t.imageVariations()),(e["default"]===!0||e["default"]=="true")&&n.addClass("default"),e.canDelete||n.addClass("locked"),t.imageVariationsData[e.name]=n,t.trigger("variationCreated",[n,e]),n},"{self} variationPopulated":function(){var n,r=t.imageVariation(".default");if(t.imageVariation().length>0){if(r.length<1){var i=t.meta(),s=t.previewImage();s!==undefined&&e.each(i.variations,function(e,t){if(t.width==s.width()&&t.height==s.height())return n=t.name,!1}),n=n||t.imageVariation(":first").data("variation").name}else n=r.eq(0).data("variation").name;t.currentImageVariation(n)}},"{imageVariation} click":function(e){var n=e.data("variation");t.currentImageVariation(n.name)},currentImageVariation:function(n){var r=t.currentImageVariation.imageVariation,i=t.imageVariationsData[n];if(i!==undefined){var s=i.data("variation"),o=t.meta();if(o.place=="jomsocial"){var u=t.previewImage();s.width=u.data("width"),s.height=u.data("height"),e('<span class="variationDimension"></span>').text(s.width+"x"+s.height).appendTo(i)}r&&r.removeClass("active"),i.addClass("active"),t.currentImageVariation.imageVariation=i,t.trigger("variationSelected",[i,s])}return t.currentImageVariation.imageVariation},"{self} variationSelected":function(e,n,r,i){t.itemFilesize().html(i.filesize),t.itemUrl().html(i.url),t.itemCreationDate().html(i.dateCreated),t.previewImage(i.url)},"{self} variationRemoved":function(e,n,r,i){delete t.imageVariationsData[i.name],r.remove()},previewImage:function(n){if(n===undefined)return t.previewImage.currentImage;t.previewImage.images===undefined&&(t.previewImage.images={});var r=t.previewImage.images[n],i=t.previewImage.currentUrl,s=t.previewImage.images[i];t.preview.showDialog("loading"),s!==undefined&&!e.isDeferred(s)&&(s.detach(),t.preview.container().empty()),t.previewImage.currentUrl=n;if(r===undefined){t.previewImage.images[n]=e.Image.get(n).done(function(e){t.previewImage.images[n]=e,t.previewImage.currentUrl==n&&t.previewImage(n)}).fail(function(){t.preview.hideDialog("loading"),t.previewImage.currentUrl==n});return}if(e.isDeferred(r))return;t.preview.container().append(r),t.previewImage.currentImage=r,t.trigger("previewImage",[t.preview.container(),r]),t.preview.hideDialog("loading"),t.preview.resetLayout()}}}),EasyBlog.Controller("Media.Editor.Image.VariationForm",{defaultOptions:{"{imageVariationForm}":".imageVariationForm","{addVariationButton}":".addVariationButton","{createVariationButton}":".createVariationButton","{removeVariationButton}":".removeVariationButton","{cancelVariationButton}":".cancelVariationButton","{tryCreateVariationButton}":".tryCreateVariationButton","{newVariationName}":".newVariationName","{newVariationWidth}":".newVariationWidth","{newVariationHeight}":".newVariationHeight","{newVariationRatio}":".newVariationRatio","{newVariationLockRatio}":".newVariationLockRatio","{imageVariationMessage}":".imageVariationMessage",variationNameFilter:RegExp("[^a-zA-Z0-9]","g"),"{createNewImageVariationPrompt}":".createNewImageVariationPrompt","{promptVariationName}":".createNewImageVariationPrompt .variationName","{promptVariationWidth}":".createNewImageVariationPrompt .variationWidth","{promptVariationHeight}":".createNewImageVariationPrompt .variationHeight"}},function(t){return{init:function(){},"{self} variationSelected":function(){var e=t.editor.currentImageVariation().data("variation");t.removeVariationButton().toggle(e.canDelete)},nextVariationName:function(n){var r=!1,n=e.trim(n.toLowerCase());return e.each(t.editor.imageVariationsData,function(t,i){if(n==i.data("variation").name.toLowerCase()){r=!0;var s=n.substr(-1,1);return n=e.isNumeric(s)?n.substr(0,n.length-1)+(parseInt(s,10)+1):n+1,!1}}),r?t.nextVariationName(n):n},"{addVariationButton} click":function(){t.editor.promptDialog.get("createNewImageVariationPrompt").state("default").show();var n=t.editor.currentImageVariation().data("variation");variationName=e.String.capitalize(t.nextVariationName(n.name)),t.newVariationName().data("default",variationName).val(variationName).select(),t.newVariationWidth().data("default",n.width).val(n.width),t.newVariationHeight().data("default",n.height).val(n.height),t.imageVariationForm().constrain({selector:{width:t.options["{newVariationWidth}"],height:t.options["{newVariationHeight}"],constrain:t.options["{newVariationLockRatio}"]},source:{width:n.width,height:n.height},allowedMax:{width:t.editor.media.options.exporter.image.maxVariationWidth,height:t.editor.media.options.exporter.image.maxVariationHeight}})},"{newVariationRatio} click":function(e){e.toggleClass("locked"),e.hasClass("locked")?t.newVariationLockRatio().attr("checked","checked"):t.newVariationLockRatio().removeAttr("checked"),t.newVariationLockRatio().trigger("change")},"{createVariationButton} click":function(){t.createVariation()},"{tryCreateVariationButton} click":function(){t.createVariation()},"{newVariationName} keyup":function(n,r){var i=e.trim(e(n).val());i=i.replace(RegExp("[^0-9a-zA-Z]","g"),""),e(n).val(i),r.keyCode==13&&t.createVariationButton().trigger("click")},"[{newVariationWidth}, {newVariationHeight}] keyup":function(e,n){n.keyCode==13&&t.createVariationButton().trigger("click")},createVariation:function(){var n=t.editor.meta(),r=t.editor.place(),i=t.newVariationName().val(),s=t.newVariationWidth().val(),o=t.newVariationHeight().val();if(!e.trim(i)||!e.trim(s)||!e.trim(o))return!1;t.promptVariationName().text(i),t.promptVariationWidth().text(s),t.promptVariationHeight().text(o),t.editor.promptDialog.get("createNewImageVariationPrompt").state("progress").show(),EasyBlog.ajax("site.views.media.createVariation",{path:n.path,place:r.id,name:i,width:s,height:o},{success:function(e){t.media.library.meta[n.key].variations.push(e),t.editor.createImageVariation(e),t.editor.currentImageVariation(e.name),t.cancelVariationButton().click()},fail:function(e){t.editor.promptDialog.get("createNewImageVariationPrompt").state("fail").show()}})},"{removeVariationButton} click":function(){var e=t.editor.imageVariation(".active"),n=e.data("variation"),r=t.editor.meta(),i=t.editor.place();n.canDelete&&EasyBlog.ajax("site.views.media.deleteVariation",{fromPath:r.path,place:i.id,name:n.name},{beforeSend:function(){e.addClass("busy")},success:function(){e.slideUp(function(){t.trigger("variationRemoved",[e,n])}),t.editor.imageVariation(".default").click(),t.media.library.removeMetaVariation(r,n.name)},fail:function(e){try{console.log(e)}catch(t){}},complete:function(){e.removeClass("busy")}})}}}),EasyBlog.Controller("Media.Editor.Image.Filter.Caption",{defaultOptions:{view:{caption:"media/editor.image.caption"},"{imageVariation}":".imageVariation","{imageCaptionOption}":".imageCaptionOption","{imageCaption}":".imageCaption"}},function(t){return{init:function(){t.item={meta:t.editor.meta()}},"{imageVariation} click":function(e){t.transform()},"{self} dimensionEnforced":function(){t.transform()},"{imageCaptionOption} change":function(e,n){n.stopPropagation(),e.parent(".field").toggleClass("hide-field-content",!e.is(":checked")),t.transform()},"{imageCaptionOption} mouseup":function(){setTimeout(function(){t.imageCaption().focus()[0].select()},1)},"{imageCaption} blur":function(n){e.trim(n.val())==""&&n.val(t.item.meta.title),t.transform()},"{imageCaption} keyup":function(e,n){t.transform()},transform:function(){var e=t.editor.preview.container(),n=e.find("img"),r=e.find("div.imageCaptionText");if(t.imageCaptionOption().is(":checked")){var i=t.imageCaption().val();r.remove(),e.width(n.width()),e.addClass("imageCaptionBorder"),e.width(e.width()),e.append(t.view.caption({caption:i}))}else e.removeClass("imageCaptionBorder"),r.remove(),e.width("auto");t.editor.preview.resetLayout()}}}),EasyBlog.Controller("Media.Editor.Image.Filter.Lightbox",{defaultOptions:{defaultImageZoomVariation:"original","{imageZoomOption}":".imageZoomOption","{imageZoomLargeImageSelection}":".imageZoomLargeImageSelection","{imageZoomLargeImageOption}":".imageZoomLargeImageSelection option"}},function(t){return{init:function(){},"{self} variationCreated":function(n,r,i,s){var o=e.String.capitalize(s.name),u=e("<option>").val(o).html(o).data("variation",s),a=t.media.options.exporter.image.zoom||t.options.defaultImageZoomVariation;s.name==a&&u.attr("selected",!0),t.imageZoomLargeImageSelection().append(u)},"{self} variationRemoved":function(e,n,r,i){t.imageZoomLargeImageOption('[value="'+i.name+'"]').remove()},"{imageZoomOption} change":function(e,t){t.stopPropagation(),e.parent(".field").toggleClass("hide-field-content",!e.is(":checked"))},transform:function(){if(t.imageZoomOption().is(":checked")){var n=t.imageZoomLargeImageOption(":selected").data("variation");image=e("<a>").addClass("easyblog-thumb-preview").attr({href:n.url,title:imageCaption||t.item.meta.title}).html(image)}}}}),EasyBlog.Controller("Media.Editor.Image.Filter.Dimension",{defaultOptions:{"{imageEnforceDimension}":".imageEnforceDimension","{imageEnforceDimensionOption}":".imageEnforceDimensionOption","{imageEnforceWidth}":".imageEnforceWidth","{imageEnforceHeight}":".imageEnforceHeight","{imageEnforceRatio}":".imageEnforceRatio","{imageEnforceLockRatio}":".imageEnforceLockRatio","{imageVariation}":".imageVariation"}},function(t){return{init:function(){var e={selector:{width:t.options["{imageEnforceWidth}"],height:t.options["{imageEnforceHeight}"],constrain:t.options["{imageEnforceLockRatio}"]}};t.editor.bind("variationPopulated",function(){t.editor.media.options.exporter.image.enforceDimension&&t.imageEnforceDimensionOption().attr({checked:"checked",disabled:"disabled"}).parent(".field").removeClass("hide-field-content"),t.applyConstrain(e)})},"{imageVariation} click":function(e){t.applyConstrain()},"{imageEnforceDimensionOption} change":function(e,n){n.stopPropagation(),e.parent(".field").toggleClass("hide-field-content",!e.is(":checked")),t.transform()},"{imageEnforceRatio} click":function(e){e.toggleClass("locked"),e.hasClass("locked")?t.imageEnforceLockRatio().attr("checked","checked"):t.imageEnforceLockRatio().removeAttr("checked"),t.imageEnforceLockRatio().trigger("change"),e.hasClass("locked")&&t.transform()},"{self} previewImage":function(){t.transform()},"[{imageEnforceWidth}, {imageEnforceHeight}] keyup":function(){t.transform()},"[{imageEnforceWidth}, {imageEnforceHeight}] blur":function(n){e.trim(n.val())==""&&!t.imageEnforceLockRatio().is(":checked")&&n.val(n.data("initial")),t.transform()},transform:function(){var e=t.editor.previewImage();if(e===undefined)return;var n={};if(t.imageEnforceDimensionOption().is(":checked"))n={width:t.imageEnforceWidth().val(),height:t.imageEnforceHeight().val()};else{var r=t.editor.currentImageVariation();r=r===undefined?t.editor.meta():r.data("variation"),n={width:r.width,height:r.height}}if(e.width()!==n.width||e.height()!==n.height)e.css(n),t.editor.trigger("dimensionEnforced");t.editor.preview.resetLayout()},applyConstrain:function(n){var r=t.editor.currentImageVariation()===undefined?t.editor.meta():t.editor.currentImageVariation().data("variation"),i={source:{width:r.width,height:r.height}};t.editor.media.options.exporter.image.enforceDimension&&(i.allowedMax={width:t.editor.media.options.exporter.image.enforceWidth,height:t.editor.media.options.exporter.image.enforceHeight}),n=e.extend(!0,{},i,n),t.imageEnforceDimension().constrain(n),t.transform()}}}),t.resolve()})});