EasyBlog.module("media/browser",function(e){var t=this;EasyBlog.require().library("image","easing","scrollTo","throttle-debounce").script("media/browser.item").done(function(){var n,r,s,o,u,a;EasyBlog.Controller("Media.Browser",{defaultOptions:{view:{browser:"media/browser",itemGroup:"media/browser.item-group",item:"media/browser.item",treeItemGroup:"media/browser.tree-item-group",treeItem:"media/browser.tree-item",paginationPage:"media/browser.pagination-page"},path:"",items:undefined,mode:"browse",layout:{viewMode:"tile",tileSize:.125,scrollToItemDuration:500,scrollToItemEasing:"swing",iconMaxLoadThread:8},search:{chunkSize:128,chunkDelay:500},"{modalHeader}":".modalHeader","{modalToolbar}":".modalToolbar","{modalContent}":".modalContent","{modalFooter}":".modalFooter","{modalPrompt}":".modalPrompt","{modalUploaderButton}":".uploaderButton","{header}":".browserHeader","{content}":".browserContent","{footer}":".browserFooter","{treeToggleButton}":".browserTreeToggleButton","{tileViewButton}":".browserTileViewButton","{listViewButton}":".browserListViewButton","{itemField}":".browserItemField","{itemGroup}":".browserItemGroup","{item}":".browserItem","{treeItemField}":".browserTreeItemField","{treeItemGroup}":".browserTreeItemGroup","{treeItem}":".browserTreeItem","{headerTitle}":".browserTitle","{headerSearch}":".browserSearch","{headerNavigation}":".browserNavigation","{headerUpload}":".browserUploadButton","{footerStatus}":".browserStatus","{footerMessage}":".browserMessage","{itemActionSet}":".browserItemActionSet","{itemFieldHints}":".browserItemField .hints","{browserPagination}":".browserPagination","{currentPage}":".currentPage","{totalPage}":".totalPage","{prevPageButton}":".prevPageButton","{nextPageButton}":".nextPageButton","{pageSelection}":".pageSelection","{paginationPage}":".paginationPage","{searchInput}":".searchInput"}},function(t){return{init:function(){n=t.media,r=n.library,s=n.browser=t,a=n.options.directorySeparator,t.iconThread=e.Threads({threadLimit:t.options.layout.iconMaxLoadThread}),t.enqueue=e.Enqueue(),t.element.addClass("browser").html(t.view.browser()),t.headerNavigation().implement(EasyBlog.Controller.Media.Navigation,{controller:t.controllerProps()},function(){t.navigation=this}),t.modalPrompt().implement(EasyBlog.Controller.Media.Prompt,{controller:t.controllerProps()},function(){u=t.promptDialog=this}),t.element.implement(EasyBlog.Controller.Media.Browser.Actions,{controller:t.controllerProps()},function(){t.actions=this}),t.search=e.debounce(500,t._search),t.mode("browse"),n.element.bind("hideModal",function(){t.mode("browse")}),t.viewMode(t.options.layout.viewMode),t.setLayout(),t._bind(t.itemField(),"scroll",e.debounce(250,t["{itemField} scroll"])),e.each(r.places,function(e,n){t.createPlace(n)}),t.activatePlace(t.options.initialPlace||r.places[0].id).done(t.enqueue(function(e){t.activateItem(e.baseFolder())}))},controllerProps:function(t){return e.extend({media:n},t||{})},items:{},createPlace:function(e){var e=r.getPlace(e);return e.treeItemGroup=t.view.treeItemGroup().appendTo(t.treeItemField()),e.treeItem=t.view.treeItem({title:e.title}).addClass("type-place").data("place",e).appendTo(e.treeItemGroup),e.itemGroup=t.view.itemGroup().appendTo(t.itemField()),e},activatePlace:function(n){var n=r.getPlace(n);if(n===undefined)return;t.itemGroup().removeClass("active"),n.itemGroup.addClass("active"),t.treeItem().removeClass("active"),n.treeItem.addClass("active"),n.activator||(n.activator=e.Deferred());if(n.id==="flickr"&&!n.options.associated)return s.currentFolderStatus("flickr"),n.activator;if(!n.populated){n.populated=!0,t.currentFolderStatus("loading");var i=/jomsocial|flickr/.test(n.id)?n.populate():n.ready;i.done(function(){var e=t.createFolder(n.baseFolder());n.activator.resolveWith(n,[n,e])}).fail(function(){t.currentFolderStatus("error"),n.activator.rejectWith(n,arguments)})}return n.activator},getItem:function(e){if(e===undefined)return;if(e instanceof EasyBlog.Controller.Media.Browser.Item)return e;if(typeof e=="string")return t.items[e];if(r.isMeta(e))return t.items[r.getKey(e)]},createItem:function(e,i){var e=r.getMeta(e);if(!e)return;return t.items[e.key]=new EasyBlog.Controller.Media.Browser.Item(t.view.item({meta:e}),{controller:{key:e.key,media:n}})},createFolder:function(n,i){var n=r.getMeta(n);return t.getItem(n)||function(){var r=t.createItem(n),i=r.place(),s=r.parentFolder();return s?r.element.insertAfter(s.element):r.element.appendTo(i.itemGroup),r.treeItem=(s?t.view.treeItem({title:n.title}).addClass("type-folder").css("marginLeft",18*(n.path.split(a).length-1)).insertAfter(s.treeItem):i.treeItem).data("item",r),n.data.views.create({group:"folders"}).updated(function(n){e.each(n,function(e,n){t.createFolder(n)})}),r}()},createFile:function(e,n){var e=r.getMeta(e);return t.getItem(e)||t.createItem(e)},removeItem:function(e){clearTimeout(t.removeItem.revert);var e=t.getItem(e),n=e.parentFolder();e.remove(),e.treeItem&&e.treeItem.remove(),delete t.items[e.key];if(t.itemField().hasClass("searching"))return;t.removeItem.revert=setTimeout(function(){n&&t.activateItem(n)},500)},focusItem:function(e,n){var e=t.getItem(e);if(!e)return;n?t.activateItem(e):(t.currentItem(e),e.element.removeClass("active")),t.scrollTo(e),t.trigger("itemFocus",[e])},locateItem:function(e){t.itemField().hasClass("searching")&&t.clearSearch(!0);var e=r.getMeta(e);if(!e)return;t.activatePlace(e.place).done(t.enqueue(function(){var n=e.type==="folder",r=t.activateItem(n?e:e.parentKey);if(r===undefined)return;n||r.handler.locateItem(e);var i=r.handler.folderView;i&&i.refresh()}))},activateItem:function(e){var e=t.getItem(e);if(!e)return;return t.currentItem(e),e.activate(),t.trigger("itemActivate",[e]),e},scrollTo:function(e){var e=t.getItem(e);if(!e)return;t.itemField().scrollTo(e.element,{duration:t.options.layout.scrollToItemDuration,easing:t.options.layout.scrollToItemEasing,offset:{top:t.itemField().height()*-0.1}})},currentItem:function(e){var n=t.currentItem.item;n&&n._destroyed&&(n=t.currentItem.item=undefined);var e=t.getItem(e);if(!e)return n;if(e._destroyed)return n;n&&(n.element.removeClass("active focus"),n.meta().type!=="folder"&&n.parentFolder().element.removeClass("active focus"),n.place().itemGroup.removeClass("active")),e.element.addClass("active focus");var r=e.meta().type=="folder";return r||e.parentFolder().element.addClass("focus"),e.place().itemGroup.addClass("active"),t.currentFolder(r?e:e.parentFolder()),t.navigation.setPathway(e.key),t.currentItem.item=e},currentFolder:function(e){var n=t.currentFolder.folder;n&&n._destroyed&&(n=t.currentFolder.folder=undefined);var e=t.getItem(e);return e?(t.treeItem().removeClass("active"),e.treeItem.addClass("active"),e.meta().path!==a&&e.place().treeItemGroup.addClass("expanded"),e.handler.folderView&&e.handler.refreshSeed!==t.folderRefreshSeed&&(e.handler.folderView.refresh(),e.handler.refreshSeed=t.folderRefreshSeed),t.currentFolder.folder=e):n},currentFolderStatus:function(e){if(t.itemField().hasClass("searching")&&!/emptySearch|ready/.test(e))return;var n=t.currentFolderStatus.lastStatus;if(e===undefined)return n;if(typeof e!="string")return;return n&&t.itemField().removeClass(n),t.itemField().addClass(e),t.currentFolderStatus.lastStatus=e},setLayout:function(){if(!n.layout||n.currentModal!=="browser")return;var r;t.modalContent().hide().height(r=t.element.height()-t.modalHeader().outerHeight()-t.modalToolbar().outerHeight()-t.modalFooter().outerHeight()).show(),e.browser.msie&&(t.treeItemField().height(r),t.itemField().height(r),t.itemFieldHints().height(r)),t.setItemLayout(),t.trigger("setLayout")},setItemStyle:function(r){if(!r){var i=n.layout;if(t.setItemStyle.seed===i)return;t.setItemStyle.seed=i}var s=t.viewMode(),o={};if(s=="tile"){var u="#EasyBlogMediaManager .browser .browserItemField.view-tile .browserItem",a=function(){var n=e(document.createElement("DIV")).prependTo(t.itemField()),r=n.width();return n.remove(),r}(),f=Math.floor(a*t.options.layout.tileSize),l=f-24;o[u]={width:f+"px",height:l+"px"}}var c=document.getElementsByTagName("head")[0];if(t.itemStyle)try{c.removeChild(t.itemStyle)}catch(h){}t.itemStyle=document.createElement("style"),t.itemStyle.type="text/css";var p="";e.each(o,function(t,n){p+=t+"{"+e.map(n,function(e,t){return t+":"+e}).join(";")+"}\n"}),t.itemStyle.styleSheet?t.itemStyle.styleSheet.cssText=p:t.itemStyle.appendChild(document.createTextNode(p)),c.appendChild(t.itemStyle)},setItemLayout:function(){if(!n.layout||n.currentModal!=="browser")return;t.setItemStyle(),setTimeout(function(){var e=[];if(t.itemField().hasClass("searching"))t.searchItemGroup&&(e=t.searchItemGroup.find(".browserItem"));else{var n=t.currentFolder();if(n===undefined)return;e=n.childItem()}if(e.length<1)return;var r=t.itemField().offset(),i,s,o=e.length,u=1;if(e.length<1)return;while(Math.abs(o-u)>1){i=e.eq(u-1),s=i.offset();var a=s.top-r.top+i.outerHeight();a<0?u=Math.ceil((o+u)/2):(o=u,u=Math.ceil(o/2))}u===1&&(u=0);var f=u,l=u,c=0,h=e.length-1;setLayout=function(t){if(t<c||t>h)return!1;var n=e.eq(t).data("item");if(!n.isVisible())return!1;n.setLayout()};for(;;){if(setLayout(f)===!1)break;f--}for(;;){if(setLayout(l)===!1)break;l++}},0)},viewMode:function(e){var n=t.viewMode.mode;n||(n=t.viewMode.mode=t.options.layout.viewMode);if(e!==undefined){t.setItemStyle.seed=null,t.itemField().removeClass("view-"+n).addClass("view-"+e),t.viewMode.mode=n=e,t.setLayout();var r=t.currentItem();r!==undefined&&t.scrollTo(r)}return n},mode:function(n){if(n===undefined)return t.mode.currentMode||"browse";switch(n){case"browse":t.element.removeClass("mode-blogimage").addClass("mode-browse"),e.each(r.places,function(e,t){/jomsocial|flickr/.test(t.id)&&(t.treeItemGroup&&t.treeItemGroup.show(),t.itemGroup&&t.itemGroup.show())});break;case"blogimage":t.element.addClass("mode-blogimage").removeClass("mode-browse");var i=t.currentItem(),s=!1;i&&/jomsocial|flickr/.test(i.place().id)&&(s=!0),e.each(r.places,function(e,t){/jomsocial|flickr/.test(t.id)?(t.treeItemGroup&&t.treeItemGroup.hide(),t.itemGroup&&t.itemGroup.hide()):s&&(s=!1,t.treeItem&&t.treeItem.click())})}t.mode.currentMode=n},"{self} itemActivate":function(e,n,r){t.itemActionSet().removeClass("active"),r.meta().type=="folder"?t.itemActionSet(".type-folder").addClass("active"):t.itemActionSet(".type-item").addClass("active")},"{headerNavigation} activate":function(e,n,r){t.activateItem(r)},"{tileViewButton} click":function(e,n){e.addClass("active").siblings().removeClass("active"),t.viewMode("tile")},"{listViewButton} click":function(e,n){e.addClass("active").siblings().removeClass("active"),t.viewMode("list")},"{treeItem} click":function(n,r){t.clearSearch(!0);var i=n.data("item");if(n.hasClass("type-place")){var s=n.data("place");e(r.target).hasClass("treeItemToggle")&&s.treeItemGroup.toggleClass("expanded"),t.activatePlace(s).done(t.enqueue(function(e,n){e.id==="jomsocial"&&e.treeItemGroup.addClass("expanded"),t.activateItem(n)}));return}t.activateItem(i)},"{itemField} scroll":function(e,n){t.setItemLayout()},"{item} click":function(e,n){n.stopPropagation();var r=e.data("item");if(r===undefined)return;var i=r.place();t.activatePlace(i).done(t.enqueue(function(e,n){t.activateItem(r)}))},"{item} dblclick":function(e,i){i.stopPropagation();var s=e.data("item");if(i.shiftKey){n.console("log",[s]);return}if(s===undefined)return;if(s.meta().type=="folder")return;if(t.mode.currentMode==="blogimage"){if(s.meta().type=="image"){var o=r.meta[s.key];EasyBlog.dashboard.blogImage.setImage(o),n.hide()}}else n.edit(s.key)},"{modalUploaderButton} click":function(){var e=t.currentFolder();n.upload(e.place().acl.canUploadItem?e.key:"")},"{self} modalActivate":function(e,n,i,s){s!==undefined&&t.mode(s);var i=r.getMeta(i)||t.currentItem().meta();i&&t.locateItem(i)},"{prevPageButton} click":function(){var e=s.currentFolder();e.handler.changePage("prev")},"{nextPageButton} click":function(){var e=s.currentFolder();e.handler.changePage("next")},"{pageSelection} click":function(e){t.paginationPage().length>1&&e.toggleClass("expanded")},"{paginationPage} click":function(e){if(t.pageSelection().hasClass("expanded")&&!e.hasClass("selected")){var n=e.data("page"),r=s.currentFolder();r.handler.isChangingPage=!0,r.handler.currentPage(n)}},"{window} click":function(n,r){var i=e(r.target).attr("class");/pageSelection|paginationPage/.test(i)||t.pageSelection().hasClass("expanded")&&t.pageSelection().removeClass("expanded")},_search:function(e){t.itemBeforeSearch||(t.itemBeforeSearch=t.currentItem().meta()),t.element.addClass("searching"),t.itemField().addClass("searching"),t.searchItemGroup||(t.searchItemGroup=t.view.itemGroup().appendTo(t.itemField())),t.searchItemGroup.addClass("active search-mode");var n;t.searchView=r.search(e).create({from:0,to:300}).updated(function(e){var r=e.length;if(r<1){n=setTimeout(function(){s.currentFolderStatus("emptySearch")},500);return}clearTimeout(n),s.currentFolderStatus("ready");for(i=0;i<r;i++){var o=e[i],u=s.createFile(o);u.element.appendTo(t.searchItemGroup)}t.setItemLayout()})},clearSearch:function(n){t.folderRefreshSeed=e.uid(),n&&t.searchInput().val("").blur(),t.element.removeClass("searching"),t.itemField().removeClass("searching"),t.searchItems&&e.each(t.searchItems,function(t,n){e(n).detach()}),t.searchItemGroup&&(t.searchItemGroup.find(".browserItem").detach(),t.searchItemGroup.removeClass("active")),t.searchView&&t.searchView.destroy(),delete t.searchView,t.itemBeforeSearch&&t.locateItem(t.itemBeforeSearch)},"{searchInput} focusin":function(t){t.parent().addClass("active"),e.trim(t.val())!==""&&t.parent().addClass("showCancelButton")},"{searchInput} focusout":function(t){setTimeout(function(){e.trim(t.val())===""&&t.parent().removeClass("active showCancelButton")},50)},"{searchInput} keyup":function(n){var r=e.trim(n.val());if(r===""){n.parent().removeClass("showCancelButton"),t.clearSearch(),delete t.itemBeforeSearch;return}n.parent().addClass("showCancelButton"),t.search(r)}}}),EasyBlog.Controller("Media.Browser.Actions",{defaultOptions:{"{customizeItemButton}":".customizeItemButton","{insertAsGalleryButton}":".insertAsGalleryButton","{insertItemButton}":".insertItemButton","{insertBlogImageButton}":".insertBlogImageButton","{createFolderButton}":".createFolderButton","{confirmCreateFolderButton}":".createFolderPrompt .confirmCreateFolderButton","{folderPath}":".createFolderPrompt .folderPath","{folderCreationPath}":".createFolderPrompt .folderCreationPath","{folderInput}":".createFolderPrompt .folderInput","{folderCreationFailedReason}":".createFolderPrompt .folderCreationFailedReason","{removeItemButton}":".removeItemButton","{removeItemFilename}":".removeItemPrompt .removeItemFilename","{confirmRemoveItemButton}":".confirmRemoveItemButton","{removeItemFailedReason}":".removeItemPrompt .removeItemFailedReason","{flickrLoginButton}":".flickrLoginButton","{cancelSearchButton}":".cancelSearchButton","{retryPopulateButton}":".retryPopulateButton"}},function(t){return{init:function(){},"{self} itemActivate":function(e,n,r){t.item=r;var i=r.place().acl;t.removeItemButton().toggle(i.canRemoveItem),t.createFolderButton().toggle(i.canCreateFolder),t.insertBlogImageButton().toggle(s.mode()==="blogimage"&&r.meta().type==="image")},"{customizeItemButton} click":function(){n.edit(t.item.key)},"{insertAsGalleryButton} click":function(){n.insert(t.item.key)},"{insertItemButton} click":function(){n.insert(t.item.key)},"{insertBlogImageButton} click":function(){var e=r.meta[t.item.key];EasyBlog.dashboard.blogImage.setImage(e),n.hide()},"{createFolderButton} click":function(){u.get("createFolderPrompt").show().state("default");var e=s.currentFolder();t.folderPath().html(e.meta().friendlyPath),t.folderInput().focus()[0].select()},"{folderInput} keyup":function(e,n){n.keyCode==13&&t.confirmCreateFolderButton().click()},"{confirmCreateFolderButton} click":function(){var n=e.trim(t.folderInput().val());if(n==="")return;var i=s.currentFolder().meta(),o=i.friendlyPath+a+n;t.folderCreationPath().html(o);var f=u.get("createFolderPrompt");f.state("progress"),r.createFolder(i,n).done(function(e){var t=s.createFolder(e);f.hide(),s.activateItem(t)}).fail(function(e){t.folderCreationFailedReason().html(e),f.state("fail")})},"{removeItemButton} click":function(){t.removeItemFilename().html(t.item.meta().title),u.get("removeItemPrompt").show().state("default")},"{confirmRemoveItemButton} click":function(e){var n=u.get("removeItemPrompt");n.state("progress"),r.removeRemoteMeta(t.item.key).done(function(){n.hide()}).fail(function(e){t.removeItemFailedReason().html(e),n.state("fail")})},"{flickrLoginButton} click":function(e){var t=e.data("login"),n=e.data("callback"),i=s.enqueue(function(){s.activatePlace("flickr").done(s.enqueue(function(e,t){s.activateItem(t)}))});window[n]=function(){var e=r.getPlace("flickr");e.options.associated=!0,i()},window.open(t,"Flickr Login","scrollbars=no, resizable=no, width=650, height=700")},"{cancelSearchButton} click":function(){s.clearSearch(!0)},"{retryPopulateButton} click":function(){var e=t.item.place();delete e.activator,e.populated=!1,e.treeItem.click()}}}),t.resolve()})});