EasyBlog.module("media/uploader",function(e){var t=this;EasyBlog.require().library("plupload").done(function(){var n,r,i,s;EasyBlog.Controller("Media.Uploader",{defaultOptions:{view:{uploader:"media/browser.uploader",uploadItem:"media/browser.uploader.item"},"{modalHeader}":".modalHeader","{modalToolbar}":".modalToolbar","{modalContent}":".modalContent","{modalFooter}":".modalFooter","{modalPrompt}":".modalPrompt","{modalBrowserButton}":".modalButton.browserButton","{modalDashboardButton}":".modalButton.dashboardButton","{uploadButton}":".uploadButton","{uploadNavigation}":".uploadNavigation","{uploadForm}":".uploadForm","{uploadPath}":".uploadPath","{uploadSize}":".uploadSize","{uploadExtensionList}":".uploadExtensionList","{uploadItemGroup}":".uploadItemGroup","{uploadItem}":".uploadItem","{uploadDropHint}":".uploadDropHint","{uploadInstructions}":".uploadInstructions","{clearListButton}":".clearListButton"}},function(t){return{init:function(){n=t.media,r=n.library,i=n.uploader=t,s=n.options.directorySeparator,t.element.addClass("uploader").html(t.view.uploader({uploadSize:t.options.settings.max_file_size,uploadExtensionList:t.options.settings.filters[0].extensions.split(",").join(", ")})),t.uploadNavigation().implement(EasyBlog.Controller.Media.Navigation,{controller:t.controllerProps()},function(){t.navigation=this}),t.modalPrompt().implement(EasyBlog.Controller.Media.Prompt,{controller:t.controllerProps()},function(){t.promptDialog=this}),t.element.implement(EasyBlog.Controller.Media.Uploader.FolderSwitcher,{controller:t.controllerProps()},function(){t.folderSwitcher=this}),t.element.implement("plupload",{settings:t.options.settings,"{uploadButton}":t.options["{uploadButton}"],"{uploadDropsite}":t.options["{uploadItemGroup}"]},function(){t.plupload=this.plupload;if(t.plupload.runtime=="html4"||e.browser.msie){t.uploadDropHint().remove(),t.uploadItemGroup().addClass("indefinite-progress");var r=t.uploadInstructions().appendTo(n.element);t.element.find("> form").mouseover(function(){var i=t.uploadButton(),s=i.offset();r.addClass("show").css({top:s.top+i.outerHeight()-n.element.offset().top+3,right:e(window).width()-(s.left+i.outerWidth())-1})}).mouseout(function(){r.removeClass("show")})}else t.uploadButton().mouseover(function(){t.uploadInstructions().addClass("show")}).mouseout(function(){t.uploadInstructions().removeClass("show")})}),t.setLayout()},setLayout:function(){if(n.currentModal!=="uploader")return;var r;t.modalContent().hide().height(r=t.element.height()-t.modalHeader().outerHeight()-t.modalToolbar().outerHeight()-t.modalFooter().outerHeight()).show(),e.browser.msie&&(t.uploadDropHint().height(r),t.uploadItemGroup().height(r)),t.plupload&&t.plupload.refresh()},controllerProps:function(n){return e.extend({media:t.media,uploader:t},n||{})},setUploadFolder:function(e){if(!e)return;t.navigation.setPathway(e),t.currentUploadFolder=e},items:{},createItem:function(n){var r=new EasyBlog.Controller.Media.Uploader.Item(t.view.uploadItem(),{controller:t.controllerProps({id:n.id,originalFile:n,uploadFolder:t.currentUploadFolder})});r.element.appendTo(t.uploadItemGroup());var i=r.file().filesize,i=i?"":" ("+i+").";return r.setMessage(e.language("COM_EASYBLOG_MM_UPLOADING_PENDING")+i),t.items[n.id]=r,r},"{self} BeforeUpload":function(n,i,s,o){var u=t.items[o.id];if(u===undefined)return;u.setMessage(e.language("COM_EASYBLOG_MM_UPLOAD_PREPARING"));var a=t.options.settings.url,f=r.getMeta(u.uploadFolder),l=f?f.place:u.uploadFolder.split("|")[0],c=encodeURIComponent(f?f.path:u.uploadFolder.split("|")[1]);s.settings.url=a+"&place="+l+"&path="+c},"{self} FilesAdded":function(n,r,i,s){try{e.each(s,function(e,n){if(t.items[n.id]!==undefined)return;t.createItem(n)}),t.uploadItem().length>0&&t.uploadItemGroup().removeClass("empty"),t.plupload.start()}catch(o){console.error(o)}},"{self} UploadFile":function(n,r,i,s){var o=t.items[s.id];if(o===undefined)return;o.setState("uploading"),o.setMessage(e.language("COM_EASYBLOG_MM_UPLOADING_STATE"))},"{self} UploadProgress":function(n,r,i,s){var o=t.items[s.id];if(o===undefined)return;o.setProgress(s.percent),o.setMessage(e.language("COM_EASYBLOG_MM_UPLOADING")+(s.percent!==undefined?" "+s.percent+"%":"")+(s.loaded!==undefined&&!s.size!==undefined?s.size-s.loaded?" ("+e.plupload.formatSize(s.size-s.loaded)+" "+e.language("COM_EASYBLOG_MM_UPLOADING_LEFT")+")":"":""))},"{self} FileUploaded":function(r,i,s,o,u){var a=t.items[o.id];if(a===undefined)return;a.response=u;if(!e.isPlainObject(u)){a.setState("failed"),a.setMessage(e.language("COM_EASYBLOG_MM_SERVER_RETURNED_INVALID_RESPONSE"));return}if(!e.isPlainObject(u.item)){a.setState("failed"),a.setMessage(u.message||e.language("COM_EASYBLOG_MM_UPLOAD_UNABLE_PARSE_RESPONSE"));return}a.setState("done"),a.setMessage(e.language("COM_EASYBLOG_MM_UPLOAD_COMPLETE")),a.meta=u.item,a.meta.place=n.library.get(a.uploadFolder).place,a.meta.type!=="image"&&a.insertBlogImageButton().remove(),n.library.addMeta(a.meta)},"{self} FileError":function(e,n,r,i,s){var o=t.items[i.id];o===undefined&&(o=t.createItem(i)),o.response=s,o.setState("failed"),o.setMessage(s.message),t.uploadItem().length>0&&t.uploadItemGroup().removeClass("empty")},"{self} Error":function(e,n,r,i){if(i.file){var s=i.file,o=t.items[s.id];o===undefined&&(o=t.createItem(s)),o.setState("failed"),o.setMessage(i.message)}t.uploadItem().length>0&&t.uploadItemGroup().removeClass("empty")},"{modalBrowserButton} click":function(){n.browse()},"{modalDashboardButton} click":function(){n.hide()},"{uploadNavigation} activate":function(e,n,r){t.setUploadFolder(r)},"{self} modalActivate":function(e,r,i){t.setUploadFolder(i),n.browser&&t.uploadItemGroup().toggleClass("blogimage",n.browser.mode()=="blogimage")},removeItem:function(e){var n=t.items[e];n!==undefined&&(t.plupload.removeFile(n.file()),n.element.remove(),delete t.items[e]),t.uploadItem().length<1&&t.uploadItemGroup().addClass("empty")},"{clearListButton} click":function(){for(id in t.items)t.removeItem(id)}}}),EasyBlog.Controller("Media.Uploader.Item",{defaultOptions:{"{filename}":".uploadFilename","{progressBar}":".uploadProgressBar progress","{percentage}":".uploadPercentage","{status}":".uploadStatus","{removeButton}":".uploadRemoveButton","{insertItemButton}":".insertItemButton","{locateItemButton}":".locateItemButton","{insertBlogImageButton}":".insertBlogImageButton"}},function(t){return{init:function(){var e=t.file();t.filename().html(e.name),t.setState("queued")},file:function(){var n=i.plupload.getFile(t.id)||t.originalFile;return n&&(n.filesize=n.size===undefined||n.size=="N/A"?"":e.plupload.formatSize(t.file.size)),n},dblclick:function(e,r){r.shiftKey&&n.console("log",t)},setProgress:function(e){t.progressBar().attr("value",e),t.percentage().html(e)},setState:function(e){t.element.removeClass("upload-state-"+t.state).addClass("upload-state-"+e),t.state=e},setMessage:function(e){t.status().html(e)},"{removeButton} click":function(e,n){n.stopPropagation(),i.removeItem(t.id)},"{insertItemButton} click":function(){n.insert(t.meta)},"{locateItemButton} click":function(){n.browse(t.meta)},"{insertBlogImageButton} click":function(){var e=r.meta[r.getMeta(t.meta).key];EasyBlog.dashboard.blogImage.setImage(e),n.hide()}}}),EasyBlog.Controller("Media.Uploader.FolderSwitcher",{defaultOptions:{view:{treeItemGroup:"media/browser.tree-item-group",treeItem:"media/browser.tree-item"},"{changeUploadFolderButton}":".changeUploadFolderButton","{selectFolderButton}":".selectFolderButton","{treeItemField}":".browserTreeItemField","{treeItemGroup}":".browserTreeItemGroup","{treeItem}":".browserTreeItem"}},function(t){return{init:function(){var r;t.promptDialog=i.promptDialog.get("changeUploadFolderPrompt"),e.each(n.library.places,function(e,n){if(!n.acl.canUploadItem)return;n.uploaderTreeItemGroup=t.view.treeItemGroup().addClass("expanded").appendTo(t.treeItemField()),n.uploaderTreeItem=t.view.treeItem({title:n.title}).addClass("loading").addClass("type-place").data("place",n).appendTo(n.uploaderTreeItemGroup),r||(r=n.id+"|"+s,i.setUploadFolder(r)),n.done(function(){t.createTreeItem(n.baseFolder()),n.uploaderTreeItem.removeClass("loading")})})},treeItems:{},createTreeItem:function(n){var n=r.getMeta(n),i=t.treeItems[n.key]||function(){var i=r.getPlace(n.place),s=r.getMeta(n.parentKey),o=t.treeItems[n.key]=(s?t.view.treeItem({title:n.title}).addClass("type-folder").insertAfter(t.treeItems[s.key]):i.uploaderTreeItem).data("key",n.key);return n.data.on("removed",function(){t.removeTreeItem(n)}),n.data.views.create({group:"folders"}).updated(function(n){e.each(n,function(e,n){t.createTreeItem(n)})}),o}();return i},removeTreeItem:function(e){var e=r.getMeta(e),n=t.treeItems[e.key];if(n){n.remove();var s=t.treeItems[e.parentKey];i.setUploadFolder(e.parentKey)}},"{treeItem} click":function(e){t.treeItem().removeClass("active"),e.addClass("active")},"{changeUploadFolderButton} click":function(){var e=t.currentUploadFolder,n=t.treeItems[e]||t.treeItem(":first");n.click(),t.promptDialog.show()},"{selectFolderButton} click":function(){var e=t.treeItem(".active").data("key");i.setUploadFolder(e),t.promptDialog.hide()}}}),t.resolve()})});