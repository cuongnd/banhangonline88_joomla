(function($){$.client_chatting=function(element,options){var defaults={name:"",user:{},list_messenger:[],listRoomExists:[],option_alert:{allow_dismiss:true,timer:300,z_index:99999},list_user_id_support:[],send_messenger_now:0,KEY_SOCKET_NAME:"socket_name",KEY_SOCKET_ID:"socket_id",templateItemName:{default:0,name:""}};var plugin=this;plugin.settings={};var $element=$(element),element=element;plugin.send_new_messenger=function(){var option_alert=plugin.settings.option_alert;var name=plugin.settings.name;
var list_messenger=plugin.settings.list_messenger;var socket=plugin.settings.socket;var $content=$element.find("input.content");var $your_name=$element.find("input.your-name");if($your_name.val().trim()==""){$.alert_notify(list_messenger["PLEASE_INPUT_YOUR_NAME_NOTIFICATION"],"error",option_alert);$your_name.focus();plugin.settings.send_messenger_now=1;return}var content=$content.val().trim();if(content==""){$.alert_notify(list_messenger["PLEASE_INPUT_TEXT_MESSENGER_NOTIFICATION"],"error",option_alert);
$content.focus();return}$content.val("");var data={"room":"MainRoom","username":name,"msg":content};socket.emit("newMessage",data)};plugin.updateNickname=function(data){plugin.settings.user=data;var $badges=$('<div id="#'+data.room+'"><div id="'+data.id+'"></div></div>');console.log(data)};plugin.create_random_key=function(length){if(typeof length==="undefined")length=6;var text="";var possible="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(var i=0;i<length;i++)text+=possible.charAt(Math.floor(Math.random()*
possible.length));return text};plugin.setup_template=function(){var $sub_wrapper_chat=$element.find(".sub-wrapper-chat");var sub_wrapper_chat=$sub_wrapper_chat.getOuterHTML();plugin.settings.sub_wrapper_chat=sub_wrapper_chat;$sub_wrapper_chat.remove();var $sub_wrapper_chat_video=$element.find(".sub-wrapper-chat-video");var sub_wrapper_chat_video=$sub_wrapper_chat_video.getOuterHTML();plugin.settings.sub_wrapper_chat_video=sub_wrapper_chat_video;$sub_wrapper_chat_video.remove();var room_template=$element.find(".room").getOuterHTML();
plugin.settings.room_template=room_template;var $user_online_template=$element.find(".list-user-online ul li");var user_online_template=$user_online_template.getOuterHTML();plugin.settings.user_online_template=user_online_template;$user_online_template.remove()};plugin.close_sub_wrapper_chat=function($self){var $sub_wrapper_chat=$self.closest(".sub-wrapper-chat");var room=$sub_wrapper_chat.attr("id");var listRoomExists=plugin.settings.listRoomExists;for(var i=0;i<listRoomExists.length;i++){var itemRoom=
listRoomExists[i];if(itemRoom.roomName==room){listRoomExists.splice(i,1);break}}plugin.settings.listRoomExists=listRoomExists;$sub_wrapper_chat.remove()};plugin.hide_sub_wrapper_chat=function($self){var $sub_wrapper_chat=$self.closest(".sub-wrapper-chat");$sub_wrapper_chat.toggleClass("pin-sub-chat")};plugin.setup_call_video=function($sub_wrapper_chat){$sub_wrapper_chat.find("a.call-video").click(function(){})};plugin.create_room=function(room,name,client_user_name,client_socket_id){var socket=plugin.settings.socket;
var $sub_wrapper_chat=$(".sub-wrapper-chat#"+room);if($sub_wrapper_chat.length>0){if($sub_wrapper_chat.hasClass("pin-sub-chat"))$sub_wrapper_chat.find("h3.title a.minus").trigger("click");return}console.log(socket.room);if(socket.room==room)return;var $parent_sub_wrapper_chat=$("body").find(".parent_sub_wrapper_chat");if($parent_sub_wrapper_chat.length==0){$parent_sub_wrapper_chat=$('<div class="parent_sub_wrapper_chat"></div>');$parent_sub_wrapper_chat.appendTo("body")}var current_total_wrapper_sub_chat=
$sub_wrapper_chat.length;var total_window_enable=$parent_sub_wrapper_chat.width()/260;console.log(total_window_enable);var $sub_wrapper_chat=$(plugin.settings.sub_wrapper_chat);$sub_wrapper_chat.attr("id",room);$sub_wrapper_chat.find(".name").html(name);$sub_wrapper_chat.find(".client_user_name").html(client_user_name);$sub_wrapper_chat.find("a.close").click(function(){plugin.close_sub_wrapper_chat($(this))});$sub_wrapper_chat.find("h3.title a.minus").click(function(e){var $title=$(this).closest("h3.title");
plugin.hide_sub_wrapper_chat($title)});var $room_template=$(plugin.settings.room_template);$room_template.appendTo($sub_wrapper_chat.find(".sub-wrapper-chat-content"));$sub_wrapper_chat.appendTo($parent_sub_wrapper_chat);console.log("now create room"+room);$room_template.attr("id","room_messages_"+room);$room_template.data("room",room);$room_template.data("client_socket_id",client_socket_id);var $your_name=$room_template.find("input.your-name");var you_name=$element.find("input.your-name").val();
$your_name.val(you_name);$your_name.change(function(e){var name=$your_name.val().trim();if(name==""){$your_name.val(plugin.settings.name);return}$(".parent_sub_wrapper_chat .sub-wrapper-chat").find("input.your-name").val(name);$element.find("input.your-name").val(name);plugin.settings.name=name;var user=plugin.settings.user;if(typeof user.key!="undefined")user.key=plugin.create_random_key(10);plugin.settings.user=user;var new_nick_name={"username":name,"key":user.key};console.log("my user change is");
var data={name:name};var templateItemName=plugin.settings.templateItemName;templateItemName.name=name;templateItemName.default=0;$.cookie(plugin.settings.KEY_SOCKET_NAME,JSON.stringify(templateItemName));socket.emit("setNickname",data);plugin.setup_call_video($sub_wrapper_chat)});$room_template.find(".content").change(function(){plugin.send_sub_messenger($room_template)});$room_template.find(".btn-send").click(function(){plugin.send_sub_messenger($room_template)})};plugin.show_list_user_online=function(){$element.find(".list-user-online").toggleClass("show")};
plugin.makeRoomName=function(my_socket_id,client_socket_id){var listRoomExists=plugin.settings.listRoomExists;var itemRoom={};var roomName=my_socket_id+"_"+client_socket_id;itemRoom.roomName=roomName;itemRoom.listSocketId=[];itemRoom.listSocketId.push(my_socket_id);itemRoom.listSocketId.push(client_socket_id);listRoomExists.push(itemRoom);return roomName};plugin.getRoomName=function(my_socket_id,client_socket_id){var listRoomExists=plugin.settings.listRoomExists;for(var i=0;i<listRoomExists.length;i++){var itemRoom=
listRoomExists[i];if($.inArray(parseInt(my_socket_id),itemRoom.listSocketId)!=-1&&$.inArray(parseInt(client_socket_id),itemRoom.listSocketId)!=-1)return itemRoom.roomName}return null};plugin.make_room_video_name=function(my_socket_id,client_socket_id){return"room-video-"+my_socket_id+"_"+client_socket_id};plugin.update_list_user_online=function(data){var socket=plugin.settings.socket;var my_socket_id=socket.id;var $ul_list_user_online=$element.find(".list-user-online ul");$ul_list_user_online.empty();
for(var socket_id in data)if(my_socket_id!=socket_id){var user=data[socket_id];var $user_online_template=$(plugin.settings.user_online_template);$user_online_template.data("user",{socket_id:socket_id,username:user.username});$user_online_template.find(".name").html(user.name);$user_online_template.appendTo($ul_list_user_online)}$ul_list_user_online.find(".user").click(function(){var socket=plugin.settings.socket;var my_socket_id=socket.id;var user=$(this).data("user");var client_socket_id=user.socket_id;
var room_name=plugin.makeRoomName(my_socket_id,client_socket_id);var client_user_name=user.username;var name=plugin.settings.name;socket.emit("subscribe",{"rooms":[room_name],"client_socket_id":client_socket_id,"client_user_name":client_user_name});socket.emit("getUsersInRoom",{"room":client_user_name})});console.log("list-user-online: %s",JSON.stringify(data))};plugin.update_list_user_online_for_support=function(data){var socket=plugin.settings.socket;var list_user_id_support=plugin.settings.list_user_id_support;
var my_socket_id=socket.id;var $ul_list_user_support_online=$element.find(".list-group-support .list-user-support-online ul");$ul_list_user_support_online.empty();for(var socket_id in data){var user=data[socket_id];if(my_socket_id!=socket_id&&$.inArray(parseInt(user.system_user_id),list_user_id_support)!=-1){var $user_online_template=$(plugin.settings.user_online_template);$user_online_template.data("user",{socket_id:socket_id,username:user.username,name:user.name});$user_online_template.find(".name").html(user.name);
console.log($ul_list_user_support_online);$user_online_template.appendTo($ul_list_user_support_online)}}$ul_list_user_support_online.find(".user").click(function(){var socket=plugin.settings.socket;var my_socket_id=socket.id;var user=$(this).data("user");var client_socket_id=user.socket_id;var room_name=plugin.makeRoomName(my_socket_id,client_socket_id);var client_user_name=user.username;var name=plugin.settings.name;socket.emit("subscribe",{"rooms":[room_name],"client_socket_id":client_socket_id,
"client_user_name":client_user_name});socket.emit("getUsersInRoom",{"room":client_user_name})});console.log("list-user-online: %s",JSON.stringify(data))};plugin.create_random_interger=function(length){if(typeof length==="undefined")length=6;var text="";var possible="123456789";for(var i=0;i<length;i++)text+=possible.charAt(Math.floor(Math.random()*possible.length));return text};plugin.init=function(){plugin.settings=$.extend({},defaults,options);plugin.setup_template();var list_messenger=plugin.settings.list_messenger;
$element.find(".title-chatting").click(function(){$(this).toggleClass("show hide");$element.find(".wrapper-chat-js").toggleClass("hide show");$("#select_device_select_device").toggleClass("show hide");$("#alo_phone_alo_phone").toggleClass("show hide")});$element.find(".vtv-title-chatting").click(function(){$element.find(".title-chatting").toggleClass("show hide");$element.find(".wrapper-chat-js").toggleClass("hide show");$("#select_device_select_device").toggleClass("show hide");$("#alo_phone_alo_phone").toggleClass("show hide")});
$element.find("a.users").click(function(){$(this).find("i").toggleClass("fa-users fa-times");plugin.show_list_user_online()});var itemName=$.cookie(plugin.settings.KEY_SOCKET_NAME);if(typeof itemName=="undefined"){name=list_messenger["NEW_CUSTOMER"]+" "+plugin.create_random_interger(3);plugin.settings.name=name;$element.find(".your-name").attr("placeholder",name);var templateItemName=plugin.settings.templateItemName;templateItemName.name=name;templateItemName.default=1;$.cookie(plugin.settings.KEY_SOCKET_NAME,
JSON.stringify(templateItemName))}else{var objectItemName=JSON.parse(itemName);var name=objectItemName.name;var defaultName=objectItemName.default;plugin.settings.name=name;if(defaultName==1)$element.find(".your-name").attr("placeholder",name);else $element.find(".your-name").val(name)}$element.find(".your-name").attr("placeholder",name);var user=plugin.settings.user;var system_user_id=user.id;var old_socket_id=$.cookie(plugin.settings.KEY_SOCKET_ID);if(old_socket_id=="undefined")old_socket_id=0;
var title=$(document).find("title").html();var query=["name="+name,"username="+user.username,"system_user_id="+system_user_id,"title="+title,"os=browser","old_socket_id="+old_socket_id];query=query.join("&");console.log(query);var socket=io.connect("http://"+window.location.hostname+":8888",{query:query});plugin.settings.socket=socket;var $content=$element.find("input.content");$content.keyup(function(e){if(e.keyCode==13)plugin.send_new_messenger()});var $your_name=$element.find("input.your-name");
$your_name.change(function(e){var name=$your_name.val().trim();if(name==""){$your_name.val(plugin.settings.name);return}$(".parent_sub_wrapper_chat .sub-wrapper-chat").find("input.your-name").val(name);plugin.settings.name=name;var user=plugin.settings.user;if(typeof user.key!="undefined")user.key=plugin.create_random_key(10);plugin.settings.user=user;var new_nick_name={"username":name,"key":user.key};console.log("my user change is");var data={name:name};var templateItemName=plugin.settings.templateItemName;
templateItemName.name=name;templateItemName.default=0;$.cookie(plugin.settings.KEY_SOCKET_NAME,JSON.stringify(templateItemName));socket.emit("setNickname",data)});$your_name.keyup(function(e){if(e.keyCode==13){var send_messenger_now=plugin.settings.send_messenger_now;if(send_messenger_now==1){plugin.settings.send_messenger_now=0;plugin.send_new_messenger()}$content.focus()}});$element.find("button.btn-send").click(function(){plugin.send_new_messenger()});socket.emit("getRooms",{});socket.on("newMessage",
function(data){console.log("newMessage: %s",JSON.stringify(data));plugin.addMessage(data);var room_messages="#room_messages_"+data.room;$(room_messages).animate({scrollTop:$(room_messages).prop("scrollHeight")},300)});socket.on("userNicknameUpdated",function(data){console.log("my socket_id : %s",socket.id);console.log("userNicknameUpdated: %s",JSON.stringify(data));msg="----- "+data.oldUsername+" is now "+data.newUsername+" -----";var info={"room":data.room,"username":"ServerBot","msg":msg}});socket.on("usersInRoom",
function(data){console.log("usersInRoom: %s",JSON.stringify(data));_.each(data.users,function(user){plugin.addUser(user)})});socket.on("update-list-user-online",function(data){plugin.update_list_user_online(data);plugin.update_list_user_online_for_support(data)});socket.on("subscriptionConfirmed",function(data){var room=data.room;var client_socket_id=data.client_socket_id;var socket=plugin.settings.socket;var client_user_name=data.client_user_name;var name=data.name;var username=data.username;if(room!=
"MainRoom"&&socket.id!=room)plugin.create_room(room,name,client_user_name,client_socket_id)});socket.on("userJoinsRoom",function(data){console.log("userJoinsRoom: %s",JSON.stringify(data));plugin.addMessage(data);plugin.addUser(data)});socket.on("sendDocumentPage",function(data){console.log("sendDocumentPage: %s",JSON.stringify(data));plugin.addMessage(data)});socket.on("getListMessenger",function(data){var listMessenger=data.listMessenger;for(var i=0;i<listMessenger.length;i++)plugin.addMessage(listMessenger[i])});
socket.on("disconnect",function(data){var name=$.cookie(plugin.settings.KEY_SOCKET_NAME);var info={"room":"MainRoom",username:data.username,"name":name,"msg":"----- Lost connection to server -----"};plugin.addMessage(info)});socket.on("connected",function(data){});socket.emit("getSocketId",{});socket.on("returnSocketId",function(data){$.cookie(plugin.settings.KEY_SOCKET_ID,data.socketId)});socket.emit("getMyRoom",{});socket.on("responseRoom",function(data){var listMyRoom=data.listMyRoom});$element.find(".title-chatting .text").simplemarquee({speed:30,
direction:"left",cycles:100,space:40,delayBetweenCycles:2E3,handleHover:true,handleResize:true,easing:"linear"})};plugin.create_private_room=function(room_info){var socket=plugin.settings.socket;var my_socket_id=socket.id;var client_socket_id=room_info.socket_id;var client_user_name=room_info.username;var client_name=room_info.name;var current_room=plugin.getRoomName(my_socket_id,client_socket_id);if(current_room==null)current_room=plugin.makeRoomName(my_socket_id,client_socket_id);socket.emit("subscribe",
{"rooms":[current_room],"client_socket_id":client_socket_id,"client_name":client_name,"client_user_name":client_user_name});socket.emit("getUsersInRoom",{"room":client_user_name})};plugin.create_private_room_video=function(room_info){var socket=plugin.settings.socket;var my_socket_id=socket.id;var client_socket_id=room_info.socket_id;var client_user_name=room_info.username;var client_name=room_info.name;var current_room=plugin.make_room_video_name(my_socket_id,client_socket_id);socket.emit("subscribe",
{"rooms":[current_room],"client_socket_id":client_socket_id,"client_name":client_name,"client_user_name":client_user_name});socket.emit("getUsersInRoom",{"room":client_user_name})};plugin.send_sub_messenger=function($room){var room_name=$room.data("room");var client_socket_id=$room.data("client_socket_id");var option_alert=plugin.settings.option_alert;var socket=plugin.settings.socket;var list_messenger=plugin.settings.list_messenger;var $content=$room.find(".content");var content=$content.val().trim();
if(content==""){$.alert_notify(list_messenger["PLEASE_INPUT_TEXT_MESSENGER_NOTIFICATION"],"error",option_alert);$content.focus();return}var $your_name=$room.find("input.your-name");if($your_name.val().trim()==""){$.alert_notify(list_messenger["PLEASE_INPUT_YOUR_NAME_NOTIFICATION"],"error",option_alert);$your_name.focus();return}$content.val("");var data={"room":room_name,"client_socket_id":client_socket_id,"username":name,"msg":content};socket.emit("newMessage",data)};plugin.addSocketToRoom=function(room,
mySocketId,socketId){var listRoomExists=plugin.settings.listRoomExists;var itemRoom={};itemRoom.roomName=room;itemRoom.listSocketId=[];itemRoom.listSocketId.push(mySocketId);itemRoom.listSocketId.push(socketId);listRoomExists.push(itemRoom);plugin.settings.listRoomExists=listRoomExists};plugin.addMessage=function(msg_item){var room=msg_item.room;var list_messenger=plugin.settings.list_messenger;var socket=plugin.settings.socket;if(msg_item.room=="MainRoom")$sub_wrapper_chat=$("#room_messages_MainRoom");
else var $sub_wrapper_chat=$(".sub-wrapper-chat#"+msg_item.room);if($sub_wrapper_chat.length>0){var $msg=$('<div class="messenger-item"><b>'+(socket.id==msg_item.socket_id?list_messenger["ME"]:msg_item.name)+"</b>:"+msg_item.msg+(socket.id!=msg_item.socket_id?'<a title="'+list_messenger["CREATE_ROOM_PRIVATE_CHATTING_WITH_THIS_USER"]+'" href="javascript:void(0)"  class="create-room-private-chatting-with-this-user"><i class="icon ti-comment-alt"></i></a>':"")+"</div>");$msg.find("a.create-room-private-chatting-with-this-user").data("msg-info",
msg_item);$msg.find("a.create-room-private-chatting-with-this-user").click(function(){var msg_info=$(this).data("msg-info");console.log(msg_info);var room_infor=msg_info;plugin.create_private_room(room_infor)});var $messengers=$sub_wrapper_chat.find(".messengers");$msg.appendTo($messengers);$messengers.scrollTo(".messenger-item:last-child",80)}else if(socket.id!=msg_item.room){plugin.addSocketToRoom(msg_item.room,socket.id,msg_item.socketId);var client_socket_id=msg_item.client_socket_id;var client_user_name=
msg_item.client_user_name;var name=plugin.settings.name;plugin.create_room(room,name,client_user_name,client_socket_id)}};plugin.addUser=function(user){console.log("function add user online")};plugin.example_function=function(){};plugin.init()};$.fn.client_chatting=function(options){return this.each(function(){if(undefined==$(this).data("client_chatting")){var plugin=new $.client_chatting(this,options);$(this).data("client_chatting",plugin)}})}})(jQuery);
