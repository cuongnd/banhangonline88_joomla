(function(){var debug=false;var socket=io.connect(window.location.host);socket.on("connected",function(data){console.log(data);socket.emit("getUsersInRoom",{"room":"MainRoom"});if(debug){socket.emit("subscribe",{"username":"sergio","rooms":["sampleroom"]});socket.emit("newMessage",{"room":"sampleroom","msg":"Hellooooooo!"});setInterval(function(){socket.emit("unsubscribe",{"rooms":["sampleroom"]});socket.disconnect()},6E5)}});socket.on("disconnect",function(data){var info={"room":"MainRoom","username":"ServerBot",
"msg":"----- Lost connection to server -----"};addMessage(info)});socket.on("reconnect",function(data){var info={"room":"MainRoom","username":"ServerBot","msg":"----- Reconnected to server -----"};addMessage(info)});socket.on("subscriptionConfirmed",function(data){if(!roomExists(data.room)){addRoomTab(data.room);addRoom(data.room)}$("#modal_joinroom").modal("hide")});socket.on("unsubscriptionConfirmed",function(data){if(roomExists(data.room)){removeRoomTab(data.room);removeRoom(data.room)}});socket.on("userJoinsRoom",
function(data){console.log("userJoinsRoom: %s",JSON.stringify(data));addMessage(data);addUser(data)});socket.on("userLeavesRoom",function(data){console.log("userLeavesRoom: %s",JSON.stringify(data));addMessage(data);removeUser(data)});socket.on("newMessage",function(data){console.log("newMessage: %s",JSON.stringify(data));addMessage(data);var room_messages="#room_messages_"+data.room;$(room_messages).animate({scrollTop:$(room_messages).prop("scrollHeight")},300)});socket.on("usersInRoom",function(data){console.log("usersInRoom: %s",
JSON.stringify(data));_.each(data.users,function(user){addUser(user)})});socket.on("userNicknameUpdated",function(data){console.log("userNicknameUpdated: %s",JSON.stringify(data));updateNickname(data);msg="----- "+data.oldUsername+" is now "+data.newUsername+" -----";var info={"room":data.room,"username":"ServerBot","msg":msg};addMessage(info)});var templates={};var getTemplate=function(path,callback){var source;var template;if(_.has(templates,path)){if(callback)callback(templates[path])}else $.ajax({url:path,
success:function(data){source=data;template=Handlebars.compile(source);templates[path]=template;if(callback)callback(template)}})};var addRoomTab=function(room){getTemplate("js/templates/room_tab.handlebars",function(template){$("#rooms_tabs").append(template({"room":room}))})};var removeRoomTab=function(room){var tab_id="#"+room+"_tab";$(tab_id).remove()};var addRoom=function(room){getTemplate("js/templates/room.handlebars",function(template){$("#rooms").append(template({"room":room}));var newroomtab=
'[href="#'+room+'"]';$(newroomtab).click();socket.emit("getUsersInRoom",{"room":room})})};var removeRoom=function(room){var room_id="#"+room;$(room_id).remove()};var addMessage=function(msg){getTemplate("js/templates/message.handlebars",function(template){var room_messages="#room_messages_"+msg.room;if($(room_messages).length>0)$(room_messages).append(template(msg));else var roomInterval=setInterval(function(){if($(room_messages).length>0){$(room_messages).append(template(msg));clearInterval(roomInterval)}},
100)})};var addUser=function(user){getTemplate("js/templates/user.handlebars",function(template){var room_users="#room_users_"+user.room;var user_badge="#"+user.room+" #"+user.id;if(!$(user_badge).length)$(room_users).append(template(user))})};var removeUser=function(user){var user_badge="#"+user.room+" #"+user.id;$(user_badge).remove()};var roomExists=function(room){var room_selector="#"+room;if($(room_selector).length)return true;else return false};var getCurrentRoom=function(){return $('li[id$="_tab"][class="active"]').text()};
var getMessageText=function(){var text=$("#message_text").val();$("#message_text").val("");return text};var getRoomName=function(){var name=$("#room_name").val().trim();$("#room_name").val("");return name};var getNickname=function(){var nickname=$("#nickname").val();$("#nickname").val("");return nickname};var updateNickname=function(data){var badges="#"+data.room+" #"+data.id;$(badges).text(data.newUsername)};$("#b_send_message").click(function(eventObject){eventObject.preventDefault();if($("#message_text").val()!=
"")socket.emit("newMessage",{"room":getCurrentRoom(),"msg":getMessageText()})});$("#b_join_room").click(function(eventObject){var roomName=getRoomName();if(roomName){eventObject.preventDefault();socket.emit("subscribe",{"rooms":[roomName]})}else $("#room_name").addClass("error")});$("#b_leave_room").click(function(eventObject){eventObject.preventDefault();var currentRoom=getCurrentRoom();if(currentRoom!="MainRoom"){socket.emit("unsubscribe",{"rooms":[getCurrentRoom()]});$('[href="#MainRoom"]').click()}else console.log("Cannot leave MainRoom, sorry")});
$("#modal_joinroom").on("hidden.bs.modal",function(e){if($("#room_name").hasClass("error"))$("#room_name").removeClass("error")});$("#b_set_nickname").click(function(eventObject){eventObject.preventDefault();socket.emit("setNickname",{"username":getNickname()});$("#modal_setnick").modal("hide")})})();
